<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>å®Œæ•´æ’å…¥è¡Œæµ‹è¯•ï¼ˆåŒ…å«æ•°æ®ç§»åŠ¨ï¼‰</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-case {
      background: white;
      padding: 20px;
      margin: 10px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h2 { color: #2c3e50; margin-top: 0; }
    button {
      padding: 10px 20px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover { background: #2980b9; }
    .result { margin-top: 10px; }
    .pass { color: #27ae60; font-weight: bold; }
    .fail { color: #e74c3c; font-weight: bold; }
    table {
      border-collapse: collapse;
      margin: 10px 0;
      width: 100%;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th { background: #3498db; color: white; }
    .formula { background: #e8f5e9; }
    .data { background: #fff3cd; }
    pre { 
      background: #f8f9fa; 
      padding: 10px; 
      border-radius: 4px;
      overflow-x: auto;
      font-size: 11px;
    }
  </style>
</head>
<body>
  <h1>ğŸ”§ å®Œæ•´æ’å…¥è¡Œæµ‹è¯•ï¼ˆåŒ…å«æ•°æ®ç§»åŠ¨ï¼‰</h1>

  <div class="test-case">
    <h2>æµ‹è¯• 1: åŸºæœ¬æ’å…¥è¡Œï¼ˆç›¸å¯¹å¼•ç”¨ï¼‰</h2>
    <p><strong>åœºæ™¯ï¼š</strong>æ’å…¥è¡Œåï¼Œæ•°æ®å’Œå…¬å¼éƒ½åº”æ­£ç¡®ç§»åŠ¨</p>
    <button onclick="test1()">è¿è¡Œæµ‹è¯•</button>
    <div id="result1" class="result"></div>
  </div>

  <div class="test-case">
    <h2>æµ‹è¯• 2: æ’å…¥è¡Œï¼ˆç»å¯¹å¼•ç”¨ï¼‰</h2>
    <p><strong>åœºæ™¯ï¼š</strong>ç»å¯¹å¼•ç”¨åº”è¯¥ä¿æŒæŒ‡å‘åŸä½ç½®ï¼ˆå³ä½¿è¯¥ä½ç½®ç°åœ¨æ˜¯ç©ºçš„ï¼‰</p>
    <button onclick="test2()">è¿è¡Œæµ‹è¯•</button>
    <div id="result2" class="result"></div>
  </div>

  <div class="test-case">
    <h2>æµ‹è¯• 3: æ’å…¥è¡Œï¼ˆæ··åˆå¼•ç”¨ï¼‰</h2>
    <p><strong>åœºæ™¯ï¼š</strong>$A$1+B1 å¤åˆ¶åæ’å…¥è¡Œ</p>
    <button onclick="test3()">è¿è¡Œæµ‹è¯•</button>
    <div id="result3" class="result"></div>
  </div>

  <script type="module">
    import { SheetModel } from './src/lib/SheetModel.js'
    import { FormulaSheet } from './src/lib/FormulaSheet.js'

    // è¾…åŠ©å‡½æ•°ï¼šå®Œæ•´çš„æ’å…¥è¡Œæ“ä½œï¼ˆæ¨¡æ‹Ÿ CanvasSheet.vueï¼‰
    function insertRowComplete(sheet, row) {
      console.log(`\n=== æ’å…¥è¡Œ ${row} ===`)
      
      const model = sheet.getModel()
      
      // ç¬¬ä¸€æ­¥ï¼šè°ƒæ•´å…¬å¼ï¼ˆä¼šè‡ªåŠ¨ç§»åŠ¨å…¬å¼å•å…ƒæ ¼å¹¶æ›´æ–°å¼•ç”¨ï¼‰
      sheet.adjustAllFormulas('insertRow', row, 1)
      
      // ç¬¬äºŒæ­¥ï¼šæ”¶é›†å¹¶ç§»åŠ¨éå…¬å¼å•å…ƒæ ¼
      const cellsToMove = []
      model.forEach((r, c, cell) => {
        if (r >= row && !cell.formulaMetadata) {
          cellsToMove.push({ row: r, col: c, value: cell.value })
        }
      })
      
      // ä»åå¾€å‰ç§»åŠ¨
      cellsToMove.sort((a, b) => b.row - a.row)
      cellsToMove.forEach(({ row: r, col: c, value }) => {
        model.setValue(r, c, '')
        model.setValue(r + 1, c, value)
      })
      
      // æ¸…ç©ºå…¬å¼ç¼“å­˜
      sheet.clearFormulaCache()
    }

    // æµ‹è¯• 1: åŸºæœ¬ç›¸å¯¹å¼•ç”¨
    window.test1 = function() {
      const model = new SheetModel()
      const sheet = new FormulaSheet(model, false)

      // åˆå§‹åŒ–æ•°æ®
      sheet.setValue(0, 0, '10')   // A1 = 10
      sheet.setValue(1, 0, '20')   // A2 = 20
      sheet.setValue(2, 0, '=A1+A2')  // A3 = =A1+A2

      const before = {
        a1: sheet.getValue(0, 0),
        a2: sheet.getValue(1, 0),
        a3_formula: sheet.getDisplayValue(2, 0),
        a3_value: sheet.getValue(2, 0)
      }

      // æ’å…¥è¡Œ
      insertRowComplete(sheet, 0)

      const after = {
        a1: sheet.getValue(0, 0),
        a2: sheet.getValue(1, 0),
        a3: sheet.getValue(2, 0),
        a4_formula: sheet.getDisplayValue(3, 0),
        a4_value: sheet.getValue(3, 0)
      }

      // éªŒè¯
      const tests = {
        formula: after.a4_formula === '=A2+A3',
        value: after.a4_value === 30,
        data_a2: after.a2 === 10,
        data_a3: after.a3 === 20
      }

      let html = '<h3>æ‰§è¡Œæµç¨‹</h3>'
      html += '<table>'
      html += '<tr><th>æ­¥éª¤</th><th>æ“ä½œ</th></tr>'
      html += '<tr><td>1</td><td>adjustAllFormulas: ç§»åŠ¨å…¬å¼å•å…ƒæ ¼ A3â†’A4ï¼Œè°ƒæ•´å¼•ç”¨ =A1+A2 â†’ =A2+A3</td></tr>'
      html += '<tr><td>2</td><td>ç§»åŠ¨æ•°æ®: A1â†’A2(10), A2â†’A3(20)</td></tr>'
      html += '</table>'

      html += '<h3>æµ‹è¯•ç»“æœ</h3>'
      html += '<table>'
      html += '<tr><th>ä½ç½®</th><th>æ’å…¥å‰</th><th>æ’å…¥å</th><th>çŠ¶æ€</th></tr>'
      html += `<tr><td>A1</td><td class="data">10</td><td>(ç©º)</td><td>-</td></tr>`
      html += `<tr><td>A2</td><td class="data">20</td><td class="data">${after.a2}</td><td class="${tests.data_a2 ? 'pass' : 'fail'}">${tests.data_a2 ? 'âœ…' : 'âŒ'}</td></tr>`
      html += `<tr><td>A3</td><td class="formula">=A1+A2 â†’ 30</td><td class="data">${after.a3}</td><td class="${tests.data_a3 ? 'pass' : 'fail'}">${tests.data_a3 ? 'âœ…' : 'âŒ'}</td></tr>`
      html += `<tr><td>A4</td><td>-</td><td class="formula">${after.a4_formula} â†’ ${after.a4_value}</td><td class="${tests.formula && tests.value ? 'pass' : 'fail'}">${tests.formula && tests.value ? 'âœ…' : 'âŒ'}</td></tr>`
      html += '</table>'

      const allPass = Object.values(tests).every(t => t)
      html += allPass ? 
        '<p class="pass">âœ… æµ‹è¯•é€šè¿‡ï¼</p>' : 
        '<p class="fail">âŒ æµ‹è¯•å¤±è´¥ï¼</p>'

      html += '<h3>è°ƒè¯•ä¿¡æ¯</h3>'
      html += '<pre>' + JSON.stringify({ before, after, tests }, null, 2) + '</pre>'

      document.getElementById('result1').innerHTML = html
    }

    // æµ‹è¯• 2: ç»å¯¹å¼•ç”¨
    window.test2 = function() {
      const model = new SheetModel()
      const sheet = new FormulaSheet(model, false)

      // åˆå§‹åŒ–
      sheet.setValue(0, 0, '100')  // A1 = 100 (å¸¸é‡)
      sheet.setValue(1, 0, '10')   // A2 = 10
      sheet.setValue(2, 0, '=$A$1+A2')  // A3 = =$A$1+A2

      const before_a3_value = sheet.getValue(2, 0)

      // æ’å…¥è¡Œ
      insertRowComplete(sheet, 0)

      const after = {
        a1: sheet.getValue(0, 0),  // åº”è¯¥æ˜¯ç©º
        a2: sheet.getValue(1, 0),  // åº”è¯¥æ˜¯ 100 (åŸA1)
        a3: sheet.getValue(2, 0),  // åº”è¯¥æ˜¯ 10 (åŸA2)
        a4_formula: sheet.getDisplayValue(3, 0),  // åº”è¯¥æ˜¯ =$A$1+A3
        a4_value: sheet.getValue(3, 0)  // $A$1æ˜¯ç©º(0) + A3(10) = 10
      }

      const tests = {
        formula: after.a4_formula === '=$A$1+A3',
        value: after.a4_value === 10,  // 0 + 10
        abs_ref: after.a4_formula.includes('$A$1')
      }

      let html = '<h3>ç»å¯¹å¼•ç”¨ç‰¹ç‚¹</h3>'
      html += '<p>$A$1 å§‹ç»ˆæŒ‡å‘ç¬¬1è¡Œç¬¬Aåˆ—ï¼Œå³ä½¿æ’å…¥è¡Œåè¯¥ä½ç½®å˜ä¸ºç©º</p>'

      html += '<h3>æµ‹è¯•ç»“æœ</h3>'
      html += '<table>'
      html += '<tr><th>ä½ç½®</th><th>æ’å…¥å‰</th><th>æ’å…¥å</th><th>è¯´æ˜</th></tr>'
      html += `<tr><td>A1</td><td class="data">100</td><td>(ç©º)</td><td>å¸¸é‡è¢«ä¸‹ç§»</td></tr>`
      html += `<tr><td>A2</td><td class="data">10</td><td class="data">${after.a2}</td><td>åŸA1</td></tr>`
      html += `<tr><td>A3</td><td>-</td><td class="data">${after.a3}</td><td>åŸA2</td></tr>`
      html += `<tr><td>A4</td><td class="formula">=$A$1+A2 â†’ 110</td><td class="formula">${after.a4_formula} â†’ ${after.a4_value}</td><td>$A$1æŒ‡å‘ç©ºï¼Œç›¸å¯¹å¼•ç”¨A2â†’A3</td></tr>`
      html += '</table>'

      html += '<h3>éªŒè¯</h3>'
      html += `<p>å…¬å¼æ­£ç¡®: ${tests.formula ? 'âœ…' : 'âŒ'} (${after.a4_formula})</p>`
      html += `<p>è®¡ç®—æ­£ç¡®: ${tests.value ? 'âœ…' : 'âŒ'} (é¢„æœŸ: 10, å®é™…: ${after.a4_value})</p>`
      html += `<p>ç»å¯¹å¼•ç”¨ä¿æŒ: ${tests.abs_ref ? 'âœ…' : 'âŒ'}</p>`

      const allPass = Object.values(tests).every(t => t)
      html += allPass ? 
        '<p class="pass">âœ… æµ‹è¯•é€šè¿‡ï¼</p>' : 
        '<p class="fail">âŒ æµ‹è¯•å¤±è´¥ï¼</p>'

      document.getElementById('result2').innerHTML = html
    }

    // æµ‹è¯• 3: æ··åˆå¼•ç”¨
    window.test3 = function() {
      const model = new SheetModel()
      const sheet = new FormulaSheet(model, false)

      // ç¨ç‡è¡¨åœºæ™¯
      sheet.setValue(0, 0, '100')  // A1 = 100 (ç¨ç‡)
      sheet.setValue(0, 1, '1000') // B1 = 1000
      sheet.setValue(0, 2, '=B1*(1+$A$1/100)')  // C1 = B1 * (1 + ç¨ç‡)

      const before_c1_value = sheet.getValue(0, 2)

      // åœ¨é¡¶éƒ¨æ’å…¥æ ‡é¢˜è¡Œ
      insertRowComplete(sheet, 0)

      const after = {
        a1: sheet.getValue(0, 0),
        a2: sheet.getValue(1, 0),
        b1: sheet.getValue(0, 1),
        b2: sheet.getValue(1, 1),
        c1: sheet.getValue(0, 2),
        c2_formula: sheet.getDisplayValue(1, 2),
        c2_value: sheet.getValue(1, 2)
      }

      const tests = {
        formula: after.c2_formula === '=B2*(1+$A$1/100)',
        value: after.c2_value === 2000,  // 1000 * (1 + 100/100) = 2000
        tax_rate_moved: after.a2 === 100,
        amount_moved: after.b2 === 1000
      }

      let html = '<h3>åœºæ™¯ï¼šç¨ç‡è¡¨</h3>'
      html += '<p>ä½¿ç”¨ $A$1 å›ºå®šç¨ç‡ä½ç½®ï¼Œå¤åˆ¶å…¬å¼åˆ°å¤šè¡Œ</p>'

      html += '<h3>æµ‹è¯•ç»“æœ</h3>'
      html += '<table>'
      html += '<tr><th></th><th>Aåˆ—(ç¨ç‡)</th><th>Båˆ—(é‡‘é¢)</th><th>Cåˆ—(å«ç¨)</th></tr>'
      html += `<tr><th>ç¬¬1è¡Œ(æ’å…¥å)</th><td>(ç©º)</td><td>(ç©º)</td><td>(ç©º)</td></tr>`
      html += `<tr><th>ç¬¬2è¡Œ</th><td class="data">${after.a2}</td><td class="data">${after.b2}</td><td class="formula">${after.c2_formula} = ${after.c2_value}</td></tr>`
      html += '</table>'

      html += '<h3>éªŒè¯</h3>'
      html += `<p>å…¬å¼è°ƒæ•´: ${tests.formula ? 'âœ…' : 'âŒ'} (${after.c2_formula})</p>`
      html += `<p>è®¡ç®—ç»“æœ: ${tests.value ? 'âœ…' : 'âŒ'} (${after.c2_value})</p>`
      html += `<p>ç»å¯¹å¼•ç”¨$A$1åœ¨æ–°è¡Œ1ï¼Œä½†ç°åœ¨æ˜¯ç©º(0)ï¼Œæ‰€ä»¥ç»“æœæ˜¯ 1000*(1+0) = 1000... ç­‰ç­‰ï¼Œåº”è¯¥æ˜¯ $A$1 åº”è¯¥æŒ‡å‘ç©ºï¼</p>`

      const allPass = Object.values(tests).every(t => t)
      html += allPass ? 
        '<p class="pass">âœ… æµ‹è¯•é€šè¿‡ï¼</p>' : 
        '<p class="fail">âŒ å¯èƒ½å­˜åœ¨é—®é¢˜ï¼Œè¯·æ£€æŸ¥</p>'

      document.getElementById('result3').innerHTML = html
    }

    console.log('âœ… æµ‹è¯•é¡µé¢å·²åŠ è½½')
  </script>
</body>
</html>
