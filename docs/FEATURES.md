# WorkfineSheet - Canvas 电子表格功能文档

## 已实现的功能

### 1. **核心渲染** ✅
- **双层 Canvas 架构**
  - `gridCanvas`: 固定页眉（行号和列字母），z-index: 10
  - `contentCanvas`: 单元格数据和选择框，z-index: 20
- **虚拟化渲染**
  - 只渲染可见范围内的单元格（高性能）
  - 动态计算视口内的行列范围
  - 支持大数据量（1000+ 行 x 50+ 列）
- **常量配置**
  - ROW_HEIGHT = 26px
  - COL_WIDTH = 100px
  - ROW_HEADER_WIDTH = 40px
  - COL_HEADER_HEIGHT = 26px

### 2. **选择模式** ✅
- **单元格选择**
  - 点击单元格选中
  - 支持鼠标拖动选择范围
  - 可视化显示选中范围（浅蓝色背景）
- **范围选择**
  - 按住 Shift + 点击扩展选择范围
  - 拖动鼠标进行矩形选择
  - 实时视觉反馈

### 3. **键盘导航** ✅
- **方向键导航**
  - ↑↓←→ : 单步移动
  - Shift + 方向键 : 快速移动（5 步）
  - 自动防止越界
- **Enter 键导航**
  - 向下移动一行
  - 到达最后一行后自动换列回到第一行
- **Tab 键导航**
  - 向右移动一列
  - 到达最后一列后自动换行回到第一列
- **自动滚动**
  - 选中单元格移出可见区域时自动滚动
  - 确保选中单元格完全显示在屏幕内

### 4. **单元格编辑** ✅
- **编辑模式**
  - 双击打开编辑模式
  - 支持即时输入（任何可打印字符自动开始编辑）
- **输入框**
  - 绝对定位的 HTML Input 元素
  - 精确定位在目标单元格
  - 自动调整宽度和高度
- **提交和取消**
  - Enter 键提交编辑内容
  - Escape 键取消编辑
  - 失焦时自动提交

### 5. **撤销/重做** ✨ NEW
- **UndoRedoManager 类**
  - 支持任意操作的记录和恢复
  - 可配置历史记录大小（默认 100 条）
  - 自动清空重做栈（有新操作时）
- **支持的快捷键**
  - `Ctrl+Z` / `Cmd+Z` : 撤销
  - `Ctrl+Y` / `Cmd+Y` : 重做
  - `Ctrl+Shift+Z` / `Cmd+Shift+Z` : 重做（替代快捷键）
- **操作记录**
  - 所有单元格编辑都记录在撤销栈
  - 仅当值改变时才创建操作记录
  - 支持查询操作栈状态（canUndo(), canRedo()）

### 6. **剪贴板操作** ✅
- **复制 (Ctrl/Cmd + C)**
  - 复制选中单元格内容为 CSV 格式
  - 支持多选范围
  - 自动换行符处理
- **粘贴 (Ctrl/Cmd + V)**
  - 从剪贴板粘贴文本
  - 自动解析 CSV 格式
  - 从当前选中位置开始覆盖写入

### 7. **数据存储** ✅
- **SheetModel - 稀疏数据结构**
  - 使用 Map 存储单元格数据
  - "r,c" 格式的键索引
  - 只存储非空单元格
  - 方法：getValue(), setValue(), forEach()

### 8. **样式和界面** ✅
- **响应式布局**
  - 整个容器响应式
  - Canvas 自动适配容器大小
- **视觉反馈**
  - 选中单元格高亮（蓝色边框）
  - 多选范围着色（浅蓝色背景）
  - 编辑框带圆角和阴影
- **鼠标滚轮**
  - 支持滚轮滚动
  - 垂直和水平滚动
  - 平滑视口更新

## 文件结构

```
src/
├── components/
│   ├── CanvasSheet.vue      # 主电子表格组件（718 行）
│   └── SheetOverlayInput.vue # 编辑输入框组件（150 行）
├── lib/
│   ├── SheetModel.ts        # 数据存储模型
│   └── UndoRedoManager.ts   # 撤销/重做管理器 (NEW)
└── App.vue                  # 应用入口
```

## 技术栈

- **框架**: Vue 3 + TypeScript
- **构建**: Vite 7.2.4
- **渲染**: Canvas 2D
- **开发服务器**: http://localhost:5174
- **LAN 访问**: http://0.0.0.0:5174

## 快捷键速查表

| 快捷键 | 功能 |
|--------|------|
| ↑↓←→ | 移动选中单元格 |
| Shift + ↑↓←→ | 快速移动（5 步） |
| Enter | 向下移动，到底后换列 |
| Tab | 向右移动，到右后换行 |
| 双击 | 进入编辑模式 |
| 任意字符 | 开始编辑单元格 |
| Escape | 取消编辑 |
| Ctrl+C / Cmd+C | 复制选中内容 |
| Ctrl+V / Cmd+V | 粘贴内容 |
| Ctrl+Z / Cmd+Z | 撤销上一步 |
| Ctrl+Y / Cmd+Y | 重做下一步 |
| Ctrl+Shift+Z / Cmd+Shift+Z | 重做下一步（替代） |

## 代码清理记录

### 2025-11-25 更新：
1. ✅ **移除调试代码**
   - 删除 `DEBUG_IME` 常量
   - 移除 `logIME()` 函数
   - 删除所有 IME 调试日志调用

2. ✅ **清理未使用的代码**
   - 删除 `pendingCharTimer` 变量
   - 删除 `schedulePendingChar()` 函数
   - 删除 `clearPendingChar()` 函数
   - 这些是旧的 IME 处理尝试，已被新架构替代

## 未来计划

### 优先级高
- [ ] 解决中文输入法 (IME) 支持
- [ ] 单元格样式编辑（字体、颜色、背景等）
- [ ] 公式支持（已安装 hot-formula-parser）

### 优先级中
- [ ] 行列冻结（固定表头）
- [ ] 列宽调整
- [ ] 行高调整
- [ ] 单元格合并
- [ ] 数据类型支持（数字、日期、货币）

### 优先级低
- [ ] 条件格式
- [ ] 数据验证
- [ ] 排序过滤
- [ ] 数据透视表
- [ ] 导出/导入（Excel、CSV）

## 性能指标

- **虚拟化**: 仅渲染可见单元格
- **内存**: 稀疏数据结构，只存储非空单元格
- **刷新率**: RequestAnimationFrame 同步浏览器刷新
- **支持规模**: 1000+ 行 x 50+ 列

## 测试建议

1. 打开应用，验证基础渲染
2. 测试键盘导航所有快捷键
3. 双击编辑单元格，输入不同类型内容
4. 测试撤销/重做：编辑 → Ctrl+Z → Ctrl+Y
5. 复制/粘贴多个单元格
6. 拖动选择范围
7. 使用鼠标滚轮滚动
8. 窗口缩放，验证响应式布局
