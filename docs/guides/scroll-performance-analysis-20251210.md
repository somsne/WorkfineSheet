# å¤§æ•°æ®é‡æ»šåŠ¨å¡é¡¿æ€§èƒ½åˆ†ææŠ¥å‘Š

**æµ‹è¯•æ—¶é—´**: 2025-12-10  
**æµ‹è¯•åœºæ™¯**: å¤§æ•°æ®é‡è¡¨æ ¼æ»šåŠ¨æ“ä½œ  
**æ€»é‡‡æ ·æ•°**: 69,506 ä¸ª  
**æ´»è·ƒä»£ç é‡‡æ ·**: 28,550 ä¸ª (41.1%)

---

## ä¸€ã€æ•´ä½“æ€§èƒ½æ¦‚è§ˆ

### 1.1 CPU æ—¶é—´åˆ†å¸ƒ

| ç±»åˆ« | é‡‡æ ·æ•° | å æ¯” | è¯´æ˜ |
|------|--------|------|------|
| ç©ºé—² (idle) | 36,367 | 52.3% | CPU ç­‰å¾…æ—¶é—´ |
| æ´»è·ƒä»£ç  | 28,550 | 41.1% | å®é™…æ‰§è¡Œä»£ç  |
| ç¨‹åºæ¡†æ¶ | 4,197 | 6.0% | V8 å¼•æ“å¼€é”€ |
| åƒåœ¾å›æ”¶ | 392 | 0.6% | GC å¼€é”€ï¼ˆè¾ƒä½ï¼‰ |

### 1.2 å¸§ç‡åˆ†æ

| æŒ‡æ ‡ | å€¼ | è¯„ä¼° |
|------|-----|------|
| æ€»å¸§æ•° | 454 | - |
| å¹³å‡å¸§è€—æ—¶ | 7.92 ms | âœ… ä¼˜ç§€ (< 16.67ms) |
| æœ€å¤§å¸§è€—æ—¶ | 32.77 ms | âš ï¸ å¶å‘å¡é¡¿ |
| æœ€å°å¸§è€—æ—¶ | 3.17 ms | âœ… æµç•… |
| å¡é¡¿å¸§ (>16.67ms) | 1 ä¸ª (0.2%) | âœ… æå°‘ |

**å¸§è€—æ—¶åˆ†å¸ƒ**:
- 0-8ms: 238 å¸§ (52.4%) - æµç•…
- 8-16ms: 214 å¸§ (47.1%) - æ­£å¸¸
- 16-33ms: 2 å¸§ (0.4%) - è½»å¾®å¡é¡¿
- >33ms: 0 å¸§ (0%) - æ— ä¸¥é‡å¡é¡¿

### 1.3 æ»šåŠ¨äº‹ä»¶åˆ†æ

| æŒ‡æ ‡ | å€¼ |
|------|-----|
| æ»šåŠ¨äº‹ä»¶æ•° | 41 ä¸ª |
| å¹³å‡å¤„ç†æ—¶é—´ | 6.21 ms |
| æœ€å¤§å¤„ç†æ—¶é—´ | 15.34 ms |
| æ€»å¤„ç†æ—¶é—´ | 254.52 ms |

---

## äºŒã€çƒ­ç‚¹å‡½æ•°åˆ†æ

### 2.1 æŒ‰æ¨¡å—åˆ†ç»„

| æ¨¡å— | é‡‡æ ·æ•° | å æ¯” | é—®é¢˜ä¸¥é‡åº¦ |
|------|--------|------|-----------|
| **vue.js** | 12,375 | **43.3%** | ğŸ”´ ä¸¥é‡ |
| **geometry.ts** | 5,801 | **20.3%** | ğŸ”´ ä¸¥é‡ |
| native/built-in | 5,011 | 17.6% | ğŸŸ¡ ä¸­ç­‰ |
| renderCells.ts | 2,039 | 7.1% | ğŸŸ¡ ä¸­ç­‰ |
| SheetModel.ts | 1,797 | 6.3% | ğŸŸ¡ ä¸­ç­‰ |
| renderGrid.ts | 488 | 1.7% | ğŸŸ¢ æ­£å¸¸ |
| FormulaSheet.ts | 478 | 1.7% | ğŸŸ¢ æ­£å¸¸ |

### 2.2 Top 20 çƒ­ç‚¹å‡½æ•°

| æ’å | å‡½æ•° | é‡‡æ ·æ•° | å æ¯” | é—®é¢˜åˆ†æ |
|------|------|--------|------|---------|
| 1 | `getRowHeight` @ geometry.ts | 5,634 | **19.7%** | âš ï¸ é«˜é¢‘è°ƒç”¨ |
| 2 | `get` @ vue.js (Proxy) | 4,312 | **15.1%** | âš ï¸ å“åº”å¼å¼€é”€ |
| 3 | `(anonymous)` @ vue.js | 2,590 | 9.1% | Vue å†…éƒ¨ |
| 4 | `has` @ vue.js (Proxy) | 1,554 | 5.4% | å“åº”å¼å¼€é”€ |
| 5 | `set font` (Canvas) | 1,285 | 4.5% | Canvas æ“ä½œ |
| 6 | `toRaw` @ vue.js | 1,136 | 4.0% | å“åº”å¼å¼€é”€ |
| 7 | `drawCells` @ renderCells.ts | 1,049 | 3.7% | æ¸²æŸ“æ ¸å¿ƒ |
| 8 | `fillText` (Canvas) | 954 | 3.3% | æ–‡æœ¬ç»˜åˆ¶ |
| 9 | `requestAnimationFrame` | 943 | 3.3% | å¸§è°ƒåº¦ |
| 10 | `hasOwn` @ vue.js | 717 | 2.5% | å“åº”å¼å¼€é”€ |

### 2.3 æ€§èƒ½å¼€é”€åˆ†ç±»

| ç±»åˆ« | é‡‡æ ·æ•° | å æ´»è·ƒä»£ç % | ä¼˜åŒ–æ–¹æ¡ˆ |
|------|--------|------------|---------|
| **Vue å“åº”å¼** | 12,091 | **42.4%** | `toRaw()` ç»•è¿‡ Proxy |
| **å‡ ä½•è®¡ç®—** | 5,740 | **20.1%** | ä½ç½®ç´¢å¼•ç¼“å­˜ |
| **Canvas æ“ä½œ** | 3,776 | **13.2%** | å­—ä½“/çŠ¶æ€ç¼“å­˜ |
| **æ•°æ®è®¿é—®** | 1,654 | **5.8%** | è¡Œçº§é¢„å– |

---

## ä¸‰ã€æ ¸å¿ƒé—®é¢˜åˆ†æ

### 3.1 é—®é¢˜ä¸€ï¼š`getRowHeight` é«˜é¢‘è°ƒç”¨ (19.7%)

**ç°è±¡**: `getRowHeight` å ç”¨è¿‘ 20% CPU

**åŸå› åˆ†æ**:
```typescript
// geometry.ts ä¸­çš„ getRowHeight
export function getRowHeight(row: number, sizes: SizeAccess, cfg: GeometryConfig): number {
  if (sizes.hiddenRows?.has(row)) return 0  // è§¦å‘ Proxy get
  return sizes.rowHeights.get(row) ?? cfg.defaultRowHeight  // è§¦å‘ Proxy get
}
```

æ¯æ¬¡è°ƒç”¨éƒ½ä¼šï¼š
1. è®¿é—® `sizes.hiddenRows` â†’ è§¦å‘ Vue Proxy `get`
2. è°ƒç”¨ `hiddenRows.has(row)` â†’ è§¦å‘ Vue Proxy `has`
3. è®¿é—® `sizes.rowHeights` â†’ è§¦å‘ Vue Proxy `get`
4. è°ƒç”¨ `rowHeights.get(row)` â†’ è§¦å‘ Vue Proxy `get`

**è°ƒç”¨åœºæ™¯**:
- æ¸²æŸ“æ¯ä¸ªå¯è§å•å…ƒæ ¼æ—¶è®¡ç®—ä½ç½®
- æ»šåŠ¨æ—¶é‡æ–°è®¡ç®—å¯è§èŒƒå›´
- é¼ æ ‡ç§»åŠ¨æ—¶è®¡ç®—æ‚¬åœä½ç½®

### 3.2 é—®é¢˜äºŒï¼šVue å“åº”å¼å¼€é”€è¿‡é«˜ (42.4%)

**ç°è±¡**: Vue Proxy ç›¸å…³å‡½æ•°å ç”¨ 42.4% æ´»è·ƒ CPU

**åŸå› **: æ¸²æŸ“å¾ªç¯ä¸­é¢‘ç¹è®¿é—®å“åº”å¼å¯¹è±¡ï¼š
- `rowHeights` (Map)
- `colWidths` (Map)
- `hiddenRows` (Set)
- `hiddenCols` (Set)

æ¯æ¬¡è®¿é—®éƒ½è§¦å‘ Proxy æ‹¦æˆªï¼Œäº§ç”Ÿå¤§é‡å¼€é”€ã€‚

### 3.3 é—®é¢˜ä¸‰ï¼šCanvas å­—ä½“è®¾ç½®é¢‘ç¹ (4.5%)

**ç°è±¡**: `set font` å ç”¨ 4.5% CPU

**åŸå› **: è™½ç„¶æœ‰å­—ä½“ç¼“å­˜ï¼Œä½†ä»æœ‰ä¼˜åŒ–ç©ºé—´ï¼š
- `ctx.save()` / `ctx.restore()` ä¼šé‡ç½®å­—ä½“çŠ¶æ€
- ä¸åŒå•å…ƒæ ¼å¯èƒ½æœ‰ä¸åŒå­—ä½“è®¾ç½®

---

## å››ã€å…³äºé˜²æŠ–ä¼˜åŒ–çš„åˆ†æ

### 4.1 å½“å‰æ»šåŠ¨å“åº”åˆ†æ

ä»æ€§èƒ½æ•°æ®çœ‹ï¼š
- æ»šåŠ¨äº‹ä»¶å¹³å‡å¤„ç†æ—¶é—´: **6.21 ms** (< 16.67msï¼Œæµç•…)
- æœ€å¤§å¤„ç†æ—¶é—´: **15.34 ms** (æ¥è¿‘å¸§è¾¹ç•Œä½†æœªè¶…)
- å¡é¡¿å¸§å æ¯”: **0.2%** (æå°‘)

### 4.2 é˜²æŠ–æ˜¯å¦é€‚åˆï¼Ÿ

**ç»“è®ºï¼šä¸å»ºè®®æ·»åŠ é˜²æŠ–**

**åŸå› åˆ†æ**:

1. **å½“å‰å“åº”é€Ÿåº¦å¹¶é"å¤ªå¿«"**
   - æ»šåŠ¨äº‹ä»¶å¤„ç†æ—¶é—´åœ¨åˆç†èŒƒå›´å†…
   - å¡é¡¿å¸§æå°‘ï¼ˆ0.2%ï¼‰
   - é—®é¢˜ä¸æ˜¯å“åº”å¤ªé¢‘ç¹ï¼Œè€Œæ˜¯**å•æ¬¡å“åº”çš„è®¡ç®—å¼€é”€å¤ªå¤§**

2. **é˜²æŠ–ä¼šå¸¦æ¥çš„é—®é¢˜**
   - æ»šåŠ¨ä¼šå‡ºç°"è·³å¸§"ï¼Œç”¨æˆ·æ„ŸçŸ¥æ˜æ˜¾
   - æ‰‹æŒ‡ç¦»å¼€åå†…å®¹æ‰æ›´æ–°ï¼Œä½“éªŒå·®
   - å¯¹äºæ»šåŠ¨è¿™ç§è¿ç»­æ“ä½œï¼Œé˜²æŠ–ä¼šä¸¥é‡å½±å“æµç•…åº¦

3. **æ­£ç¡®çš„ä¼˜åŒ–æ–¹å‘**
   - ä¼˜åŒ–å•å¸§è®¡ç®—æ—¶é—´ï¼ˆå½“å‰é‡ç‚¹ï¼‰
   - ä½¿ç”¨ `requestAnimationFrame` èŠ‚æµï¼ˆå·²å®ç°ï¼‰
   - å‡å°‘ Vue Proxy å¼€é”€ï¼ˆæ ¸å¿ƒä¼˜åŒ–ç‚¹ï¼‰

### 4.3 ä½•æ—¶è€ƒè™‘é˜²æŠ–/èŠ‚æµ

| åœºæ™¯ | å»ºè®® |
|------|------|
| æ»šåŠ¨æ¸²æŸ“ | âŒ ä¸é˜²æŠ–ï¼Œç”¨ RAF èŠ‚æµ |
| çª—å£è°ƒæ•´å¤§å° | âœ… é˜²æŠ– 100-200ms |
| æœç´¢è¾“å…¥ | âœ… é˜²æŠ– 300ms |
| è‡ªåŠ¨ä¿å­˜ | âœ… é˜²æŠ– 1000ms |

---

## äº”ã€ä¼˜åŒ–å»ºè®®

### 5.1 P0 - é«˜ä¼˜å…ˆçº§ï¼ˆé¢„æœŸæ”¶ç›Š > 30%ï¼‰

#### ä¼˜åŒ– 1ï¼šæ¸²æŸ“æ—¶ä½¿ç”¨ `toRaw()` ç»•è¿‡ Vue Proxy

```typescript
// useSheetDrawing.ts æˆ– renderCells.ts
import { toRaw } from 'vue'

function draw() {
  // æ¸²æŸ“å‰è·å–åŸå§‹å¯¹è±¡ï¼Œé¿å…æ‰€æœ‰ Proxy å¼€é”€
  const rawRowHeights = toRaw(rowHeights.value)
  const rawColWidths = toRaw(colWidths.value)
  const rawHiddenRows = toRaw(hiddenRows.value)
  const rawHiddenCols = toRaw(hiddenCols.value)
  
  const rawSizes: SizeAccess = {
    rowHeights: rawRowHeights,
    colWidths: rawColWidths,
    hiddenRows: rawHiddenRows,
    hiddenCols: rawHiddenCols
  }
  
  // ä½¿ç”¨åŸå§‹å¯¹è±¡è¿›è¡Œæ¸²æŸ“
  drawCells(ctx, rawSizes, ...)
}
```

**é¢„æœŸæ”¶ç›Š**: CPU ä» 42.4% â†’ ~5% (Vue å“åº”å¼å¼€é”€)

#### ä¼˜åŒ– 2ï¼šç¼“å­˜ SizeAccess å¯¹è±¡

```typescript
// useSheetGeometry.ts
let cachedSizeAccess: SizeAccess | null = null
let sizeAccessVersion = 0

function createSizeAccess(): SizeAccess {
  // åªåœ¨æ•°æ®å˜åŒ–æ—¶é‡å»º
  if (cachedSizeAccess && !isDirty) {
    return cachedSizeAccess
  }
  
  cachedSizeAccess = {
    rowHeights: toRaw(rowHeights.value),
    colWidths: toRaw(colWidths.value),
    hiddenRows: toRaw(hiddenRows.value),
    hiddenCols: toRaw(hiddenCols.value)
  }
  return cachedSizeAccess
}
```

### 5.2 P1 - ä¸­ä¼˜å…ˆçº§ï¼ˆé¢„æœŸæ”¶ç›Š 10-30%ï¼‰

#### ä¼˜åŒ– 3ï¼šå‡ ä½•è®¡ç®—ç¼“å­˜æ£€æŸ¥

ç¡®ä¿ `PositionIndex` çš„ç¼“å­˜æ­£ç¡®ç”Ÿæ•ˆï¼ˆå·²ä¿®å¤å¼•ç”¨æ¯”è¾ƒé—®é¢˜ï¼‰ã€‚

éªŒè¯æ–¹æ³•ï¼š
```typescript
// æ·»åŠ è°ƒè¯•æ—¥å¿—
rebuildRowIndex(...) {
  console.log('rebuildRowIndex called, dirtyRows:', this.dirtyRows)
  // ...
}
```

#### ä¼˜åŒ– 4ï¼šCanvas çŠ¶æ€ç¼“å­˜å¢å¼º

```typescript
// é¿å…é¢‘ç¹ save/restore
let currentFontCached = ''
let currentLineWidthCached = -1

function setFontIfNeeded(ctx: CanvasRenderingContext2D, font: string) {
  if (currentFontCached !== font) {
    ctx.font = font
    currentFontCached = font
  }
}

// save/restore åé‡ç½®ç¼“å­˜
function afterRestore() {
  currentFontCached = ''
  currentLineWidthCached = -1
}
```

### 5.3 P2 - ä½ä¼˜å…ˆçº§ï¼ˆé¢„æœŸæ”¶ç›Š < 10%ï¼‰

#### ä¼˜åŒ– 5ï¼šè¡Œçº§æ•°æ®é¢„å–

```typescript
// æ¸²æŸ“ä¸€è¡Œå‰ï¼Œæ‰¹é‡è·å–è¯¥è¡Œæ‰€æœ‰æ•°æ®
interface RowCache {
  styles: Map<number, CellStyle>
  formats: Map<number, CellFormat>
  borders: Map<number, CellBorder>
}

function prefetchRowData(row: number, startCol: number, endCol: number): RowCache {
  // ä¸€æ¬¡éå†æ”¶é›†æ‰€æœ‰æ•°æ®
}
```

#### ä¼˜åŒ– 6ï¼šè™šæ‹Ÿæ»šåŠ¨ä¼˜åŒ–

ç¡®ä¿åªæ¸²æŸ“å¯è§åŒºåŸŸ + å°‘é‡ç¼“å†²åŒºï¼ˆå½“å‰å·²å®ç°ï¼‰ã€‚

---

## å…­ã€ä¼˜åŒ–æ•ˆæœé¢„ä¼°

| ä¼˜åŒ–é¡¹ | å½“å‰å æ¯” | é¢„æœŸå‡å°‘ | å®æ–½éš¾åº¦ |
|--------|---------|---------|---------|
| Vue Proxy `toRaw()` | 42.4% | ~35% | â­â­ |
| å‡ ä½•ç¼“å­˜éªŒè¯ | 20.1% | ~15% | â­ |
| Canvas çŠ¶æ€ç¼“å­˜ | 13.2% | ~5% | â­â­ |
| æ•°æ®é¢„å– | 5.8% | ~3% | â­â­â­ |
| **æ€»è®¡** | | **~58%** | |

**é¢„æœŸæ•ˆæœ**:
- å½“å‰å¹³å‡å¸§è€—æ—¶: 7.92 ms
- ä¼˜åŒ–åé¢„ä¼°: ~3.5 ms
- å¸§ç‡æå‡: çº¦ 2 å€

---

## ä¸ƒã€ç»“è®º

### æ»šåŠ¨å¡é¡¿çš„æ ¹æœ¬åŸå› 

1. **ä¸æ˜¯å“åº”å¤ªå¿«** - å½“å‰å“åº”æ—¶é—´åœ¨åˆç†èŒƒå›´
2. **æ˜¯å•å¸§è®¡ç®—å¼€é”€å¤ªå¤§** - Vue Proxy å’Œå‡ ä½•è®¡ç®—å ç”¨è¿‡å¤š

### æ ¸å¿ƒä¼˜åŒ–æ–¹å‘

1. **ä½¿ç”¨ `toRaw()` ç»•è¿‡ Vue å“åº”å¼** - æœ€å¤§æ”¶ç›Š
2. **éªŒè¯ä½ç½®ç´¢å¼•ç¼“å­˜æ˜¯å¦ç”Ÿæ•ˆ** - å·²ä¿®å¤ï¼Œéœ€éªŒè¯
3. **Canvas çŠ¶æ€ç¼“å­˜** - ä¸­ç­‰æ”¶ç›Š

### ä¸å»ºè®®çš„ä¼˜åŒ–

- âŒ æ»šåŠ¨é˜²æŠ– - ä¼šå¯¼è‡´è·³å¸§ï¼Œä½“éªŒå˜å·®
- âŒ å‡å°‘æ¸²æŸ“é¢‘ç‡ - å½“å‰ RAF èŠ‚æµå·²è¶³å¤Ÿ
- âŒ å»¶è¿Ÿæ¸²æŸ“ - ä¼šäº§ç”Ÿå†…å®¹é—ªçƒ

---

## å…«ã€å®æ–½ä¼˜å…ˆçº§

1. **ç¬¬ä¸€é˜¶æ®µ**: åœ¨æ¸²æŸ“è·¯å¾„ä¸­ä½¿ç”¨ `toRaw()` è·å–åŸå§‹æ•°æ®
2. **ç¬¬äºŒé˜¶æ®µ**: éªŒè¯ PositionIndex ç¼“å­˜æ˜¯å¦æ­£å¸¸å·¥ä½œ
3. **ç¬¬ä¸‰é˜¶æ®µ**: ä¼˜åŒ– Canvas å­—ä½“/çŠ¶æ€ç¼“å­˜
4. **ç¬¬å››é˜¶æ®µ**: è€ƒè™‘è¡Œçº§æ•°æ®é¢„å–ï¼ˆå¦‚ä»æœ‰ç“¶é¢ˆï¼‰
