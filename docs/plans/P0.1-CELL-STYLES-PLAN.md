# ğŸ“ P0.1 å•å…ƒæ ¼æ ·å¼å¼€å‘å·¥ä½œæ–‡æ¡£

> **ä»»åŠ¡**: P0.1 å•å…ƒæ ¼æ ·å¼ ğŸ¨  
> **ä¼˜å…ˆçº§**: â­â­â­â­ (P0 - æœ€é«˜ä¼˜å…ˆçº§)  
> **é¢„è®¡æ—¶é—´**: 5 å¤©  
> **å¼€å§‹æ—¥æœŸ**: 2025-11-26  
> **çŠ¶æ€**: ğŸŸ¡ å‡†å¤‡ä¸­

---

## ğŸ“‹ åŠŸèƒ½éœ€æ±‚æ¸…å•

### æ ¸å¿ƒæ ·å¼å±æ€§ï¼ˆ12 é¡¹ï¼‰

| åºå· | åŠŸèƒ½ | å±æ€§å | å¯é€‰å€¼ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|------|------|--------|--------|--------|------|
| 1 | å­—ä½“ | fontFamily | 'Arial', 'Microsoft YaHei', 'å®‹ä½“', 'é»‘ä½“' ç­‰ | P0 | â³ å¾…å¼€å§‹ |
| 2 | å­—å· | fontSize | 9-72 (px) | P0 | â³ å¾…å¼€å§‹ |
| 3 | ç²—ä½“ | bold | true/false | P0 | â³ å¾…å¼€å§‹ |
| 4 | æ–œä½“ | italic | true/false | P0 | â³ å¾…å¼€å§‹ |
| 5 | ä¸‹åˆ’çº¿ | underline | true/false, 'single', 'double' | P0 | â³ å¾…å¼€å§‹ |
| 6 | åˆ é™¤çº¿ | strikethrough | true/false | P1 | â³ å¾…å¼€å§‹ |
| 7 | å­—ä½“é¢œè‰² | color | '#000000' (hex) / 'rgb()' | P0 | â³ å¾…å¼€å§‹ |
| 8 | èƒŒæ™¯è‰² | backgroundColor | '#FFFFFF' (hex) / 'rgb()' | P0 | â³ å¾…å¼€å§‹ |
| 9 | æ°´å¹³å¯¹é½ | textAlign | 'left', 'center', 'right' | P0 | â³ å¾…å¼€å§‹ |
| 10 | å‚ç›´å¯¹é½ | verticalAlign | 'top', 'middle', 'bottom' | P0 | â³ å¾…å¼€å§‹ |
| 11 | è‡ªåŠ¨æ¢è¡Œ | wrapText | true/false | P1 | â³ å¾…å¼€å§‹ |
| 12 | æ–‡å­—æ–¹å‘ | textRotation | 0-360 (åº¦æ•°) | P2 | â³ å¾…å¼€å§‹ |

---

## ğŸ¯ å¼€å‘é˜¶æ®µè§„åˆ’

### é˜¶æ®µ 1: æ•°æ®ç»“æ„ä¸åŸºç¡€æ¶æ„ï¼ˆ1 å¤©ï¼‰âœ… å…³é”®åŸºç¡€

#### 1.1 ç±»å‹å®šä¹‰
**æ–‡ä»¶**: `src/components/sheet/types.ts`

```typescript
/**
 * å•å…ƒæ ¼æ ·å¼æ¥å£
 */
export interface CellStyle {
  // å­—ä½“ç›¸å…³
  fontFamily?: string          // å­—ä½“åç§°
  fontSize?: number            // å­—å· (px)
  bold?: boolean               // ç²—ä½“
  italic?: boolean             // æ–œä½“
  underline?: boolean | 'single' | 'double'  // ä¸‹åˆ’çº¿
  strikethrough?: boolean      // åˆ é™¤çº¿
  
  // é¢œè‰²ç›¸å…³
  color?: string               // å­—ä½“é¢œè‰² (hex/rgb)
  backgroundColor?: string     // èƒŒæ™¯è‰² (hex/rgb)
  
  // å¯¹é½ç›¸å…³
  textAlign?: 'left' | 'center' | 'right'           // æ°´å¹³å¯¹é½
  verticalAlign?: 'top' | 'middle' | 'bottom'       // å‚ç›´å¯¹é½
  
  // æ–‡æœ¬å¤„ç†
  wrapText?: boolean           // è‡ªåŠ¨æ¢è¡Œ
  textRotation?: number        // æ–‡å­—æ—‹è½¬è§’åº¦ (0-360)
}

/**
 * é»˜è®¤æ ·å¼
 */
export const DEFAULT_CELL_STYLE: CellStyle = {
  fontFamily: 'Arial, sans-serif',
  fontSize: 12,
  bold: false,
  italic: false,
  underline: false,
  strikethrough: false,
  color: '#000000',
  backgroundColor: '#FFFFFF',
  textAlign: 'left',
  verticalAlign: 'middle',
  wrapText: false,
  textRotation: 0
}
```

**ä»»åŠ¡æ¸…å•**:
- [ ] å®šä¹‰ `CellStyle` æ¥å£ï¼ˆ12 ä¸ªå±æ€§ï¼‰
- [ ] å®šä¹‰ `DEFAULT_CELL_STYLE` å¸¸é‡
- [ ] æ·»åŠ æ ·å¼è¾…åŠ©ç±»å‹ï¼ˆStyleKey, StyleValue ç­‰ï¼‰
- [ ] ç¼–å†™ç±»å‹æ–‡æ¡£æ³¨é‡Š

---

#### 1.2 æ•°æ®æ¨¡å‹æ‰©å±•
**æ–‡ä»¶**: `src/lib/SheetModel.ts`

```typescript
export class SheetModel {
  // æ–°å¢ï¼šæ ·å¼å­˜å‚¨ï¼ˆä½¿ç”¨ Map ä¼˜åŒ–æ€§èƒ½ï¼‰
  private cellStyles: Map<string, CellStyle> = new Map()
  
  /**
   * è®¾ç½®å•å…ƒæ ¼æ ·å¼
   */
  setCellStyle(row: number, col: number, style: Partial<CellStyle>): void {
    const key = `${row},${col}`
    const currentStyle = this.cellStyles.get(key) || { ...DEFAULT_CELL_STYLE }
    this.cellStyles.set(key, { ...currentStyle, ...style })
  }
  
  /**
   * è·å–å•å…ƒæ ¼æ ·å¼
   */
  getCellStyle(row: number, col: number): CellStyle {
    const key = `${row},${col}`
    return this.cellStyles.get(key) || { ...DEFAULT_CELL_STYLE }
  }
  
  /**
   * æ¸…é™¤å•å…ƒæ ¼æ ·å¼
   */
  clearCellStyle(row: number, col: number): void {
    const key = `${row},${col}`
    this.cellStyles.delete(key)
  }
  
  /**
   * æ‰¹é‡è®¾ç½®æ ·å¼ï¼ˆé€‰åŒºï¼‰
   */
  setRangeStyle(
    startRow: number, 
    startCol: number, 
    endRow: number, 
    endCol: number, 
    style: Partial<CellStyle>
  ): void {
    for (let r = startRow; r <= endRow; r++) {
      for (let c = startCol; c <= endCol; c++) {
        this.setCellStyle(r, c, style)
      }
    }
  }
}
```

**ä»»åŠ¡æ¸…å•**:
- [ ] æ·»åŠ  `cellStyles` Map å­˜å‚¨
- [ ] å®ç° `setCellStyle()` æ–¹æ³•
- [ ] å®ç° `getCellStyle()` æ–¹æ³•
- [ ] å®ç° `clearCellStyle()` æ–¹æ³•
- [ ] å®ç° `setRangeStyle()` æ‰¹é‡è®¾ç½®
- [ ] æ·»åŠ æ ·å¼åºåˆ—åŒ–/ååºåˆ—åŒ–æ–¹æ³•

---

### é˜¶æ®µ 2: æ ¸å¿ƒæ¸²æŸ“å®ç°ï¼ˆ2 å¤©ï¼‰ğŸ¨ æœ€é‡è¦

#### 2.1 å­—ä½“ä¸æ–‡æœ¬æ ·å¼æ¸²æŸ“
**æ–‡ä»¶**: `src/components/sheet/renderCells.ts`

**å®ç°ä¼˜å…ˆçº§**:
1. **P0 - åŸºç¡€æ–‡æœ¬** (0.5 å¤©)
   - [ ] å­—ä½“ (fontFamily)
   - [ ] å­—å· (fontSize)
   - [ ] å­—ä½“é¢œè‰² (color)

2. **P0 - æ–‡æœ¬è£…é¥°** (0.5 å¤©)
   - [ ] ç²—ä½“ (bold)
   - [ ] æ–œä½“ (italic)
   - [ ] ä¸‹åˆ’çº¿ (underline)
   - [ ] åˆ é™¤çº¿ (strikethrough)

3. **P0 - å¯¹é½æ–¹å¼** (0.5 å¤©)
   - [ ] æ°´å¹³å¯¹é½ (textAlign: left/center/right)
   - [ ] å‚ç›´å¯¹é½ (verticalAlign: top/middle/bottom)

4. **P1 - é«˜çº§åŠŸèƒ½** (0.5 å¤©)
   - [ ] èƒŒæ™¯è‰² (backgroundColor)
   - [ ] è‡ªåŠ¨æ¢è¡Œ (wrapText)
   - [ ] æ–‡å­—æ—‹è½¬ (textRotation)

**æ ¸å¿ƒä»£ç ç»“æ„**:
```typescript
function renderCellContent(
  ctx: CanvasRenderingContext2D,
  cell: CellData,
  style: CellStyle,
  x: number,
  y: number,
  width: number,
  height: number
): void {
  // 1. ç»˜åˆ¶èƒŒæ™¯è‰²
  if (style.backgroundColor && style.backgroundColor !== '#FFFFFF') {
    ctx.fillStyle = style.backgroundColor
    ctx.fillRect(x, y, width, height)
  }
  
  // 2. è®¾ç½®å­—ä½“æ ·å¼
  const fontStyle = buildFontString(style)
  ctx.font = fontStyle
  ctx.fillStyle = style.color || '#000000'
  
  // 3. è®¡ç®—æ–‡æœ¬ä½ç½®ï¼ˆè€ƒè™‘å¯¹é½ï¼‰
  const textX = calculateTextX(x, width, style.textAlign)
  const textY = calculateTextY(y, height, style.verticalAlign, style.fontSize)
  
  // 4. ç»˜åˆ¶æ–‡æœ¬
  if (style.wrapText) {
    renderWrappedText(ctx, cell.value, textX, textY, width, style)
  } else {
    ctx.fillText(cell.value, textX, textY)
  }
  
  // 5. ç»˜åˆ¶æ–‡æœ¬è£…é¥°ï¼ˆä¸‹åˆ’çº¿ã€åˆ é™¤çº¿ï¼‰
  if (style.underline) {
    drawUnderline(ctx, textX, textY, width, style)
  }
  if (style.strikethrough) {
    drawStrikethrough(ctx, textX, textY, width, style)
  }
}

/**
 * æ„å»º Canvas font å­—ç¬¦ä¸²
 */
function buildFontString(style: CellStyle): string {
  const parts: string[] = []
  
  if (style.italic) parts.push('italic')
  if (style.bold) parts.push('bold')
  
  parts.push(`${style.fontSize || 12}px`)
  parts.push(style.fontFamily || 'Arial, sans-serif')
  
  return parts.join(' ')
}
```

**ä»»åŠ¡æ¸…å•**:
- [ ] ä¿®æ”¹ `renderCells.ts` ä¸»æ¸²æŸ“å‡½æ•°
- [ ] å®ç° `buildFontString()` - å­—ä½“æ ·å¼å­—ç¬¦ä¸²æ„å»º
- [ ] å®ç° `calculateTextX()` - æ°´å¹³å¯¹é½è®¡ç®—
- [ ] å®ç° `calculateTextY()` - å‚ç›´å¯¹é½è®¡ç®—
- [ ] å®ç° `drawUnderline()` - ä¸‹åˆ’çº¿ç»˜åˆ¶
- [ ] å®ç° `drawStrikethrough()` - åˆ é™¤çº¿ç»˜åˆ¶
- [ ] å®ç° `renderWrappedText()` - è‡ªåŠ¨æ¢è¡Œæ–‡æœ¬
- [ ] å®ç° `drawRotatedText()` - æ—‹è½¬æ–‡æœ¬
- [ ] æ·»åŠ æ–‡æœ¬æµ‹é‡ä¼˜åŒ–ï¼ˆmeasureText ç¼“å­˜ï¼‰

---

#### 2.2 èƒŒæ™¯è‰²ä¸è£…é¥°æ¸²æŸ“
**æ–‡ä»¶**: `src/components/sheet/renderCells.ts`

```typescript
/**
 * ç»˜åˆ¶å•å…ƒæ ¼èƒŒæ™¯
 */
function drawCellBackground(
  ctx: CanvasRenderingContext2D,
  x: number,
  y: number,
  width: number,
  height: number,
  backgroundColor?: string
): void {
  if (!backgroundColor || backgroundColor === '#FFFFFF') return
  
  ctx.fillStyle = backgroundColor
  ctx.fillRect(x, y, width, height)
}

/**
 * ç»˜åˆ¶ä¸‹åˆ’çº¿
 */
function drawUnderline(
  ctx: CanvasRenderingContext2D,
  x: number,
  y: number,
  textWidth: number,
  style: CellStyle
): void {
  const underlineY = y + 2 // æ–‡æœ¬åŸºçº¿ä¸‹æ–¹ 2px
  
  ctx.strokeStyle = style.color || '#000000'
  ctx.lineWidth = style.underline === 'double' ? 1 : 1
  
  ctx.beginPath()
  ctx.moveTo(x, underlineY)
  ctx.lineTo(x + textWidth, underlineY)
  ctx.stroke()
  
  // åŒä¸‹åˆ’çº¿
  if (style.underline === 'double') {
    ctx.beginPath()
    ctx.moveTo(x, underlineY + 2)
    ctx.lineTo(x + textWidth, underlineY + 2)
    ctx.stroke()
  }
}

/**
 * ç»˜åˆ¶åˆ é™¤çº¿
 */
function drawStrikethrough(
  ctx: CanvasRenderingContext2D,
  x: number,
  y: number,
  textWidth: number,
  style: CellStyle
): void {
  const fontSize = style.fontSize || 12
  const strikeY = y - fontSize / 2 + 2
  
  ctx.strokeStyle = style.color || '#000000'
  ctx.lineWidth = 1
  
  ctx.beginPath()
  ctx.moveTo(x, strikeY)
  ctx.lineTo(x + textWidth, strikeY)
  ctx.stroke()
}
```

**ä»»åŠ¡æ¸…å•**:
- [ ] å®ç°èƒŒæ™¯è‰²ç»˜åˆ¶
- [ ] å®ç°å•ä¸‹åˆ’çº¿ç»˜åˆ¶
- [ ] å®ç°åŒä¸‹åˆ’çº¿ç»˜åˆ¶
- [ ] å®ç°åˆ é™¤çº¿ç»˜åˆ¶
- [ ] ä¼˜åŒ–ç»˜åˆ¶æ€§èƒ½ï¼ˆå‡å°‘ beginPath è°ƒç”¨ï¼‰

---

### é˜¶æ®µ 3: API ä¸é›†æˆï¼ˆ1 å¤©ï¼‰ğŸ”Œ æ¥å£å±‚

#### 3.1 å…¬å…± API
**æ–‡ä»¶**: `src/components/sheet/api.ts`

```typescript
export interface SheetAPI {
  // æ ·å¼ç›¸å…³ API
  setCellStyle(row: number, col: number, style: Partial<CellStyle>): void
  getCellStyle(row: number, col: number): CellStyle
  clearCellStyle(row: number, col: number): void
  setRangeStyle(startRow: number, startCol: number, endRow: number, endCol: number, style: Partial<CellStyle>): void
  
  // å¿«æ·æ–¹æ³•
  setBold(row: number, col: number, bold: boolean): void
  setItalic(row: number, col: number, italic: boolean): void
  setFontSize(row: number, col: number, size: number): void
  setTextColor(row: number, col: number, color: string): void
  setBackgroundColor(row: number, col: number, color: string): void
  setTextAlign(row: number, col: number, align: 'left' | 'center' | 'right'): void
}
```

**ä»»åŠ¡æ¸…å•**:
- [ ] æ‰©å±• `api.ts` æ·»åŠ æ ·å¼æ–¹æ³•
- [ ] å®ç°åŸºç¡€æ ·å¼ APIï¼ˆset/get/clearï¼‰
- [ ] å®ç°æ‰¹é‡æ ·å¼ APIï¼ˆrangeï¼‰
- [ ] å®ç°å¿«æ·æ–¹æ³•ï¼ˆsetBold, setItalic ç­‰ï¼‰
- [ ] æ·»åŠ æ–¹æ³•å‚æ•°éªŒè¯
- [ ] è§¦å‘é‡ç»˜é€»è¾‘

---

#### 3.2 æ’¤é”€é‡åšé›†æˆ
**æ–‡ä»¶**: `src/lib/UndoRedoManager.ts`

```typescript
// æ ·å¼æ“ä½œå‘½ä»¤
interface SetStyleCommand {
  type: 'setStyle'
  row: number
  col: number
  oldStyle: CellStyle
  newStyle: CellStyle
}

// æ‰¹é‡æ ·å¼æ“ä½œå‘½ä»¤
interface SetRangeStyleCommand {
  type: 'setRangeStyle'
  startRow: number
  startCol: number
  endRow: number
  endCol: number
  oldStyles: Map<string, CellStyle>
  newStyle: Partial<CellStyle>
}
```

**ä»»åŠ¡æ¸…å•**:
- [ ] å®šä¹‰æ ·å¼æ“ä½œå‘½ä»¤ç±»å‹
- [ ] å®ç°å•å…ƒæ ¼æ ·å¼çš„ undo/redo
- [ ] å®ç°æ‰¹é‡æ ·å¼çš„ undo/redo
- [ ] ä¼˜åŒ–æ‰¹é‡æ“ä½œçš„å†…å­˜ä½¿ç”¨
- [ ] æµ‹è¯•æ’¤é”€é‡åšåŠŸèƒ½

---

### é˜¶æ®µ 4: UI ç»„ä»¶ä¸äº¤äº’ï¼ˆ1 å¤©ï¼‰ğŸ¨ ç”¨æˆ·ç•Œé¢

#### 4.1 æ ·å¼å·¥å…·æ ç»„ä»¶
**æ–‡ä»¶**: `src/components/StyleToolbar.vue`

```vue
<template>
  <div class="style-toolbar">
    <!-- å­—ä½“é€‰æ‹© -->
    <select v-model="currentStyle.fontFamily" @change="applyStyle">
      <option value="Arial, sans-serif">Arial</option>
      <option value="'Microsoft YaHei', sans-serif">å¾®è½¯é›…é»‘</option>
      <option value="'SimSun', serif">å®‹ä½“</option>
      <option value="'SimHei', sans-serif">é»‘ä½“</option>
    </select>
    
    <!-- å­—å·é€‰æ‹© -->
    <select v-model.number="currentStyle.fontSize" @change="applyStyle">
      <option v-for="size in fontSizes" :key="size" :value="size">{{ size }}</option>
    </select>
    
    <!-- æ ·å¼æŒ‰é’® -->
    <button 
      :class="{ active: currentStyle.bold }" 
      @click="toggleBold"
      title="ç²—ä½“ (Ctrl+B)"
    >
      <strong>B</strong>
    </button>
    
    <button 
      :class="{ active: currentStyle.italic }" 
      @click="toggleItalic"
      title="æ–œä½“ (Ctrl+I)"
    >
      <em>I</em>
    </button>
    
    <button 
      :class="{ active: currentStyle.underline }" 
      @click="toggleUnderline"
      title="ä¸‹åˆ’çº¿ (Ctrl+U)"
    >
      <u>U</u>
    </button>
    
    <button 
      :class="{ active: currentStyle.strikethrough }" 
      @click="toggleStrikethrough"
      title="åˆ é™¤çº¿"
    >
      <s>S</s>
    </button>
    
    <!-- é¢œè‰²é€‰æ‹©å™¨ -->
    <input 
      type="color" 
      v-model="currentStyle.color" 
      @change="applyStyle"
      title="å­—ä½“é¢œè‰²"
    />
    
    <input 
      type="color" 
      v-model="currentStyle.backgroundColor" 
      @change="applyStyle"
      title="èƒŒæ™¯è‰²"
    />
    
    <!-- å¯¹é½æŒ‰é’® -->
    <div class="align-buttons">
      <button @click="setAlign('left')" :class="{ active: currentStyle.textAlign === 'left' }">
        å·¦å¯¹é½
      </button>
      <button @click="setAlign('center')" :class="{ active: currentStyle.textAlign === 'center' }">
        å±…ä¸­
      </button>
      <button @click="setAlign('right')" :class="{ active: currentStyle.textAlign === 'right' }">
        å³å¯¹é½
      </button>
    </div>
    
    <!-- è‡ªåŠ¨æ¢è¡Œ -->
    <button 
      :class="{ active: currentStyle.wrapText }" 
      @click="toggleWrapText"
      title="è‡ªåŠ¨æ¢è¡Œ"
    >
      æ¢è¡Œ
    </button>
  </div>
</template>

<script setup lang="ts">
import { ref, watch } from 'vue'
import type { CellStyle } from '../sheet/types'

const props = defineProps<{
  sheetAPI: any
  selectedCell?: { row: number, col: number }
}>()

const currentStyle = ref<CellStyle>({ ...DEFAULT_CELL_STYLE })
const fontSizes = [9, 10, 11, 12, 14, 16, 18, 20, 24, 28, 32, 36, 48, 72]

// ç›‘å¬é€‰ä¸­å•å…ƒæ ¼å˜åŒ–ï¼Œæ›´æ–°å·¥å…·æ çŠ¶æ€
watch(() => props.selectedCell, (cell) => {
  if (cell) {
    currentStyle.value = props.sheetAPI.getCellStyle(cell.row, cell.col)
  }
}, { immediate: true })

function applyStyle() {
  if (props.selectedCell) {
    props.sheetAPI.setCellStyle(
      props.selectedCell.row, 
      props.selectedCell.col, 
      currentStyle.value
    )
  }
}

function toggleBold() {
  currentStyle.value.bold = !currentStyle.value.bold
  applyStyle()
}

// ... å…¶ä»–åˆ‡æ¢æ–¹æ³•
</script>
```

**ä»»åŠ¡æ¸…å•**:
- [ ] åˆ›å»º `StyleToolbar.vue` ç»„ä»¶
- [ ] å®ç°å­—ä½“é€‰æ‹©ä¸‹æ‹‰æ¡†
- [ ] å®ç°å­—å·é€‰æ‹©ä¸‹æ‹‰æ¡†
- [ ] å®ç°æ ·å¼åˆ‡æ¢æŒ‰é’®ï¼ˆB/I/U/Sï¼‰
- [ ] å®ç°é¢œè‰²é€‰æ‹©å™¨ï¼ˆå­—ä½“è‰²/èƒŒæ™¯è‰²ï¼‰
- [ ] å®ç°å¯¹é½æŒ‰é’®ç»„
- [ ] å®ç°æ¢è¡Œåˆ‡æ¢æŒ‰é’®
- [ ] æ·»åŠ å·¥å…·æ æ ·å¼ï¼ˆCSSï¼‰
- [ ] å®ç°å·¥å…·æ çŠ¶æ€åŒæ­¥

---

#### 4.2 å¿«æ·é”®æ”¯æŒ
**æ–‡ä»¶**: `src/components/sheet/events.ts`

```typescript
// æ ·å¼å¿«æ·é”®
const styleKeyBindings = {
  'Ctrl+B': 'toggleBold',
  'Ctrl+I': 'toggleItalic',
  'Ctrl+U': 'toggleUnderline',
  'Ctrl+Shift+X': 'toggleStrikethrough'
}
```

**ä»»åŠ¡æ¸…å•**:
- [ ] æ·»åŠ æ ·å¼å¿«æ·é”®æ˜ å°„
- [ ] å®ç°å¿«æ·é”®å¤„ç†é€»è¾‘
- [ ] æ”¯æŒ Ctrl+B (ç²—ä½“)
- [ ] æ”¯æŒ Ctrl+I (æ–œä½“)
- [ ] æ”¯æŒ Ctrl+U (ä¸‹åˆ’çº¿)
- [ ] æµ‹è¯•å¿«æ·é”®å†²çª

---

### é˜¶æ®µ 5: æµ‹è¯•ä¸ä¼˜åŒ–ï¼ˆ0.5 å¤©ï¼‰ğŸ§ª è´¨é‡ä¿éšœ

#### 5.1 å•å…ƒæµ‹è¯•
**æ–‡ä»¶**: `src/components/sheet/tests/styles.spec.ts`

```typescript
import { describe, it, expect } from 'vitest'
import { SheetModel } from '@/lib/SheetModel'
import { DEFAULT_CELL_STYLE } from '../types'

describe('å•å…ƒæ ¼æ ·å¼', () => {
  it('åº”è¯¥è®¾ç½®å’Œè·å–å•å…ƒæ ¼æ ·å¼', () => {
    const model = new SheetModel()
    const style = { bold: true, fontSize: 16 }
    
    model.setCellStyle(0, 0, style)
    const result = model.getCellStyle(0, 0)
    
    expect(result.bold).toBe(true)
    expect(result.fontSize).toBe(16)
  })
  
  it('åº”è¯¥åˆå¹¶æ ·å¼è€Œä¸æ˜¯æ›¿æ¢', () => {
    const model = new SheetModel()
    
    model.setCellStyle(0, 0, { bold: true })
    model.setCellStyle(0, 0, { italic: true })
    
    const style = model.getCellStyle(0, 0)
    expect(style.bold).toBe(true)
    expect(style.italic).toBe(true)
  })
  
  it('åº”è¯¥æ‰¹é‡è®¾ç½®èŒƒå›´æ ·å¼', () => {
    const model = new SheetModel()
    const style = { color: '#FF0000' }
    
    model.setRangeStyle(0, 0, 2, 2, style)
    
    expect(model.getCellStyle(0, 0).color).toBe('#FF0000')
    expect(model.getCellStyle(1, 1).color).toBe('#FF0000')
    expect(model.getCellStyle(2, 2).color).toBe('#FF0000')
  })
  
  it('åº”è¯¥æ¸…é™¤å•å…ƒæ ¼æ ·å¼', () => {
    const model = new SheetModel()
    
    model.setCellStyle(0, 0, { bold: true })
    model.clearCellStyle(0, 0)
    
    const style = model.getCellStyle(0, 0)
    expect(style).toEqual(DEFAULT_CELL_STYLE)
  })
})

describe('æ ·å¼æ¸²æŸ“', () => {
  it('åº”è¯¥æ­£ç¡®æ„å»ºå­—ä½“å­—ç¬¦ä¸²', () => {
    const style = { bold: true, italic: true, fontSize: 16, fontFamily: 'Arial' }
    const fontString = buildFontString(style)
    
    expect(fontString).toBe('italic bold 16px Arial')
  })
  
  it('åº”è¯¥è®¡ç®—æ­£ç¡®çš„æ–‡æœ¬å¯¹é½ä½ç½®', () => {
    // left align
    expect(calculateTextX(0, 100, 'left')).toBe(5) // padding
    
    // center align
    expect(calculateTextX(0, 100, 'center')).toBe(50)
    
    // right align
    expect(calculateTextX(0, 100, 'right')).toBe(95)
  })
})
```

**æµ‹è¯•è¦†ç›–ç›®æ ‡**:
- [ ] æ ·å¼è®¾ç½®ä¸è·å–ï¼ˆ100%ï¼‰
- [ ] æ ·å¼åˆå¹¶é€»è¾‘ï¼ˆ100%ï¼‰
- [ ] æ‰¹é‡æ ·å¼è®¾ç½®ï¼ˆ100%ï¼‰
- [ ] æ ·å¼æ¸…é™¤åŠŸèƒ½ï¼ˆ100%ï¼‰
- [ ] å­—ä½“å­—ç¬¦ä¸²æ„å»ºï¼ˆ100%ï¼‰
- [ ] æ–‡æœ¬å¯¹é½è®¡ç®—ï¼ˆ100%ï¼‰
- [ ] ä¸‹åˆ’çº¿/åˆ é™¤çº¿ç»˜åˆ¶ï¼ˆ80%ï¼‰
- [ ] è‡ªåŠ¨æ¢è¡Œé€»è¾‘ï¼ˆ80%ï¼‰

---

#### 5.2 æ€§èƒ½ä¼˜åŒ–
**ä¼˜åŒ–ç›®æ ‡**:
- [ ] æ ·å¼æŸ¥è¯¢ä¼˜åŒ–ï¼ˆä½¿ç”¨ Map ç¼“å­˜ï¼‰
- [ ] å­—ä½“å­—ç¬¦ä¸²ç¼“å­˜ï¼ˆé¿å…é‡å¤æ„å»ºï¼‰
- [ ] æ–‡æœ¬æµ‹é‡ç¼“å­˜ï¼ˆmeasureText ç»“æœï¼‰
- [ ] å‡å°‘ Canvas çŠ¶æ€åˆ‡æ¢
- [ ] æ‰¹é‡ç»˜åˆ¶ä¼˜åŒ–ï¼ˆç›¸åŒæ ·å¼åˆå¹¶ï¼‰

**æ€§èƒ½æŒ‡æ ‡**:
- 1000 ä¸ªæ ·å¼å•å…ƒæ ¼æ¸²æŸ“: < 50ms
- æ ·å¼è®¾ç½®å“åº”: < 5ms
- å†…å­˜å ç”¨: < 10MB (1000 ä¸ªæ ·å¼å•å…ƒæ ¼)

---

#### 5.3 æ‰‹åŠ¨æµ‹è¯•åœºæ™¯
**æ–‡ä»¶**: `docs/manual-tests/cell-styles-test.md`

**æµ‹è¯•åœºæ™¯**:
1. **åŸºç¡€æ ·å¼æµ‹è¯•**
   - [ ] è®¾ç½®ä¸åŒå­—ä½“ï¼ŒéªŒè¯æ˜¾ç¤º
   - [ ] è®¾ç½®ä¸åŒå­—å·ï¼ŒéªŒè¯å¤§å°
   - [ ] åˆ‡æ¢ç²—ä½“ã€æ–œä½“ã€ä¸‹åˆ’çº¿ã€åˆ é™¤çº¿
   - [ ] ä¿®æ”¹å­—ä½“é¢œè‰²å’ŒèƒŒæ™¯è‰²

2. **å¯¹é½æµ‹è¯•**
   - [ ] å·¦å¯¹é½ã€å±…ä¸­ã€å³å¯¹é½
   - [ ] é¡¶éƒ¨å¯¹é½ã€å±…ä¸­å¯¹é½ã€åº•éƒ¨å¯¹é½
   - [ ] ç»„åˆå¯¹é½ï¼ˆå·¦ä¸Šã€å³ä¸‹ç­‰ï¼‰

3. **é«˜çº§åŠŸèƒ½æµ‹è¯•**
   - [ ] è‡ªåŠ¨æ¢è¡Œï¼ˆé•¿æ–‡æœ¬ï¼‰
   - [ ] æ–‡å­—æ—‹è½¬ï¼ˆ45Â°ã€90Â°ç­‰ï¼‰
   - [ ] åŒä¸‹åˆ’çº¿æ˜¾ç¤º

4. **æ‰¹é‡æ“ä½œæµ‹è¯•**
   - [ ] é€‰ä¸­å¤šä¸ªå•å…ƒæ ¼æ‰¹é‡è®¾ç½®æ ·å¼
   - [ ] æ’¤é”€/é‡åšæ‰¹é‡æ ·å¼æ“ä½œ

5. **è¾¹ç•Œæƒ…å†µæµ‹è¯•**
   - [ ] ç©ºå•å…ƒæ ¼è®¾ç½®æ ·å¼
   - [ ] æ ·å¼ä¸å…¬å¼å…±å­˜
   - [ ] æ ·å¼ä¸åˆå¹¶å•å…ƒæ ¼ï¼ˆé¢„ç•™ï¼‰

---

## ğŸ“Š å¼€å‘è¿›åº¦è·Ÿè¸ª

### æ€»ä½“è¿›åº¦
```
é˜¶æ®µ 1: æ•°æ®ç»“æ„     â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘ 40%  â³ è¿›è¡Œä¸­
é˜¶æ®µ 2: æ¸²æŸ“å®ç°     â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  0%  â³ æœªå¼€å§‹
é˜¶æ®µ 3: API é›†æˆ     â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  0%  â³ æœªå¼€å§‹
é˜¶æ®µ 4: UI ç»„ä»¶      â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  0%  â³ æœªå¼€å§‹
é˜¶æ®µ 5: æµ‹è¯•ä¼˜åŒ–     â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  0%  â³ æœªå¼€å§‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»ä½“å®Œæˆåº¦          â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘ 8%   â³ Day 0/5
```

### æ¯æ—¥è®¡åˆ’

#### Day 1 (2025-11-26)
**ç›®æ ‡**: å®Œæˆé˜¶æ®µ 1 - æ•°æ®ç»“æ„
- [ ] å®šä¹‰ CellStyle æ¥å£å’Œç±»å‹
- [ ] æ‰©å±• SheetModel æ·»åŠ æ ·å¼å­˜å‚¨
- [ ] å®ç°åŸºç¡€æ ·å¼ API (set/get/clear)
- [ ] ç¼–å†™åŸºç¡€å•å…ƒæµ‹è¯•

#### Day 2 (2025-11-27)
**ç›®æ ‡**: å®Œæˆé˜¶æ®µ 2.1 - åŸºç¡€æ¸²æŸ“
- [ ] å®ç°å­—ä½“æ ·å¼æ¸²æŸ“ï¼ˆå­—ä½“ã€å­—å·ã€é¢œè‰²ï¼‰
- [ ] å®ç°æ–‡æœ¬è£…é¥°ï¼ˆç²—ä½“ã€æ–œä½“ã€ä¸‹åˆ’çº¿ã€åˆ é™¤çº¿ï¼‰
- [ ] å®ç°åŸºç¡€å¯¹é½ï¼ˆæ°´å¹³ã€å‚ç›´ï¼‰
- [ ] æµ‹è¯•åŸºç¡€æ¸²æŸ“æ•ˆæœ

#### Day 3 (2025-11-28)
**ç›®æ ‡**: å®Œæˆé˜¶æ®µ 2.2 - é«˜çº§æ¸²æŸ“
- [ ] å®ç°èƒŒæ™¯è‰²æ¸²æŸ“
- [ ] å®ç°è‡ªåŠ¨æ¢è¡Œ
- [ ] å®ç°æ–‡å­—æ—‹è½¬
- [ ] ä¼˜åŒ–æ¸²æŸ“æ€§èƒ½

#### Day 4 (2025-11-29)
**ç›®æ ‡**: å®Œæˆé˜¶æ®µ 3 & 4 - API ä¸ UI
- [ ] æ‰©å±•å…¬å…± API
- [ ] é›†æˆæ’¤é”€é‡åš
- [ ] åˆ›å»ºæ ·å¼å·¥å…·æ ç»„ä»¶
- [ ] å®ç°å¿«æ·é”®æ”¯æŒ

#### Day 5 (2025-11-30)
**ç›®æ ‡**: å®Œæˆé˜¶æ®µ 5 - æµ‹è¯•ä¸ä¼˜åŒ–
- [ ] å®Œå–„å•å…ƒæµ‹è¯•ï¼ˆè¦†ç›–ç‡ > 80%ï¼‰
- [ ] æ€§èƒ½ä¼˜åŒ–å’Œæµ‹è¯•
- [ ] æ‰‹åŠ¨æµ‹è¯•æ‰€æœ‰åœºæ™¯
- [ ] æ–‡æ¡£å®Œå–„å’Œä»£ç å®¡æŸ¥

---

## ğŸ¯ éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½å®Œæ•´æ€§ âœ…
- [ ] 12 ä¸ªæ ¸å¿ƒæ ·å¼å±æ€§å…¨éƒ¨å®ç°
- [ ] æ ·å¼æ­£ç¡®æ¸²æŸ“åˆ° Canvas
- [ ] æ ·å¼å¯ä»¥æŒä¹…åŒ–ä¿å­˜
- [ ] æ’¤é”€é‡åšåŠŸèƒ½æ­£å¸¸

### æ€§èƒ½æŒ‡æ ‡ âš¡
- [ ] 1000 ä¸ªæ ·å¼å•å…ƒæ ¼æ¸²æŸ“ < 50ms
- [ ] æ ·å¼è®¾ç½®å“åº” < 5ms
- [ ] æ— æ˜æ˜¾å¡é¡¿æˆ–å»¶è¿Ÿ

### ä»£ç è´¨é‡ ğŸ“
- [ ] TypeScript ç±»å‹å®šä¹‰å®Œæ•´
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] ä»£ç é€šè¿‡ ESLint æ£€æŸ¥
- [ ] å‡½æ•°æ³¨é‡Šå®Œæ•´

### ç”¨æˆ·ä½“éªŒ ğŸ¨
- [ ] å·¥å…·æ æ“ä½œæµç•…
- [ ] å¿«æ·é”®å“åº”åŠæ—¶
- [ ] æ ·å¼é¢„è§ˆå‡†ç¡®
- [ ] æ— æ˜æ˜¾ Bug

---

## ğŸ“š å‚è€ƒèµ„æ–™

### Canvas API æ–‡æ¡£
- [MDN - CanvasRenderingContext2D.font](https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/font)
- [MDN - CanvasRenderingContext2D.textAlign](https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/textAlign)
- [MDN - CanvasRenderingContext2D.textBaseline](https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/textBaseline)

### Excel æ ·å¼å‚è€ƒ
- [Excel å•å…ƒæ ¼æ ¼å¼](https://support.microsoft.com/zh-cn/office/)
- [SheetJS æ ·å¼å¤„ç†](https://docs.sheetjs.com/docs/csf/features/styles)

### é¡¹ç›®å†…éƒ¨æ–‡æ¡£
- [docs/ARCHITECTURE.md](../ARCHITECTURE.md) - æ¶æ„è®¾è®¡
- [docs/API_REFERENCE.md](../API_REFERENCE.md) - API å‚è€ƒ
- [docs/TODO.md](./TODO.md) - å®Œæ•´ä»»åŠ¡åˆ—è¡¨

---

## ğŸ› å·²çŸ¥é—®é¢˜ä¸æ³¨æ„äº‹é¡¹

### æŠ€æœ¯é™åˆ¶
1. **Canvas æ–‡æœ¬æ¸²æŸ“é™åˆ¶**
   - Canvas ä¸æ”¯æŒåŸç”Ÿçš„åŒä¸‹åˆ’çº¿ï¼Œéœ€è¦æ‰‹åŠ¨ç»˜åˆ¶
   - æ–‡å­—æ—‹è½¬éœ€è¦ä½¿ç”¨ transformï¼Œå½±å“æ€§èƒ½
   - è‡ªåŠ¨æ¢è¡Œéœ€è¦æ‰‹åŠ¨è®¡ç®—è¡Œé«˜

2. **å­—ä½“åŠ è½½**
   - è‡ªå®šä¹‰å­—ä½“éœ€è¦æå‰åŠ è½½
   - å­—ä½“æœªåŠ è½½å®Œæˆæ—¶å¯èƒ½æ˜¾ç¤ºå¼‚å¸¸

3. **æ€§èƒ½è€ƒè™‘**
   - å¤§é‡ä¸åŒæ ·å¼ä¼šå¢åŠ æ¸²æŸ“æ—¶é—´
   - éœ€è¦ä¼˜åŒ–ç›¸åŒæ ·å¼çš„æ‰¹é‡ç»˜åˆ¶

### åç»­ä¼˜åŒ–æ–¹å‘
- [ ] æ ·å¼é¢„è®¾æ¨¡æ¿ï¼ˆå¿«é€Ÿåº”ç”¨å¸¸ç”¨æ ·å¼ç»„åˆï¼‰
- [ ] æ ·å¼å¤åˆ¶ç²˜è´´ï¼ˆæ ¼å¼åˆ·ï¼ŒP1.7 å®ç°ï¼‰
- [ ] æ ·å¼æ¡ä»¶æ ¼å¼ï¼ˆP3.12 å®ç°ï¼‰
- [ ] æ ·å¼æœç´¢æ›¿æ¢

---

## âœ… å®Œæˆæ ‡å¿—

å½“ä»¥ä¸‹æ‰€æœ‰é¡¹å®Œæˆæ—¶ï¼ŒP0.1 å•å…ƒæ ¼æ ·å¼å¼€å‘å®Œæˆï¼š

1. âœ… æ‰€æœ‰ 12 ä¸ªæ ·å¼å±æ€§å®ç°å¹¶æµ‹è¯•é€šè¿‡
2. âœ… å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
3. âœ… æ€§èƒ½æµ‹è¯•è¾¾æ ‡
4. âœ… æ‰‹åŠ¨æµ‹è¯•åœºæ™¯å…¨éƒ¨é€šè¿‡
5. âœ… å·¥å…·æ ç»„ä»¶å®Œæˆå¹¶é›†æˆ
6. âœ… æ–‡æ¡£æ›´æ–°ï¼ˆAPIã€ä½¿ç”¨è¯´æ˜ï¼‰
7. âœ… ä»£ç å®¡æŸ¥é€šè¿‡
8. âœ… Git æäº¤å¹¶æ¨é€

---

**æ–‡æ¡£åˆ›å»ºæ—¥æœŸ**: 2025-11-26  
**é¢„è®¡å®Œæˆæ—¥æœŸ**: 2025-11-30  
**è´Ÿè´£äºº**: AI + å¼€å‘è€…  
**å½“å‰çŠ¶æ€**: ğŸŸ¡ å‡†å¤‡é˜¶æ®µï¼Œç­‰å¾…å¼€å§‹å¼€å‘
