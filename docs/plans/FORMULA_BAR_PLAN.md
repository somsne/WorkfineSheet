# 公式栏 (Formula Bar) 功能分析与开发计划

## 📋 Excel 公式栏功能概述

Excel 公式栏是位于工作表顶部的关键组件，主要分为三个区域：

```
┌─────────────┬─────────┬───────────────────────────────────────────────────────┐
│  名称框     │  ✓  ✗   │  公式输入区                                           │
│  (A1)       │         │  =SUM(A1:A10)                                         │
└─────────────┴─────────┴───────────────────────────────────────────────────────┘
```

---

## 🎯 核心功能清单

### 1. 名称框 (Name Box)

| 功能 | 说明 | 优先级 |
|------|------|--------|
| 显示当前地址 | 单选显示 `A1`，范围选择显示 `A1:B5` | P0 |
| 点击选中全部 | 点击名称框，内容被选中，可输入 | P0 |
| 跳转到单元格 | 输入 `D10` 回车，跳转到 D10 | P0 |
| 选择范围 | 输入 `A1:C10` 回车，选中该范围 | P1 |
| 合并单元格显示 | 选中合并区域时显示左上角地址 | P1 |

### 2. 操作按钮区

| 功能 | 说明 | 优先级 |
|------|------|--------|
| ✓ 确认按钮 | 编辑时显示，确认输入（等同 Enter） | P1 |
| ✗ 取消按钮 | 编辑时显示，取消输入（等同 Esc） | P1 |

### 3. 公式输入区 (Formula Input)

| 功能 | 说明 | 优先级 |
|------|------|--------|
| 显示单元格内容 | 公式显示公式，普通值显示值 | P0 |
| 同步编辑 | 与单元格内编辑同步，双向绑定 | P0 |
| 公式着色 | 公式中的引用显示不同颜色 | P0 |
| 单元格引用插入 | 编辑公式时点击单元格插入引用 | P0 |
| 引用高亮 | 编辑公式时，被引用单元格显示彩色边框 | P0 |
| 可展开 | 拖拽下边缘可扩大输入区高度 | P1 |
| 自动完成 | 输入函数名时显示提示 | P2 |
| 函数提示 | 输入函数后显示参数提示 | P2 |

### 4. 交互行为

| 功能 | 说明 | 优先级 |
|------|------|--------|
| 点击公式栏进入编辑 | 等同双击单元格 | P0 |
| Enter 确认 | 确认输入，移动到下一单元格 | P0 |
| Esc 取消 | 取消编辑，恢复原值 | P0 |
| Tab 切换 | 确认并移动到右侧单元格 | P1 |
| F2 编辑模式 | 从公式栏切换到单元格内编辑 | P1 |
| 与单元格编辑互斥 | 同一时间只能有一个编辑活动 | P0 |

---

## 🏗️ 架构设计

### 组件结构

```
FormulaBar.vue
├── NameBox (名称框区域)
├── ActionButtons (操作按钮区：✓ ✗)
└── FormulaInput (公式输入组件，可复用 RichTextInput)
```

### 数据流设计

```
┌─────────────────────────────────────────────────────────────────┐
│                      WorkbookSheet.vue                          │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    FormulaBar.vue                       │    │
│  │  ┌──────────┐  ┌────┐  ┌───────────────────────────┐   │    │
│  │  │ NameBox  │  │ ✓✗ │  │      FormulaInput        │   │    │
│  │  │  (A1)    │  │    │  │  =SUM(Sheet1!A1:A10)     │   │    │
│  │  └────┬─────┘  └────┘  └───────────┬───────────────┘   │    │
│  └───────┼──────────────────────────────┼─────────────────┘    │
│          │                              │                       │
│          │ @navigate                    │ @input / @save        │
│          ▼                              ▼                       │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    CanvasSheet.vue                      │    │
│  │   - selection (当前选区)                                │    │
│  │   - editingCell (当前编辑单元格)                        │    │
│  │   - formulaMode (是否公式模式)                          │    │
│  │   - RichTextInput (单元格内编辑器)                      │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

### 状态同步策略

```typescript
// 公式栏与单元格编辑器共享状态
interface FormulaBarState {
  // 显示状态
  currentAddress: string        // 名称框显示的地址 "A1" 或 "A1:B5"
  displayValue: string          // 公式栏显示的内容
  
  // 编辑状态
  isEditing: boolean            // 是否处于编辑状态
  editingSource: 'cell' | 'formulaBar' | null  // 编辑来源
  editValue: string             // 当前编辑的值
  
  // 公式模式
  isFormulaMode: boolean        // 是否公式模式
  formulaReferences: FormulaReference[]  // 公式引用列表
}
```

---

## 📅 开发计划

### Phase 1: 基础框架 (2-3天)

**目标：** 实现公式栏的基本结构和显示功能

1. **创建 FormulaBar.vue 组件**
   - 三栏布局（名称框 + 按钮区 + 输入区）
   - 响应式宽度，输入区自适应
   - Excel 风格样式（灰色背景、边框）

2. **名称框基础功能**
   - 显示当前选中单元格地址
   - 范围选择时显示 `A1:B5` 格式
   - 点击选中文本

3. **公式输入区基础功能**
   - 显示当前单元格内容（公式显示公式本身）
   - 只读模式（Phase 1 不支持编辑）

4. **集成到 WorkbookSheet**
   - 在 CanvasSheet 上方添加 FormulaBar
   - 传递 selection 和 cellValue 数据

### Phase 2: 编辑同步 (2-3天)

**目标：** 实现公式栏与单元格编辑的双向同步

1. **公式栏点击进入编辑**
   - 点击公式输入区激活编辑模式
   - 光标定位到点击位置

2. **双向同步机制**
   - 公式栏编辑 → 单元格编辑框同步
   - 单元格编辑 → 公式栏同步
   - 使用共享的 editValue 状态

3. **确认/取消按钮**
   - 编辑时显示 ✓ ✗ 按钮
   - 非编辑时隐藏

4. **键盘事件处理**
   - Enter 确认
   - Esc 取消
   - Tab 移动

### Phase 3: 公式增强 (2天)

**目标：** 公式编辑体验优化

1. **公式引用着色**
   - 复用 RichTextInput 的着色逻辑
   - 引用显示不同颜色

2. **点击插入引用**
   - 公式模式下点击单元格插入引用
   - 复用现有的 insertCellReference 逻辑

3. **引用单元格高亮**
   - 在 Canvas 上绘制彩色边框
   - 复用现有的 formulaReferences 渲染

### Phase 4: 名称框增强 (1-2天)

**目标：** 名称框导航功能

1. **跳转功能**
   - 输入单元格地址回车跳转
   - 输入范围回车选中

2. **输入验证**
   - 验证输入的地址格式
   - 无效输入时显示错误提示

### Phase 5: 高级功能 (可选)

**目标：** 进阶功能，按需实现

1. **公式栏展开**
   - 拖拽调整高度
   - 多行公式显示

2. **函数自动完成**
   - 输入时显示函数列表
   - 上下键选择，Tab 补全

3. **函数参数提示**
   - 输入函数括号后显示参数提示
   - 高亮当前参数位置

---

## 🎨 UI 设计参考

```
公式栏高度: 26px (与标签栏一致)
名称框宽度: 80px (固定)
按钮区宽度: 50px (固定，包含 ✓ + ✗)
输入区: 自适应剩余宽度

颜色方案 (浅色模式):
- 背景: #f3f3f3
- 边框: #d4d4d4
- 名称框背景: #ffffff
- 分隔线: #d4d4d4

颜色方案 (深色模式):
- 背景: #2d2d2d
- 边框: #404040
- 名称框背景: #3a3a3a
- 分隔线: #505050
```

---

## ⚠️ 技术难点与解决方案

| 难点 | 解决方案 |
|------|----------|
| 公式栏与单元格编辑器同步 | 使用共享状态 + 事件通信，避免循环更新 |
| 编辑焦点管理 | 统一管理焦点状态，编辑源标记区分 |
| 公式模式下的引用插入 | 复用现有 RichTextInput 的 insertCellReference |
| 公式着色同步 | 监听内容变化，统一解析引用并着色 |
| 滚动时地址更新 | 仅在选区变化时更新，非滚动事件 |

---

## 📊 工作量估算

| 阶段 | 工作量 | 累计 |
|------|--------|------|
| Phase 1: 基础框架 | 2-3天 | 2-3天 |
| Phase 2: 编辑同步 | 2-3天 | 4-6天 |
| Phase 3: 公式增强 | 2天 | 6-8天 |
| Phase 4: 名称框增强 | 1-2天 | 7-10天 |
| Phase 5: 高级功能 | 3-5天 (可选) | 10-15天 |

**建议：** 先完成 Phase 1-3，达到基本可用状态，后续按需迭代。

---

## 📁 相关文件

```
src/components/
├── FormulaBar.vue          # 公式栏组件（新增）
├── RichTextInput.vue       # 富文本编辑器（复用）
├── CanvasSheet.vue         # 画布组件（需修改）
└── WorkbookSheet.vue       # 工作簿组件（需修改）

src/components/sheet/
└── references.ts           # 公式引用解析（复用）
```
