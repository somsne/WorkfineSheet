<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>æ’å…¥è¡Œåç›¸å¯¹å¼•ç”¨è®¡ç®— Bug æµ‹è¯•</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-case {
      background: white;
      padding: 20px;
      margin: 10px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h2 { color: #2c3e50; margin-top: 0; }
    button {
      padding: 10px 20px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover { background: #2980b9; }
    .result { margin-top: 10px; }
    .pass { color: #27ae60; font-weight: bold; }
    .fail { color: #e74c3c; font-weight: bold; }
    table {
      border-collapse: collapse;
      margin: 10px 0;
      width: 100%;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th { background: #3498db; color: white; }
    .formula { background: #e8f5e9; }
  </style>
</head>
<body>
  <h1>ğŸ› æ’å…¥è¡Œåç›¸å¯¹å¼•ç”¨è®¡ç®— Bug æµ‹è¯•</h1>

  <div class="test-case">
    <h2>æµ‹è¯•åœºæ™¯</h2>
    <p>
      <strong>åˆå§‹çŠ¶æ€ï¼š</strong><br>
      A1 = 10<br>
      A2 = 20<br>
      A3 = =A1+A2 (ç›¸å¯¹å¼•ç”¨ï¼Œç»“æœåº”ä¸º 30)
    </p>
    <p>
      <strong>æ“ä½œï¼š</strong>åœ¨ç¬¬ 1 è¡Œå‰æ’å…¥ 1 è¡Œ
    </p>
    <p>
      <strong>é¢„æœŸç»“æœï¼š</strong><br>
      A1 = (ç©º)<br>
      A2 = 10 (åŸ A1)<br>
      A3 = 20 (åŸ A2)<br>
      A4 = =A2+A3 (åŸ A3ï¼Œå…¬å¼è°ƒæ•´ï¼Œç»“æœåº”ä¸º 30)
    </p>
    <button onclick="runTest()">è¿è¡Œæµ‹è¯•</button>
    <div id="result" class="result"></div>
  </div>

  <script type="module">
    import { SheetModel } from './src/lib/SheetModel.js'
    import { FormulaSheet } from './src/lib/FormulaSheet.js'

    window.runTest = function() {
      const model = new SheetModel()
      const sheet = new FormulaSheet(model, false)  // ç¦ç”¨å¼‚æ­¥

      console.log('=== åˆå§‹åŒ–æ•°æ® ===')
      sheet.setValue(0, 0, '10')   // A1 = 10
      sheet.setValue(1, 0, '20')   // A2 = 20
      sheet.setValue(2, 0, '=A1+A2')  // A3 = =A1+A2

      console.log('A1:', sheet.getValue(0, 0))
      console.log('A2:', sheet.getValue(1, 0))
      console.log('A3 å…¬å¼:', sheet.getDisplayValue(2, 0))
      console.log('A3 è®¡ç®—å€¼:', sheet.getValue(2, 0))

      const before_A3_formula = sheet.getDisplayValue(2, 0)
      const before_A3_value = sheet.getValue(2, 0)

      console.log('=== æ’å…¥ç¬¬ 1 è¡Œ ===')
      
      // ç¬¬ä¸€æ­¥ï¼šè°ƒæ•´å…¬å¼ï¼ˆä¼šè‡ªåŠ¨ç§»åŠ¨å…¬å¼å•å…ƒæ ¼ï¼‰
      sheet.adjustAllFormulas('insertRow', 0, 1)
      
      // ç¬¬äºŒæ­¥ï¼šç§»åŠ¨éå…¬å¼å•å…ƒæ ¼æ•°æ®ï¼ˆæ¨¡æ‹Ÿ CanvasSheet çš„è¡Œä¸ºï¼‰
      const cellsToMove = []
      model.forEach((r, c, cell) => {
        if (r >= 0 && !cell.formulaMetadata) {
          cellsToMove.push({ row: r, col: c, value: cell.value })
        }
      })
      
      // ä»åå¾€å‰ç§»åŠ¨ï¼Œé¿å…è¦†ç›–
      cellsToMove.sort((a, b) => b.row - a.row)
      cellsToMove.forEach(({ row: r, col: c, value }) => {
        model.setValue(r, c, '')  // æ¸…ç©ºæ—§ä½ç½®
        model.setValue(r + 1, c, value)  // ç§»åŠ¨åˆ°æ–°ä½ç½®
      })

      console.log('æ’å…¥åçš„æ•°æ®:')
      console.log('A1:', sheet.getValue(0, 0))
      console.log('A2:', sheet.getValue(1, 0))
      console.log('A3:', sheet.getValue(2, 0))
      console.log('A4 å…¬å¼:', sheet.getDisplayValue(3, 0))
      console.log('A4 è®¡ç®—å€¼:', sheet.getValue(3, 0))

      const after_A4_formula = sheet.getDisplayValue(3, 0)
      const after_A4_value = sheet.getValue(3, 0)

      // éªŒè¯
      const formula_correct = after_A4_formula === '=A2+A3'
      const value_correct = after_A4_value === 30

      // è°ƒè¯•ï¼šæ£€æŸ¥å…ƒæ•°æ®
      const cell = model.getCell(3, 0)
      console.log('A4 å•å…ƒæ ¼å…ƒæ•°æ®:', cell.formulaMetadata)

      let html = '<h3>æµ‹è¯•ç»“æœ</h3>'
      html += '<table>'
      html += '<tr><th>é¡¹ç›®</th><th>é¢„æœŸ</th><th>å®é™…</th><th>ç»“æœ</th></tr>'
      html += `<tr><td>æ’å…¥å‰ A3 å…¬å¼</td><td>=A1+A2</td><td class="formula">${before_A3_formula}</td><td class="pass">âœ…</td></tr>`
      html += `<tr><td>æ’å…¥å‰ A3 è®¡ç®—å€¼</td><td>30</td><td>${before_A3_value}</td><td class="${before_A3_value === 30 ? 'pass' : 'fail'}">${before_A3_value === 30 ? 'âœ…' : 'âŒ'}</td></tr>`
      html += `<tr><td>æ’å…¥å A4 å…¬å¼</td><td>=A2+A3</td><td class="formula">${after_A4_formula}</td><td class="${formula_correct ? 'pass' : 'fail'}">${formula_correct ? 'âœ…' : 'âŒ'}</td></tr>`
      html += `<tr><td>æ’å…¥å A4 è®¡ç®—å€¼</td><td>30</td><td>${after_A4_value}</td><td class="${value_correct ? 'pass' : 'fail'}">${value_correct ? 'âœ…' : 'âŒ'}</td></tr>`
      html += '</table>'

      if (formula_correct && value_correct) {
        html += '<p class="pass">âœ… æµ‹è¯•é€šè¿‡ï¼ç›¸å¯¹å¼•ç”¨è®¡ç®—æ­£ç¡®ã€‚</p>'
      } else {
        html += '<p class="fail">âŒ æµ‹è¯•å¤±è´¥ï¼</p>'
        if (formula_correct && !value_correct) {
          html += '<p>å…¬å¼å†…å®¹æ­£ç¡®ï¼Œä½†è®¡ç®—å€¼é”™è¯¯ã€‚è¿™è¯´æ˜å…¬å¼å…ƒæ•°æ®å¯èƒ½æœ‰é—®é¢˜ã€‚</p>'
        }
      }

      html += '<h3>è°ƒè¯•ä¿¡æ¯</h3>'
      html += '<pre>' + JSON.stringify({
        'A4 å…ƒæ•°æ®': cell.formulaMetadata,
        'A2 å€¼': sheet.getValue(1, 0),
        'A3 å€¼': sheet.getValue(2, 0)
      }, null, 2) + '</pre>'

      document.getElementById('result').innerHTML = html
    }
  </script>
</body>
</html>
