<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Excel å…¬å¼æ€§èƒ½æµ‹è¯•</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
      background: #f5f5f5;
    }
    h1 {
      color: #2c3e50;
      border-bottom: 3px solid #3498db;
      padding-bottom: 10px;
    }
    .test-section {
      margin: 20px 0;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .test-section h2 {
      margin-top: 0;
      color: #3498db;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .test-section h2::before {
      content: 'âš¡';
      font-size: 24px;
    }
    .controls {
      display: flex;
      gap: 10px;
      margin: 15px 0;
      flex-wrap: wrap;
    }
    button {
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    button:active {
      transform: translateY(0);
    }
    button.run-all {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    .result {
      margin-top: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-left: 4px solid #3498db;
      border-radius: 4px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
    }
    .metric {
      display: inline-block;
      padding: 4px 8px;
      margin: 2px;
      background: #e3f2fd;
      border-radius: 4px;
      font-weight: 600;
    }
    .metric.fast {
      background: #c8e6c9;
      color: #2e7d32;
    }
    .metric.medium {
      background: #fff9c4;
      color: #f57c00;
    }
    .metric.slow {
      background: #ffcdd2;
      color: #c62828;
    }
    .summary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }
    .summary h3 {
      margin-top: 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
      background: white;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }
    th {
      background: #3498db;
      color: white;
      font-weight: 600;
    }
    tr:hover {
      background: #f5f5f5;
    }
    .progress {
      width: 100%;
      height: 6px;
      background: #e0e0e0;
      border-radius: 3px;
      overflow: hidden;
      margin: 10px 0;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      width: 0%;
      transition: width 0.3s ease;
    }
    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .badge.success { background: #4caf50; color: white; }
    .badge.warning { background: #ff9800; color: white; }
    .badge.error { background: #f44336; color: white; }
  </style>
</head>
<body>
  <h1>ğŸ“Š Excel å…¬å¼æ€§èƒ½æµ‹è¯•å¥—ä»¶</h1>
  
  <div class="controls">
    <button class="run-all" onclick="runAllTests()">ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
    <button onclick="clearResults()">ğŸ—‘ï¸ æ¸…é™¤ç»“æœ</button>
  </div>

  <div class="progress" id="globalProgress">
    <div class="progress-bar" id="globalProgressBar"></div>
  </div>

  <div class="test-section">
    <h2>æµ‹è¯• 1: å¤§é‡å…¬å¼åˆ›å»ºæ€§èƒ½</h2>
    <p>åˆ›å»ºå…¬å¼å•å…ƒæ ¼ï¼Œæµ‹è¯•è§£æå’Œå­˜å‚¨å…ƒæ•°æ®çš„æ€§èƒ½</p>
    <div class="controls">
      <button onclick="test1(100)">100 ä¸ªå…¬å¼</button>
      <button onclick="test1(500)">500 ä¸ªå…¬å¼</button>
      <button onclick="test1(1000)">1000 ä¸ªå…¬å¼</button>
      <button onclick="test1(5000)">5000 ä¸ªå…¬å¼</button>
      <button onclick="test1(10000)">10000 ä¸ªå…¬å¼</button>
      <button onclick="test1(100000)" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">ğŸ”¥ 100K ä¸ªå…¬å¼</button>
      <button onclick="test1(1000000)" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">âš¡ 1M ä¸ªå…¬å¼</button>
    </div>
    <div id="result1" class="result"></div>
  </div>

  <div class="test-section">
    <h2>æµ‹è¯• 2: æ’å…¥è¡Œåˆ—æ€§èƒ½</h2>
    <p>åœ¨åŒ…å«å¤§é‡å…¬å¼çš„è¡¨æ ¼ä¸­æ’å…¥è¡Œåˆ—ï¼Œæµ‹è¯•å¼•ç”¨è°ƒæ•´æ€§èƒ½</p>
    <div class="controls">
      <button onclick="test2(100, 10)">100 å…¬å¼ / 10 è¡Œ</button>
      <button onclick="test2(500, 10)">500 å…¬å¼ / 10 è¡Œ</button>
      <button onclick="test2(1000, 10)">1000 å…¬å¼ / 10 è¡Œ</button>
      <button onclick="test2(1000, 50)">1000 å…¬å¼ / 50 è¡Œ</button>
      <button onclick="test2(5000, 100)">5000 å…¬å¼ / 100 è¡Œ</button>
      <button onclick="test2(10000, 1000)" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">ğŸ”¥ 10K å…¬å¼ / 1K è¡Œ</button>
      <button onclick="test2(100000, 50000)" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">âš¡ 100K å…¬å¼ / 50K è¡Œ</button>
    </div>
    <div id="result2" class="result"></div>
  </div>

  <div class="test-section">
    <h2>æµ‹è¯• 2B: æ’å…¥åˆ—æ€§èƒ½ï¼ˆæé™æµ‹è¯•ï¼‰</h2>
    <p>æµ‹è¯•å¤§é‡åˆ—æ’å…¥æ“ä½œçš„æ€§èƒ½</p>
    <div class="controls">
      <button onclick="test2b(1000, 10)">1000 å…¬å¼ / 10 åˆ—</button>
      <button onclick="test2b(1000, 50)">1000 å…¬å¼ / 50 åˆ—</button>
      <button onclick="test2b(5000, 100)">5000 å…¬å¼ / 100 åˆ—</button>
      <button onclick="test2b(10000, 500)" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">âš¡ 10K å…¬å¼ / 500 åˆ—</button>
    </div>
    <div id="result2b" class="result"></div>
  </div>

  <div class="test-section">
    <h2>æµ‹è¯• 3: å¤åˆ¶ç²˜è´´æ€§èƒ½</h2>
    <p>å¤åˆ¶åŒ…å«å…¬å¼çš„åŒºåŸŸï¼Œæµ‹è¯•åŸºäºå…ƒæ•°æ®é‡å»ºçš„æ€§èƒ½</p>
    <div class="controls">
      <button onclick="test3(10, 10)">10x10 åŒºåŸŸ</button>
      <button onclick="test3(20, 20)">20x20 åŒºåŸŸ</button>
      <button onclick="test3(50, 50)">50x50 åŒºåŸŸ</button>
      <button onclick="test3(100, 100)">100x100 åŒºåŸŸ</button>
    </div>
    <div id="result3" class="result"></div>
  </div>

  <div class="test-section">
    <h2>æµ‹è¯• 4: å…¬å¼è®¡ç®—æ€§èƒ½</h2>
    <p>æµ‹è¯•åŒ…å«åµŒå¥—å…¬å¼çš„è®¡ç®—æ€§èƒ½å’Œç¼“å­˜æ•ˆæœ</p>
    <div class="controls">
      <button onclick="test4(100)">100 ä¸ªå…¬å¼</button>
      <button onclick="test4(500)">500 ä¸ªå…¬å¼</button>
      <button onclick="test4(1000)">1000 ä¸ªå…¬å¼</button>
    </div>
    <div id="result4" class="result"></div>
  </div>

  <div class="test-section">
    <h2>æµ‹è¯• 5: å¤æ‚å…¬å¼å¤„ç†</h2>
    <p>æµ‹è¯•åŒ…å«èŒƒå›´å¼•ç”¨ã€æ··åˆå¼•ç”¨çš„å¤æ‚å…¬å¼</p>
    <div class="controls">
      <button onclick="test5()">åŸºç¡€å¤æ‚å…¬å¼</button>
      <button onclick="test5Nested(10)">10å±‚åµŒå¥—</button>
      <button onclick="test5Nested(20)">20å±‚åµŒå¥—</button>
      <button onclick="test5Nested(50)" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">âš¡ 50å±‚åµŒå¥—</button>
    </div>
    <div id="result5" class="result"></div>
  </div>

  <div class="test-section">
    <h2>æµ‹è¯• 6: å†…å­˜å ç”¨åˆ†æ</h2>
    <p>åˆ†æå…¬å¼å…ƒæ•°æ®çš„å†…å­˜å ç”¨æƒ…å†µ</p>
    <div class="controls">
      <button onclick="test6()">è¿è¡Œæµ‹è¯•</button>
    </div>
    <div id="result6" class="result"></div>
  </div>

  <div id="summary" class="summary" style="display: none;">
    <h3>ğŸ“ˆ æµ‹è¯•æ€»ç»“</h3>
    <div id="summaryContent"></div>
  </div>

  <script type="module">
    import { SheetModel } from './src/lib/SheetModel.js'
    import { FormulaSheet } from './src/lib/FormulaSheet.js'
    import { FormulaMetadataParser } from './src/lib/FormulaMetadata.js'

    window.SheetModel = SheetModel
    window.FormulaSheet = FormulaSheet
    window.FormulaMetadataParser = FormulaMetadataParser

    const testResults = []

    function formatTime(ms) {
      if (ms < 1) return `${(ms * 1000).toFixed(2)} Î¼s`
      if (ms < 1000) return `${ms.toFixed(2)} ms`
      return `${(ms / 1000).toFixed(2)} s`
    }

    function formatMemory(bytes) {
      if (bytes < 1024) return `${bytes} B`
      if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(2)} KB`
      return `${(bytes / 1024 / 1024).toFixed(2)} MB`
    }

    function getMetricClass(ms, thresholds = { fast: 10, medium: 50 }) {
      if (ms < thresholds.fast) return 'fast'
      if (ms < thresholds.medium) return 'medium'
      return 'slow'
    }

    function displayResult(elementId, content) {
      const element = document.getElementById(elementId)
      element.innerHTML = content
    }

    // æµ‹è¯• 1: å¤§é‡å…¬å¼åˆ›å»º
    window.test1 = async function(count) {
      const resultDiv = document.getElementById('result1')
      resultDiv.innerHTML = 'â³ æµ‹è¯•è¿›è¡Œä¸­...'

      await new Promise(resolve => setTimeout(resolve, 100))

      const model = new SheetModel()
      const sheet = new FormulaSheet(model)
      
      // æµ‹è¯•åˆ›å»ºå…¬å¼
      const startCreate = performance.now()
      for (let i = 0; i < count; i++) {
        const row = Math.floor(i / 10)
        const col = i % 10
        sheet.setValue(row, col, `=A${i + 1}+B${i + 1}`)
      }
      const createTime = performance.now() - startCreate

      // éªŒè¯å…ƒæ•°æ®
      let metadataCount = 0
      model.forEach((r, c, cell) => {
        if (cell.formulaMetadata) metadataCount++
      })

      const avgCreateTime = createTime / count

      const result = `
âœ… <strong>æµ‹è¯•å®Œæˆ</strong>

<strong>æµ‹è¯•è§„æ¨¡ï¼š</strong>${count} ä¸ªå…¬å¼

<strong>åˆ›å»ºè€—æ—¶ï¼š</strong>
  - æ€»æ—¶é—´: <span class="metric ${getMetricClass(createTime, { fast: 100, medium: 500 })}">${formatTime(createTime)}</span>
  - å¹³å‡æ—¶é—´: <span class="metric ${getMetricClass(avgCreateTime, { fast: 0.5, medium: 2 })}">${formatTime(avgCreateTime)}/å…¬å¼</span>
  - åˆ›å»ºé€Ÿç‡: <span class="metric">${Math.round(count / (createTime / 1000))} å…¬å¼/ç§’</span>

<strong>éªŒè¯ç»“æœï¼š</strong>
  - åŒ…å«å…ƒæ•°æ®çš„å•å…ƒæ ¼: ${metadataCount} / ${count}
  - æˆåŠŸç‡: ${((metadataCount / count) * 100).toFixed(1)}%

<strong>æ€§èƒ½è¯„ä¼°ï¼š</strong>
  ${avgCreateTime < 0.5 ? 'ğŸš€ ä¼˜ç§€ - åˆ›å»ºé€Ÿåº¦éå¸¸å¿«' : 
    avgCreateTime < 2 ? 'âœ… è‰¯å¥½ - åˆ›å»ºé€Ÿåº¦æ­£å¸¸' : 
    'âš ï¸ éœ€è¦ä¼˜åŒ– - åˆ›å»ºé€Ÿåº¦è¾ƒæ…¢'}
`
      displayResult('result1', result)
      
      testResults.push({
        name: `åˆ›å»º ${count} ä¸ªå…¬å¼`,
        time: createTime,
        avgTime: avgCreateTime,
        status: avgCreateTime < 2 ? 'success' : 'warning'
      })
    }

    // æµ‹è¯• 2: æ’å…¥è¡Œåˆ—æ€§èƒ½
    window.test2 = async function(formulaCount, insertCount) {
      const resultDiv = document.getElementById('result2')
      resultDiv.innerHTML = 'â³ æµ‹è¯•è¿›è¡Œä¸­...'

      await new Promise(resolve => setTimeout(resolve, 100))

      const model = new SheetModel()
      const sheet = new FormulaSheet(model)

      // åˆ›å»ºå…¬å¼
      for (let i = 0; i < formulaCount; i++) {
        const row = Math.floor(i / 10)
        const col = i % 10
        sheet.setValue(row, col, `=A${i + 1}+B${i + 1}`)
      }

      // æµ‹è¯•æ’å…¥è¡Œ
      const startInsertRow = performance.now()
      for (let i = 0; i < insertCount; i++) {
        sheet.adjustAllFormulas('insertRow', 5, 1)
      }
      const insertRowTime = performance.now() - startInsertRow

      // é‡æ–°åˆ›å»ºæµ‹è¯•åˆ é™¤è¡Œ
      const model2 = new SheetModel()
      const sheet2 = new FormulaSheet(model2)
      for (let i = 0; i < formulaCount; i++) {
        const row = Math.floor(i / 10) + insertCount
        const col = i % 10
        sheet2.setValue(row, col, `=A${i + 1}+B${i + 1}`)
      }

      const startDeleteRow = performance.now()
      for (let i = 0; i < insertCount; i++) {
        sheet2.adjustAllFormulas('deleteRow', 5, 1)
      }
      const deleteRowTime = performance.now() - startDeleteRow

      const avgInsert = insertRowTime / insertCount
      const avgDelete = deleteRowTime / insertCount

      const result = `
âœ… <strong>æµ‹è¯•å®Œæˆ</strong>

<strong>æµ‹è¯•è§„æ¨¡ï¼š</strong>${formulaCount} ä¸ªå…¬å¼ï¼Œæ“ä½œ ${insertCount} æ¬¡

<strong>æ’å…¥è¡Œæ€§èƒ½ï¼š</strong>
  - æ€»æ—¶é—´: <span class="metric ${getMetricClass(insertRowTime, { fast: 50, medium: 200 })}">${formatTime(insertRowTime)}</span>
  - å¹³å‡æ—¶é—´: <span class="metric ${getMetricClass(avgInsert, { fast: 5, medium: 20 })}">${formatTime(avgInsert)}/æ¬¡</span>
  - å½±å“å…¬å¼: ${formulaCount} ä¸ª

<strong>åˆ é™¤è¡Œæ€§èƒ½ï¼š</strong>
  - æ€»æ—¶é—´: <span class="metric ${getMetricClass(deleteRowTime, { fast: 50, medium: 200 })}">${formatTime(deleteRowTime)}</span>
  - å¹³å‡æ—¶é—´: <span class="metric ${getMetricClass(avgDelete, { fast: 5, medium: 20 })}">${formatTime(avgDelete)}/æ¬¡</span>

<strong>æ€§èƒ½å¯¹æ¯”ï¼š</strong>
  - æ’å…¥æ¯”åˆ é™¤ ${insertRowTime > deleteRowTime ? 'æ…¢' : 'å¿«'} ${Math.abs(((insertRowTime - deleteRowTime) / deleteRowTime * 100)).toFixed(1)}%

<strong>æ€§èƒ½è¯„ä¼°ï¼š</strong>
  ${avgInsert < 5 ? 'ğŸš€ ä¼˜ç§€ - å¯ä»¥å®æ—¶å“åº”ç”¨æˆ·æ“ä½œ' : 
    avgInsert < 20 ? 'âœ… è‰¯å¥½ - ç”¨æˆ·ä½“éªŒæµç•…' : 
    'âš ï¸ éœ€è¦ä¼˜åŒ– - å¯èƒ½å½±å“ç”¨æˆ·ä½“éªŒ'}
`
      displayResult('result2', result)

      testResults.push({
        name: `æ’å…¥/åˆ é™¤è¡Œ (${formulaCount} å…¬å¼, ${insertCount} æ¬¡)`,
        time: insertRowTime + deleteRowTime,
        avgTime: (avgInsert + avgDelete) / 2,
        status: avgInsert < 20 ? 'success' : 'warning'
      })
    }

    // æµ‹è¯• 3: å¤åˆ¶ç²˜è´´æ€§èƒ½
    window.test3 = async function(rows, cols) {
      const resultDiv = document.getElementById('result3')
      resultDiv.innerHTML = 'â³ æµ‹è¯•è¿›è¡Œä¸­...'

      await new Promise(resolve => setTimeout(resolve, 100))

      const model = new SheetModel()
      const sheet = new FormulaSheet(model)

      // åˆ›å»ºæºåŒºåŸŸï¼ˆåŒ…å«å…¬å¼ï¼‰
      const createStart = performance.now()
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          sheet.setValue(r, c, `=A${r + 1}+B${c + 1}`)
        }
      }
      const createTime = performance.now() - createStart

      // æµ‹è¯•å¤åˆ¶ç²˜è´´
      const copyStart = performance.now()
      sheet.copyRange(0, 0, rows - 1, cols - 1, rows + 10, cols + 10)
      const copyTime = performance.now() - copyStart

      const totalCells = rows * cols
      const avgCopyTime = copyTime / totalCells

      // éªŒè¯å‡ ä¸ªå•å…ƒæ ¼
      const sample1 = sheet.getDisplayValue(rows + 10, cols + 10)
      const sample2 = sheet.getDisplayValue(rows + 11, cols + 11)

      const result = `
âœ… <strong>æµ‹è¯•å®Œæˆ</strong>

<strong>æµ‹è¯•è§„æ¨¡ï¼š</strong>${rows} Ã— ${cols} = ${totalCells} ä¸ªå•å…ƒæ ¼

<strong>åˆ›å»ºæºåŒºåŸŸï¼š</strong>
  - æ€»æ—¶é—´: <span class="metric">${formatTime(createTime)}</span>
  - å¹³å‡: ${formatTime(createTime / totalCells)}/å•å…ƒæ ¼

<strong>å¤åˆ¶ç²˜è´´æ€§èƒ½ï¼š</strong>
  - æ€»æ—¶é—´: <span class="metric ${getMetricClass(copyTime, { fast: 50, medium: 200 })}">${formatTime(copyTime)}</span>
  - å¹³å‡æ—¶é—´: <span class="metric ${getMetricClass(avgCopyTime, { fast: 0.1, medium: 0.5 })}">${formatTime(avgCopyTime)}/å•å…ƒæ ¼</span>
  - å¤åˆ¶é€Ÿç‡: <span class="metric">${Math.round(totalCells / (copyTime / 1000))} å•å…ƒæ ¼/ç§’</span>

<strong>éªŒè¯ç»“æœï¼š</strong>
  - æºä½ç½® (0,0): ${sheet.getDisplayValue(0, 0)}
  - ç›®æ ‡ä½ç½® (${rows + 10},${cols + 10}): ${sample1}
  - ç›®æ ‡ä½ç½® (${rows + 11},${cols + 11}): ${sample2}

<strong>æ€§èƒ½è¯„ä¼°ï¼š</strong>
  ${avgCopyTime < 0.1 ? 'ğŸš€ ä¼˜ç§€ - å¤åˆ¶é€Ÿåº¦éå¸¸å¿«' : 
    avgCopyTime < 0.5 ? 'âœ… è‰¯å¥½ - å¤åˆ¶é€Ÿåº¦æ­£å¸¸' : 
    'âš ï¸ éœ€è¦ä¼˜åŒ– - å¤åˆ¶é€Ÿåº¦è¾ƒæ…¢'}
`
      displayResult('result3', result)

      testResults.push({
        name: `å¤åˆ¶ ${rows}Ã—${cols} åŒºåŸŸ`,
        time: copyTime,
        avgTime: avgCopyTime,
        status: avgCopyTime < 0.5 ? 'success' : 'warning'
      })
    }

    // æµ‹è¯• 4: å…¬å¼è®¡ç®—æ€§èƒ½
    window.test4 = async function(count) {
      const resultDiv = document.getElementById('result4')
      resultDiv.innerHTML = 'â³ æµ‹è¯•è¿›è¡Œä¸­...'

      await new Promise(resolve => setTimeout(resolve, 100))

      const model = new SheetModel()
      const sheet = new FormulaSheet(model)

      // åˆ›å»ºæ•°å€¼
      for (let i = 0; i < count; i++) {
        sheet.setValue(i, 0, String(i + 1))
      }

      // åˆ›å»ºå…¬å¼
      for (let i = 0; i < count; i++) {
        sheet.setValue(i, 1, `=A${i + 1}*2`)
      }

      // ç¬¬ä¸€æ¬¡è®¡ç®—ï¼ˆæ— ç¼“å­˜ï¼‰
      const calcStart1 = performance.now()
      for (let i = 0; i < count; i++) {
        sheet.getValue(i, 1)
      }
      const calcTime1 = performance.now() - calcStart1

      // ç¬¬äºŒæ¬¡è®¡ç®—ï¼ˆæœ‰ç¼“å­˜ï¼‰
      const calcStart2 = performance.now()
      for (let i = 0; i < count; i++) {
        sheet.getValue(i, 1)
      }
      const calcTime2 = performance.now() - calcStart2

      // æ¸…é™¤ç¼“å­˜åå†è®¡ç®—
      sheet.clearFormulaCache()
      const calcStart3 = performance.now()
      for (let i = 0; i < count; i++) {
        sheet.getValue(i, 1)
      }
      const calcTime3 = performance.now() - calcStart3

      const cacheSpeedup = ((calcTime1 - calcTime2) / calcTime1 * 100).toFixed(1)

      const result = `
âœ… <strong>æµ‹è¯•å®Œæˆ</strong>

<strong>æµ‹è¯•è§„æ¨¡ï¼š</strong>${count} ä¸ªå…¬å¼

<strong>é¦–æ¬¡è®¡ç®—ï¼ˆæ— ç¼“å­˜ï¼‰ï¼š</strong>
  - æ€»æ—¶é—´: <span class="metric ${getMetricClass(calcTime1, { fast: 10, medium: 50 })}">${formatTime(calcTime1)}</span>
  - å¹³å‡: ${formatTime(calcTime1 / count)}/å…¬å¼
  - è®¡ç®—é€Ÿç‡: ${Math.round(count / (calcTime1 / 1000))} å…¬å¼/ç§’

<strong>äºŒæ¬¡è®¡ç®—ï¼ˆæœ‰ç¼“å­˜ï¼‰ï¼š</strong>
  - æ€»æ—¶é—´: <span class="metric fast">${formatTime(calcTime2)}</span>
  - å¹³å‡: ${formatTime(calcTime2 / count)}/å…¬å¼
  - é€Ÿåº¦æå‡: <span class="metric fast">${cacheSpeedup}%</span>

<strong>æ¸…é™¤ç¼“å­˜åï¼š</strong>
  - æ€»æ—¶é—´: <span class="metric">${formatTime(calcTime3)}</span>
  - ä¸é¦–æ¬¡è®¡ç®—å·®å¼‚: ${Math.abs(calcTime3 - calcTime1).toFixed(2)} ms

<strong>ç¼“å­˜æ•ˆæœï¼š</strong>
  ${calcTime2 < calcTime1 / 10 ? 'ğŸš€ ç¼“å­˜éå¸¸æœ‰æ•ˆï¼Œæ€§èƒ½æå‡æ˜¾è‘—' : 
    calcTime2 < calcTime1 / 2 ? 'âœ… ç¼“å­˜æœ‰æ•ˆï¼Œæ€§èƒ½æœ‰æ‰€æå‡' : 
    'âš ï¸ ç¼“å­˜æ•ˆæœä¸æ˜æ˜¾'}
`
      displayResult('result4', result)

      testResults.push({
        name: `è®¡ç®— ${count} ä¸ªå…¬å¼`,
        time: calcTime1,
        avgTime: calcTime1 / count,
        status: calcTime1 / count < 0.1 ? 'success' : 'warning'
      })
    }

    // æµ‹è¯• 5: å¤æ‚å…¬å¼
    window.test5 = async function() {
      const resultDiv = document.getElementById('result5')
      resultDiv.innerHTML = 'â³ æµ‹è¯•è¿›è¡Œä¸­...'

      await new Promise(resolve => setTimeout(resolve, 100))

      const model = new SheetModel()
      const sheet = new FormulaSheet(model)

      const testCases = [
        { formula: '=A1+B1', desc: 'ç®€å•ç›¸å¯¹å¼•ç”¨' },
        { formula: '=$A$1+B1', desc: 'æ··åˆå¼•ç”¨' },
        { formula: '=SUM(A1:A10)', desc: 'èŒƒå›´å¼•ç”¨' },
        { formula: '=A1+B1+C1+D1+E1', desc: 'å¤šä¸ªå¼•ç”¨' },
        { formula: '=IF(A1>0,B1,C1)', desc: 'å‡½æ•°åµŒå¥—' },
      ]

      let results = []

      for (let i = 0; i < testCases.length; i++) {
        const { formula, desc } = testCases[i]
        
        const parseStart = performance.now()
        sheet.setValue(i, 0, formula)
        const parseTime = performance.now() - parseStart

        const cell = model.getCell(i, 0)
        const hasMetadata = !!cell.formulaMetadata
        const tokenCount = cell.formulaMetadata?.tokens.length || 0

        // æµ‹è¯•æ’å…¥è¡Œåçš„è°ƒæ•´
        const adjustStart = performance.now()
        sheet.adjustAllFormulas('insertRow', 0, 1)
        const adjustTime = performance.now() - adjustStart

        const adjustedFormula = sheet.getDisplayValue(i + 1, 0)

        results.push({
          desc,
          formula,
          parseTime,
          hasMetadata,
          tokenCount,
          adjustTime,
          adjustedFormula
        })
      }

      let resultText = 'âœ… <strong>æµ‹è¯•å®Œæˆ</strong>\n\n'
      resultText += '<table>'
      resultText += '<tr><th>ç±»å‹</th><th>åŸå…¬å¼</th><th>è§£ææ—¶é—´</th><th>Tokenæ•°</th><th>è°ƒæ•´æ—¶é—´</th><th>è°ƒæ•´å</th></tr>'
      
      for (const r of results) {
        resultText += '<tr>'
        resultText += `<td>${r.desc}</td>`
        resultText += `<td><code>${r.formula}</code></td>`
        resultText += `<td><span class="metric ${getMetricClass(r.parseTime, { fast: 1, medium: 5 })}">${formatTime(r.parseTime)}</span></td>`
        resultText += `<td>${r.tokenCount}</td>`
        resultText += `<td><span class="metric ${getMetricClass(r.adjustTime, { fast: 1, medium: 5 })}">${formatTime(r.adjustTime)}</span></td>`
        resultText += `<td><code>${r.adjustedFormula}</code></td>`
        resultText += '</tr>'
      }
      
      resultText += '</table>'

      displayResult('result5', resultText)
    }

    // æµ‹è¯• 5 åµŒå¥—: æ·±åº¦åµŒå¥—å…¬å¼æ€§èƒ½
    window.test5Nested = async function(depth) {
      const resultDiv = document.getElementById('result5')
      resultDiv.innerHTML = 'â³ æµ‹è¯•è¿›è¡Œä¸­ï¼Œè¯·ç¨å€™...'

      await new Promise(resolve => setTimeout(resolve, 100))

      const model = new SheetModel()
      const sheet = new FormulaSheet(model)

      // æ„å»ºåµŒå¥—å…¬å¼
      // ç¬¬ä¸€è¡Œï¼šåŸºç¡€å€¼
      sheet.setValue(0, 0, '1')
      sheet.setValue(0, 1, '2')

      // æ„å»ºæ·±åº¦åµŒå¥—çš„å…¬å¼é“¾
      const buildStart = performance.now()
      for (let i = 1; i <= depth; i++) {
        // æ¯ä¸€å±‚ä¾èµ–ä¸Šä¸€å±‚ï¼šB{i+1} = A{i} + B{i}
        sheet.setValue(i, 0, `=A${i}+1`)
        sheet.setValue(i, 1, `=A${i + 1}+B${i}`)
      }
      const buildTime = performance.now() - buildStart

      // æµ‹è¯•è®¡ç®—æ€§èƒ½ï¼ˆæ·±åº¦åµŒå¥—ä¼šé€’å½’è®¡ç®—ï¼‰
      const calcStart = performance.now()
      const result = sheet.getValue(depth, 1)
      const calcTime = performance.now() - calcStart

      // æµ‹è¯•ç¼“å­˜æ•ˆæœ
      const calcStart2 = performance.now()
      const result2 = sheet.getValue(depth, 1)
      const calcTime2 = performance.now() - calcStart2

      // æµ‹è¯•è°ƒæ•´æ€§èƒ½
      const adjustStart = performance.now()
      sheet.adjustAllFormulas('insertRow', 0, 1)
      const adjustTime = performance.now() - adjustStart

      // éªŒè¯è°ƒæ•´åçš„è®¡ç®—
      const calcStart3 = performance.now()
      const result3 = sheet.getValue(depth + 1, 1)
      const calcTime3 = performance.now() - calcStart3

      const resultText = `
âœ… <strong>æµ‹è¯•å®Œæˆ - ${depth} å±‚åµŒå¥—å…¬å¼</strong>

<strong>å…¬å¼ç»“æ„ï¼š</strong>
  - åµŒå¥—æ·±åº¦: ${depth} å±‚
  - å…¬å¼æ•°é‡: ${depth * 2} ä¸ª
  - ä¾èµ–é“¾é•¿åº¦: ${depth}

<strong>æ„å»ºæ€§èƒ½ï¼š</strong>
  - æ„å»ºæ—¶é—´: <span class="metric ${getMetricClass(buildTime, { fast: 50, medium: 200 })}">${formatTime(buildTime)}</span>
  - å¹³å‡æ—¶é—´: ${formatTime(buildTime / (depth * 2))}/å…¬å¼

<strong>é¦–æ¬¡è®¡ç®—ï¼ˆæ— ç¼“å­˜ï¼‰ï¼š</strong>
  - è®¡ç®—æ—¶é—´: <span class="metric ${getMetricClass(calcTime, { fast: 10, medium: 100 })}">${formatTime(calcTime)}</span>
  - è®¡ç®—ç»“æœ: ${result}
  - é€’å½’æ·±åº¦: ${depth}

<strong>äºŒæ¬¡è®¡ç®—ï¼ˆæœ‰ç¼“å­˜ï¼‰ï¼š</strong>
  - è®¡ç®—æ—¶é—´: <span class="metric fast">${formatTime(calcTime2)}</span>
  - é€Ÿåº¦æå‡: <span class="metric fast">${((calcTime - calcTime2) / calcTime * 100).toFixed(1)}%</span>

<strong>è°ƒæ•´æ€§èƒ½ï¼š</strong>
  - è°ƒæ•´æ—¶é—´: <span class="metric ${getMetricClass(adjustTime, { fast: 50, medium: 200 })}">${formatTime(adjustTime)}</span>
  - å½±å“å…¬å¼: ${depth * 2} ä¸ª

<strong>è°ƒæ•´åé‡æ–°è®¡ç®—ï¼š</strong>
  - è®¡ç®—æ—¶é—´: <span class="metric ${getMetricClass(calcTime3, { fast: 10, medium: 100 })}">${formatTime(calcTime3)}</span>
  - è®¡ç®—ç»“æœ: ${result3}

<strong>æ€§èƒ½è¯„ä¼°ï¼š</strong>
  ${calcTime < 10 ? 'ğŸš€ ä¼˜ç§€ - æ·±åº¦åµŒå¥—è®¡ç®—éå¸¸å¿«' : 
    calcTime < 100 ? 'âœ… è‰¯å¥½ - åµŒå¥—è®¡ç®—æ€§èƒ½æ­£å¸¸' : 
    calcTime < 1000 ? 'âš ï¸ ä¸€èˆ¬ - æ·±åº¦åµŒå¥—ç•¥æ…¢' :
    'âŒ è¾ƒå·® - éœ€è¦ä¼˜åŒ–åµŒå¥—è®¡ç®—'}
`
      displayResult('result5', resultText)

      testResults.push({
        name: `${depth} å±‚åµŒå¥—å…¬å¼`,
        time: calcTime,
        avgTime: calcTime / depth,
        status: calcTime < 100 ? 'success' : 'warning'
      })
    }

    // æµ‹è¯• 2B: æ’å…¥åˆ—æ€§èƒ½
    window.test2b = async function(formulaCount, insertCount) {
      const resultDiv = document.getElementById('result2b')
      resultDiv.innerHTML = 'â³ æµ‹è¯•è¿›è¡Œä¸­ï¼Œå¤§è§„æ¨¡æ“ä½œéœ€è¦è¾ƒé•¿æ—¶é—´...'

      await new Promise(resolve => setTimeout(resolve, 100))

      const model = new SheetModel()
      const sheet = new FormulaSheet(model)

      // åˆ›å»ºå…¬å¼ï¼ˆåˆ†æ•£åœ¨å¤šåˆ—ï¼‰
      const createStart = performance.now()
      for (let i = 0; i < formulaCount; i++) {
        const row = Math.floor(i / 100)
        const col = i % 100
        sheet.setValue(row, col, `=A${i + 1}+B${i + 1}`)
      }
      const createTime = performance.now() - createStart

      // æµ‹è¯•æ’å…¥åˆ—
      const startInsertCol = performance.now()
      for (let i = 0; i < insertCount; i++) {
        sheet.adjustAllFormulas('insertCol', 5, 1)
        // æ¯100æ¬¡æ›´æ–°ä¸€æ¬¡è¿›åº¦
        if (i % 100 === 0 && insertCount > 1000) {
          await new Promise(resolve => setTimeout(resolve, 0))
          resultDiv.innerHTML = `â³ æ’å…¥åˆ—è¿›åº¦: ${i}/${insertCount} (${(i/insertCount*100).toFixed(1)}%)`
        }
      }
      const insertColTime = performance.now() - startInsertCol

      // æµ‹è¯•åˆ é™¤åˆ—
      const startDeleteCol = performance.now()
      for (let i = 0; i < Math.min(insertCount, 100); i++) {
        sheet.adjustAllFormulas('deleteCol', 5, 1)
      }
      const deleteColTime = performance.now() - startDeleteCol

      const avgInsert = insertColTime / insertCount
      const avgDelete = deleteColTime / Math.min(insertCount, 100)

      const result = `
âœ… <strong>æµ‹è¯•å®Œæˆ - åˆ—æ“ä½œæ€§èƒ½</strong>

<strong>æµ‹è¯•è§„æ¨¡ï¼š</strong>
  - å…¬å¼æ•°é‡: ${formulaCount} ä¸ª
  - æ’å…¥åˆ—æ•°: ${insertCount}
  - åˆ é™¤åˆ—æ•°: ${Math.min(insertCount, 100)}

<strong>åˆ›å»ºå…¬å¼ï¼š</strong>
  - åˆ›å»ºæ—¶é—´: <span class="metric">${formatTime(createTime)}</span>

<strong>æ’å…¥åˆ—æ€§èƒ½ï¼š</strong>
  - æ€»æ—¶é—´: <span class="metric ${getMetricClass(insertColTime, { fast: 500, medium: 5000 })}">${formatTime(insertColTime)}</span>
  - å¹³å‡æ—¶é—´: <span class="metric ${getMetricClass(avgInsert, { fast: 5, medium: 50 })}">${formatTime(avgInsert)}/åˆ—</span>
  - æ’å…¥é€Ÿç‡: <span class="metric">${Math.round(insertCount / (insertColTime / 1000))} åˆ—/ç§’</span>

<strong>åˆ é™¤åˆ—æ€§èƒ½ï¼š</strong>
  - æ€»æ—¶é—´: <span class="metric ${getMetricClass(deleteColTime, { fast: 100, medium: 1000 })}">${formatTime(deleteColTime)}</span>
  - å¹³å‡æ—¶é—´: <span class="metric ${getMetricClass(avgDelete, { fast: 5, medium: 50 })}">${formatTime(avgDelete)}/åˆ—</span>

<strong>æ€§èƒ½è¯„ä¼°ï¼š</strong>
  ${avgInsert < 5 ? 'ğŸš€ ä¼˜ç§€ - åˆ—æ“ä½œéå¸¸å¿«' : 
    avgInsert < 50 ? 'âœ… è‰¯å¥½ - åˆ—æ“ä½œæ€§èƒ½æ­£å¸¸' : 
    avgInsert < 500 ? 'âš ï¸ ä¸€èˆ¬ - å¤§è§„æ¨¡åˆ—æ“ä½œç•¥æ…¢' :
    'âŒ è¾ƒå·® - éœ€è¦ä¼˜åŒ–åˆ—æ“ä½œ'}

${insertCount >= 1000 ? '<strong>âš ï¸ æ³¨æ„ï¼š</strong>å¤§è§„æ¨¡åˆ—æ’å…¥æ˜¯æé™æµ‹è¯•ï¼Œå®é™…ä½¿ç”¨ä¸­å¾ˆå°‘éœ€è¦æ’å…¥å¦‚æ­¤å¤šçš„åˆ—ã€‚' : ''}
`
      displayResult('result2b', result)

      testResults.push({
        name: `æ’å…¥ ${insertCount} åˆ— (${formulaCount} å…¬å¼)`,
        time: insertColTime,
        avgTime: avgInsert,
        status: avgInsert < 50 ? 'success' : 'warning'
      })
    }

    // æµ‹è¯• 6: å†…å­˜å ç”¨
    window.test6 = async function() {
      const resultDiv = document.getElementById('result6')
      resultDiv.innerHTML = 'â³ æµ‹è¯•è¿›è¡Œä¸­...'

      await new Promise(resolve => setTimeout(resolve, 100))

      const counts = [100, 500, 1000, 5000]
      let results = []

      for (const count of counts) {
        const model = new SheetModel()
        const sheet = new FormulaSheet(model)

        // åˆ›å»ºå…¬å¼
        for (let i = 0; i < count; i++) {
          sheet.setValue(i, 0, `=A${i + 1}+B${i + 1}`)
        }

        // ä¼°ç®—å†…å­˜ï¼ˆé€šè¿‡ JSON åºåˆ—åŒ–å¤§å°ï¼‰
        let totalSize = 0
        model.forEach((r, c, cell) => {
          const cellJson = JSON.stringify(cell)
          totalSize += cellJson.length * 2 // UTF-16, æ¯å­—ç¬¦2å­—èŠ‚
        })

        const avgSize = totalSize / count

        results.push({
          count,
          totalSize,
          avgSize
        })
      }

      let resultText = 'âœ… <strong>æµ‹è¯•å®Œæˆ</strong>\n\n'
      resultText += '<strong>å†…å­˜å ç”¨åˆ†æï¼ˆä¼°ç®—å€¼ï¼‰ï¼š</strong>\n\n'
      resultText += '<table>'
      resultText += '<tr><th>å…¬å¼æ•°é‡</th><th>æ€»å†…å­˜</th><th>å¹³å‡å†…å­˜/å…¬å¼</th><th>å¼€é”€è¯„ä¼°</th></tr>'
      
      for (const r of results) {
        const overhead = r.avgSize < 500 ? 'ä½' : r.avgSize < 1000 ? 'ä¸­ç­‰' : 'é«˜'
        const overheadClass = r.avgSize < 500 ? 'success' : r.avgSize < 1000 ? 'warning' : 'error'
        
        resultText += '<tr>'
        resultText += `<td>${r.count}</td>`
        resultText += `<td>${formatMemory(r.totalSize)}</td>`
        resultText += `<td>${formatMemory(r.avgSize)}</td>`
        resultText += `<td><span class="badge ${overheadClass}">${overhead}</span></td>`
        resultText += '</tr>'
      }
      
      resultText += '</table>\n\n'
      resultText += '<strong>åˆ†æï¼š</strong>\n'
      resultText += `- æ™®é€šå•å…ƒæ ¼ï¼ˆçº¯æ–‡æœ¬ï¼‰: ~50-100 bytes\n`
      resultText += `- å…¬å¼å•å…ƒæ ¼ï¼ˆå«å…ƒæ•°æ®ï¼‰: ~${formatMemory(results[0].avgSize)}\n`
      resultText += `- å…ƒæ•°æ®é¢å¤–å¼€é”€: ~${formatMemory(results[0].avgSize - 75)} (${((results[0].avgSize - 75) / 75 * 100).toFixed(0)}%)\n\n`
      resultText += results[0].avgSize < 500 ? 
        'âœ… å†…å­˜å¼€é”€åˆç†ï¼Œé€‚åˆå¤§è§„æ¨¡åº”ç”¨' : 
        'âš ï¸ å†…å­˜å¼€é”€è¾ƒå¤§ï¼Œæ³¨æ„ä¼˜åŒ–'

      displayResult('result6', resultText)
    }

    // è¿è¡Œæ‰€æœ‰æµ‹è¯•
    window.runAllTests = async function() {
      testResults.length = 0
      const progressBar = document.getElementById('globalProgressBar')
      
      const tests = [
        () => test1(1000),
        () => test2(500, 10),
        () => test3(20, 20),
        () => test4(500),
        () => test5(),
        () => test6()
      ]

      for (let i = 0; i < tests.length; i++) {
        await tests[i]()
        progressBar.style.width = ((i + 1) / tests.length * 100) + '%'
        await new Promise(resolve => setTimeout(resolve, 500))
      }

      showSummary()
    }

    function showSummary() {
      const summary = document.getElementById('summary')
      const content = document.getElementById('summaryContent')
      
      const totalTime = testResults.reduce((sum, r) => sum + r.time, 0)
      const avgTime = totalTime / testResults.length
      const successCount = testResults.filter(r => r.status === 'success').length
      
      let html = '<table>'
      html += '<tr><th>æµ‹è¯•é¡¹ç›®</th><th>æ€»æ—¶é—´</th><th>å¹³å‡æ—¶é—´</th><th>çŠ¶æ€</th></tr>'
      
      for (const result of testResults) {
        html += '<tr>'
        html += `<td>${result.name}</td>`
        html += `<td>${formatTime(result.time)}</td>`
        html += `<td>${formatTime(result.avgTime)}</td>`
        html += `<td><span class="badge ${result.status}">${result.status === 'success' ? 'ä¼˜ç§€' : 'ä¸€èˆ¬'}</span></td>`
        html += '</tr>'
      }
      
      html += '</table>'
      html += `\n<p><strong>æ€»ä½“è¯„åˆ†ï¼š</strong>${successCount}/${testResults.length} é¡¹æµ‹è¯•è¾¾åˆ°ä¼˜ç§€æ ‡å‡†</p>`
      html += `<p><strong>æ€»è€—æ—¶ï¼š</strong>${formatTime(totalTime)}</p>`
      
      content.innerHTML = html
      summary.style.display = 'block'
    }

    window.clearResults = function() {
      for (let i = 1; i <= 6; i++) {
        document.getElementById(`result${i}`).innerHTML = ''
      }
      document.getElementById('summary').style.display = 'none'
      document.getElementById('globalProgressBar').style.width = '0%'
      testResults.length = 0
    }

    console.log('ğŸ“Š æ€§èƒ½æµ‹è¯•é¡µé¢å·²åŠ è½½')
  </script>
</body>
</html>
