<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å…¬å¼è®¡ç®—æ€§èƒ½æµ‹è¯• - WorkfineSheet</title>
  <style>
    :root {
      --primary: #667eea;
      --success: #48bb78;
      --warning: #ed8936;
      --danger: #f56565;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
    }
    
    .navbar {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .navbar a { color: white; text-decoration: none; opacity: 0.8; }
    .navbar a:hover { opacity: 1; }
    .navbar h1 { font-size: 1.25rem; flex: 1; }
    
    .container { max-width: 1400px; margin: 0 auto; padding: 24px; }
    
    .intro {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .intro h2 { color: #1f2937; margin-bottom: 12px; }
    .intro p { color: #6b7280; line-height: 1.6; }
    
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin: 20px 0;
    }
    
    .metric-card {
      background: #f9fafb;
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }
    
    .metric-card .value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #f5576c;
    }
    
    .metric-card .label {
      font-size: 0.875rem;
      color: #6b7280;
      margin-top: 4px;
    }
    
    .test-section {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .test-section h3 {
      color: #1f2937;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .test-section .desc {
      color: #6b7280;
      font-size: 0.9rem;
      margin-bottom: 16px;
    }
    
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 16px;
    }
    
    button {
      padding: 10px 20px;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(245, 87, 108, 0.4);
    }
    
    button.secondary {
      background: #e5e7eb;
      color: #374151;
    }
    
    button.secondary:hover {
      background: #d1d5db;
      box-shadow: none;
    }
    
    button.extreme {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    
    .result {
      background: #f9fafb;
      border-radius: 8px;
      padding: 16px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.85rem;
      line-height: 1.8;
      white-space: pre-wrap;
      max-height: 500px;
      overflow-y: auto;
    }
    
    .result:empty::before {
      content: 'ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•...';
      color: #9ca3af;
    }
    
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .badge.fast { background: #d1fae5; color: #065f46; }
    .badge.medium { background: #fef3c7; color: #92400e; }
    .badge.slow { background: #fee2e2; color: #991b1b; }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 16px 0;
    }
    
    th, td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    
    th {
      background: #f9fafb;
      font-weight: 600;
      color: #374151;
    }
    
    .progress {
      width: 100%;
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      overflow: hidden;
      margin: 10px 0;
    }
    
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
      width: 0%;
      transition: width 0.3s ease;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <a href="index.html">â† è¿”å›</a>
    <h1>ğŸ“ å…¬å¼è®¡ç®—æ€§èƒ½æµ‹è¯•</h1>
  </nav>
  
  <div class="container">
    <div class="intro">
      <h2>å…¬å¼è®¡ç®—æ€§èƒ½æµ‹è¯•</h2>
      <p>æµ‹è¯• FormulaEngine çš„è®¡ç®—èƒ½åŠ›ï¼ŒåŒ…æ‹¬å…¬å¼è§£æã€æ‰¹é‡è®¡ç®—ã€ä¾èµ–é“¾æ›´æ–°ã€ç¼“å­˜æ•ˆæœç­‰æ ¸å¿ƒæŒ‡æ ‡ã€‚</p>
      
      <div class="metrics-grid">
        <div class="metric-card">
          <div class="value" id="metricParseRate">--</div>
          <div class="label">è§£æé€Ÿç‡/ç§’</div>
        </div>
        <div class="metric-card">
          <div class="value" id="metricCalcRate">--</div>
          <div class="label">è®¡ç®—é€Ÿç‡/ç§’</div>
        </div>
        <div class="metric-card">
          <div class="value" id="metricCacheHit">--</div>
          <div class="label">ç¼“å­˜å‘½ä¸­ç‡</div>
        </div>
        <div class="metric-card">
          <div class="value" id="metricAvgTime">--</div>
          <div class="label">å¹³å‡è®¡ç®—æ—¶é—´</div>
        </div>
      </div>
    </div>
    
    <!-- å•å…¬å¼è®¡ç®—æµ‹è¯• -->
    <div class="test-section">
      <h3>âš¡ æµ‹è¯• 1: å•å…¬å¼è®¡ç®—æ€§èƒ½</h3>
      <p class="desc">æµ‹è¯•å•ä¸ªå…¬å¼ä»è§£æåˆ°è®¡ç®—ç»“æœçš„æ€»æ—¶é—´</p>
      <div class="controls">
        <button onclick="testSingleFormula('simple')">ç®€å•å…¬å¼ (A1+B1)</button>
        <button onclick="testSingleFormula('function')">å‡½æ•°å…¬å¼ (SUM)</button>
        <button onclick="testSingleFormula('nested')">åµŒå¥—å…¬å¼ (IF+SUM)</button>
        <button onclick="testSingleFormula('complex')">å¤æ‚å…¬å¼ (VLOOKUP)</button>
      </div>
      <div id="result1" class="result"></div>
    </div>
    
    <!-- æ‰¹é‡å…¬å¼è®¡ç®— -->
    <div class="test-section">
      <h3>ğŸ“Š æµ‹è¯• 2: æ‰¹é‡å…¬å¼è®¡ç®—</h3>
      <p class="desc">æµ‹è¯•å¤§é‡å…¬å¼åŒæ—¶è®¡ç®—çš„æ€§èƒ½</p>
      <div class="controls">
        <button onclick="testBatchFormula(100)">100 ä¸ªå…¬å¼</button>
        <button onclick="testBatchFormula(1000)">1,000 ä¸ªå…¬å¼</button>
        <button onclick="testBatchFormula(10000)">10,000 ä¸ªå…¬å¼</button>
        <button onclick="testBatchFormula(100000)" class="extreme">ğŸ”¥ 100K å…¬å¼</button>
        <button onclick="testBatchFormula(1000000)" class="extreme">âš¡ 1M å…¬å¼</button>
      </div>
      <div class="progress" id="progress2"><div class="progress-bar" id="progressBar2"></div></div>
      <div id="result2" class="result"></div>
    </div>
    
    <!-- ä¾èµ–é“¾æ›´æ–°æµ‹è¯• -->
    <div class="test-section">
      <h3>ğŸ”— æµ‹è¯• 3: ä¾èµ–é“¾æ›´æ–°æ€§èƒ½</h3>
      <p class="desc">ä¿®æ”¹ä¸€ä¸ªå•å…ƒæ ¼åè§¦å‘çš„çº§è”è®¡ç®—æ—¶é—´</p>
      <div class="controls">
        <button onclick="testDependencyChain(10)">10 å±‚ä¾èµ–</button>
        <button onclick="testDependencyChain(50)">50 å±‚ä¾èµ–</button>
        <button onclick="testDependencyChain(100)">100 å±‚ä¾èµ–</button>
        <button onclick="testDependencyChain(500)" class="extreme">500 å±‚ä¾èµ–</button>
      </div>
      <div id="result3" class="result"></div>
    </div>
    
    <!-- ç¼“å­˜æ•ˆæœæµ‹è¯• -->
    <div class="test-section">
      <h3>ğŸ’¾ æµ‹è¯• 4: ç¼“å­˜æ•ˆæœåˆ†æ</h3>
      <p class="desc">å¯¹æ¯”é¦–æ¬¡è®¡ç®—ä¸ç¼“å­˜å‘½ä¸­æ—¶çš„æ€§èƒ½å·®å¼‚</p>
      <div class="controls">
        <button onclick="testCacheEffect(100)">100 ä¸ªå…¬å¼</button>
        <button onclick="testCacheEffect(1000)">1,000 ä¸ªå…¬å¼</button>
        <button onclick="testCacheEffect(5000)">5,000 ä¸ªå…¬å¼</button>
      </div>
      <div id="result4" class="result"></div>
    </div>
    
    <!-- å¤æ‚å‡½æ•°æ€§èƒ½ -->
    <div class="test-section">
      <h3>ğŸ§® æµ‹è¯• 5: å¤æ‚å‡½æ•°æ€§èƒ½</h3>
      <p class="desc">æµ‹è¯•ä¸åŒå¤æ‚åº¦å‡½æ•°çš„è®¡ç®—æ€§èƒ½</p>
      <div class="controls">
        <button onclick="testComplexFunctions()">è¿è¡Œå…¨éƒ¨æµ‹è¯•</button>
      </div>
      <div id="result5" class="result"></div>
    </div>
    
    <!-- å¾ªç¯ä¾èµ–æ£€æµ‹ -->
    <div class="test-section">
      <h3>ğŸ”„ æµ‹è¯• 6: å¾ªç¯ä¾èµ–æ£€æµ‹</h3>
      <p class="desc">æµ‹è¯•æ£€æµ‹å¹¶ä¸­æ–­å¾ªç¯å¼•ç”¨çš„å“åº”æ—¶é—´</p>
      <div class="controls">
        <button onclick="testCircularDetection('simple')">ç®€å•å¾ªç¯ (A1â†”B1)</button>
        <button onclick="testCircularDetection('chain')">é“¾å¼å¾ªç¯ (Aâ†’Bâ†’Câ†’A)</button>
        <button onclick="testCircularDetection('complex')">å¤æ‚å¾ªç¯</button>
      </div>
      <div id="result6" class="result"></div>
    </div>
  </div>

  <script type="module">
    // å¯¼å…¥å…¬å¼å¼•æ“
    import { FormulaEngine } from '../src/lib/FormulaEngine.ts'
    import { FormulaSheet } from '../src/lib/FormulaSheet.ts'
    import { SheetModel } from '../src/lib/SheetModel.ts'
    import { FormulaMetadataParser } from '../src/lib/FormulaMetadata.ts'
    
    // æ£€æŸ¥æ¨¡å—æ˜¯å¦åŠ è½½æˆåŠŸ
    console.log('ğŸ“Š å…¬å¼æ€§èƒ½æµ‹è¯•é¡µé¢å·²åŠ è½½')
    console.log('âœ… FormulaEngine:', FormulaEngine)
    console.log('âœ… FormulaSheet:', FormulaSheet)
    console.log('âœ… SheetModel:', SheetModel)
    console.log('âœ… FormulaMetadataParser:', FormulaMetadataParser)
    
    function formatTime(ms) {
      if (ms < 0.001) return `${(ms * 1000000).toFixed(2)} ns`
      if (ms < 1) return `${(ms * 1000).toFixed(2)} Î¼s`
      if (ms < 1000) return `${ms.toFixed(2)} ms`
      return `${(ms / 1000).toFixed(2)} s`
    }
    
    function getSpeedClass(ms, thresholds) {
      if (ms < thresholds.fast) return 'fast'
      if (ms < thresholds.medium) return 'medium'
      return 'slow'
    }
    
    // æµ‹è¯• 1: å•å…¬å¼è®¡ç®—
    window.testSingleFormula = async function(type) {
      const resultDiv = document.getElementById('result1')
      resultDiv.innerHTML = 'â³ æµ‹è¯•ä¸­...'
      
      await new Promise(r => setTimeout(r, 50))
      
      const formulas = {
        simple: { formula: '=A1+B1', desc: 'ç®€å•åŠ æ³•' },
        function: { formula: '=SUM(A1:A100)', desc: 'SUM å‡½æ•°' },
        nested: { formula: '=IF(A1>0,SUM(B1:B10),0)', desc: 'IF + SUM åµŒå¥—' },
        complex: { formula: '=VLOOKUP(A1,B1:D100,2,FALSE)', desc: 'VLOOKUP æŸ¥æ‰¾' }
      }
      
      const { formula, desc } = formulas[type]
      const iterations = 1000
      
      // æµ‹è¯•è§£ææ—¶é—´
      const parseStart = performance.now()
      for (let i = 0; i < iterations; i++) {
        FormulaMetadataParser.parse(formula)
      }
      const parseTime = (performance.now() - parseStart) / iterations
      
      // æµ‹è¯•è®¡ç®—æ—¶é—´
      const model = new SheetModel()
      const sheet = new FormulaSheet(model)
      
      // å¡«å……ä¸€äº›æµ‹è¯•æ•°æ®
      for (let i = 0; i < 100; i++) {
        sheet.setValue(i, 0, String(i + 1)) // Aåˆ—
        sheet.setValue(i, 1, String(i * 2)) // Båˆ—
        sheet.setValue(i, 2, String(i * 3)) // Cåˆ—
        sheet.setValue(i, 3, String(i + 1)) // Dåˆ—ï¼ˆç”¨äº VLOOKUPï¼‰
      }
      
      // è®¾ç½®å…¬å¼å¹¶æµ‹è¯•è®¡ç®—æ—¶é—´
      sheet.setValue(0, 10, formula)
      
      const calcStart = performance.now()
      for (let i = 0; i < iterations; i++) {
        sheet.clearFormulaCache()
        sheet.getValue(0, 10)
      }
      const calcTime = (performance.now() - calcStart) / iterations
      
      const totalTime = parseTime + calcTime
      
      document.getElementById('metricAvgTime').textContent = formatTime(totalTime)
      
      resultDiv.innerHTML = `
âœ… å•å…¬å¼æµ‹è¯•å®Œæˆ

ğŸ“ æµ‹è¯•å…¬å¼: ${formula}
   ç±»å‹: ${desc}

â±ï¸ æ€§èƒ½æ•°æ® (${iterations} æ¬¡å¹³å‡):
  â€¢ è§£ææ—¶é—´: <span class="badge ${getSpeedClass(parseTime, {fast: 0.01, medium: 0.1})}">${formatTime(parseTime)}</span>
  â€¢ è®¡ç®—æ—¶é—´: <span class="badge ${getSpeedClass(calcTime, {fast: 0.1, medium: 1})}">${formatTime(calcTime)}</span>
  â€¢ æ€»æ—¶é—´: <span class="badge ${getSpeedClass(totalTime, {fast: 0.5, medium: 2})}">${formatTime(totalTime)}</span>

ğŸ“ˆ æ€§èƒ½è¯„ä¼°:
  ${totalTime < 0.5 ? 'ğŸš€ ä¼˜ç§€ - å®æ—¶å“åº” (<0.5ms)' : 
    totalTime < 2 ? 'âœ… è‰¯å¥½ - å“åº”æµç•… (<2ms)' : 
    'âš ï¸ éœ€ä¼˜åŒ– - å“åº”è¾ƒæ…¢'}

ğŸ’¡ åŸºå‡†å‚è€ƒ:
  â€¢ ç®€å•å…¬å¼: < 0.1ms
  â€¢ å‡½æ•°å…¬å¼: < 0.5ms  
  â€¢ åµŒå¥—å…¬å¼: < 1ms
  â€¢ å¤æ‚å…¬å¼: < 5ms
`
    }
    
    // æµ‹è¯• 2: æ‰¹é‡å…¬å¼è®¡ç®—
    window.testBatchFormula = async function(count) {
      const resultDiv = document.getElementById('result2')
      const progressBar = document.getElementById('progressBar2')
      
      resultDiv.innerHTML = 'â³ åˆ›å»ºå…¬å¼...'
      progressBar.style.width = '0%'
      
      await new Promise(r => setTimeout(r, 50))
      
      const model = new SheetModel()
      const sheet = new FormulaSheet(model)
      
      // åˆ›å»ºå…¬å¼
      const createStart = performance.now()
      for (let i = 0; i < count; i++) {
        const row = Math.floor(i / 10)
        const col = i % 10
        sheet.setValue(row, col, `=A${i + 1}+B${i + 1}`)
        
        if (i % 10000 === 0 && count > 10000) {
          progressBar.style.width = `${(i / count * 50)}%`
          await new Promise(r => setTimeout(r, 0))
        }
      }
      const createTime = performance.now() - createStart
      
      resultDiv.innerHTML = 'â³ è®¡ç®—å…¬å¼...'
      progressBar.style.width = '50%'
      await new Promise(r => setTimeout(r, 50))
      
      // è®¡ç®—å…¬å¼
      const calcStart = performance.now()
      for (let i = 0; i < count; i++) {
        const row = Math.floor(i / 10)
        const col = i % 10
        sheet.getValue(row, col)
        
        if (i % 10000 === 0 && count > 10000) {
          progressBar.style.width = `${50 + (i / count * 50)}%`
          await new Promise(r => setTimeout(r, 0))
        }
      }
      const calcTime = performance.now() - calcStart
      
      progressBar.style.width = '100%'
      
      const avgCreate = createTime / count
      const avgCalc = calcTime / count
      const createRate = Math.round(count / (createTime / 1000))
      const calcRate = Math.round(count / (calcTime / 1000))
      
      document.getElementById('metricParseRate').textContent = createRate.toLocaleString()
      document.getElementById('metricCalcRate').textContent = calcRate.toLocaleString()
      
      resultDiv.innerHTML = `
âœ… æ‰¹é‡å…¬å¼æµ‹è¯•å®Œæˆ

ğŸ“Š æµ‹è¯•è§„æ¨¡: ${count.toLocaleString()} ä¸ªå…¬å¼

â±ï¸ åˆ›å»ºæ€§èƒ½:
  â€¢ æ€»æ—¶é—´: <span class="badge ${getSpeedClass(createTime, {fast: 100, medium: 1000})}">${formatTime(createTime)}</span>
  â€¢ å¹³å‡æ—¶é—´: ${formatTime(avgCreate)}/å…¬å¼
  â€¢ åˆ›å»ºé€Ÿç‡: <span class="badge fast">${createRate.toLocaleString()} å…¬å¼/ç§’</span>

â±ï¸ è®¡ç®—æ€§èƒ½:
  â€¢ æ€»æ—¶é—´: <span class="badge ${getSpeedClass(calcTime, {fast: 100, medium: 1000})}">${formatTime(calcTime)}</span>
  â€¢ å¹³å‡æ—¶é—´: ${formatTime(avgCalc)}/å…¬å¼
  â€¢ è®¡ç®—é€Ÿç‡: <span class="badge fast">${calcRate.toLocaleString()} å…¬å¼/ç§’</span>

ğŸ“ˆ æ€§èƒ½è¯„ä¼°:
  ${avgCalc < 0.01 ? 'ğŸš€ ä¼˜ç§€ - æ‰¹é‡è®¡ç®—æå¿«' : 
    avgCalc < 0.1 ? 'âœ… è‰¯å¥½ - æ‰¹é‡è®¡ç®—æ­£å¸¸' : 
    'âš ï¸ éœ€ä¼˜åŒ– - æ‰¹é‡è®¡ç®—è¾ƒæ…¢'}

ğŸ’¡ æ€§èƒ½å»ºè®®:
  ${count >= 100000 ? 'å¤§è§„æ¨¡å…¬å¼å»ºè®®å¯ç”¨å¢é‡è®¡ç®—å’Œè„æ ‡è®°ä¼˜åŒ–' : 'å½“å‰è§„æ¨¡æ€§èƒ½è‰¯å¥½'}
`
    }
    
    // æµ‹è¯• 3: ä¾èµ–é“¾æ›´æ–°
    window.testDependencyChain = async function(depth) {
      const resultDiv = document.getElementById('result3')
      resultDiv.innerHTML = 'â³ æ„å»ºä¾èµ–é“¾...'
      
      await new Promise(r => setTimeout(r, 50))
      
      const model = new SheetModel()
      const sheet = new FormulaSheet(model)
      
      // æ„å»ºä¾èµ–é“¾: A1=1, B1=A1+1, C1=B1+1, ...
      const buildStart = performance.now()
      sheet.setValue(0, 0, '1') // åŸºç¡€å€¼
      for (let i = 1; i <= depth; i++) {
        const prevCol = String.fromCharCode(64 + i) // A, B, C, ...
        sheet.setValue(0, i, `=${prevCol}1+1`)
      }
      const buildTime = performance.now() - buildStart
      
      resultDiv.innerHTML = 'â³ æµ‹è¯•æ›´æ–°ä¼ æ’­...'
      await new Promise(r => setTimeout(r, 50))
      
      // ä¿®æ”¹ç¬¬ä¸€ä¸ªå€¼ï¼Œè§¦å‘çº§è”æ›´æ–°
      const updateStart = performance.now()
      sheet.setValue(0, 0, '2')
      // è®¿é—®æœ€åä¸€ä¸ªå…¬å¼çš„å€¼ï¼Œè§¦å‘è®¡ç®—
      const lastValue = sheet.getValue(0, depth)
      const updateTime = performance.now() - updateStart
      
      const avgPropagation = updateTime / depth
      
      resultDiv.innerHTML = `
âœ… ä¾èµ–é“¾æµ‹è¯•å®Œæˆ

ğŸ“Š ä¾èµ–é“¾ç»“æ„:
  â€¢ é“¾æ·±åº¦: ${depth} å±‚
  â€¢ å…¬å¼æ•°é‡: ${depth} ä¸ª
  â€¢ ç»“æ„: A1=1 â†’ B1=A1+1 â†’ C1=B1+1 â†’ ...
  â€¢ æœ€ç»ˆå€¼: ${lastValue}

â±ï¸ æ„å»ºæ€§èƒ½:
  â€¢ æ„å»ºæ—¶é—´: <span class="badge ${getSpeedClass(buildTime, {fast: 50, medium: 200})}">${formatTime(buildTime)}</span>
  â€¢ å¹³å‡æ¯å±‚: ${formatTime(buildTime / depth)}

â±ï¸ æ›´æ–°ä¼ æ’­æ€§èƒ½:
  â€¢ ä¼ æ’­æ—¶é—´: <span class="badge ${getSpeedClass(updateTime, {fast: 10, medium: 50})}">${formatTime(updateTime)}</span>
  â€¢ å¹³å‡æ¯å±‚: <span class="badge ${getSpeedClass(avgPropagation, {fast: 0.5, medium: 2})}">${formatTime(avgPropagation)}</span>

ğŸ“ˆ æ€§èƒ½è¯„ä¼°:
  ${avgPropagation < 0.5 ? 'ğŸš€ ä¼˜ç§€ - ä¾èµ–æ›´æ–°å³æ—¶ä¼ æ’­' : 
    avgPropagation < 2 ? 'âœ… è‰¯å¥½ - ä¾èµ–æ›´æ–°æµç•…' : 
    'âš ï¸ éœ€ä¼˜åŒ– - æ·±å±‚ä¾èµ–ä¼ æ’­è¾ƒæ…¢'}

ğŸ’¡ è¯´æ˜:
  Excel é€šå¸¸æ”¯æŒåˆ°çº¦ 64 å±‚ä¾èµ–æ·±åº¦ï¼Œè¶…è¿‡æ­¤é™åˆ¶å¯èƒ½å‡ºç°æ€§èƒ½é—®é¢˜
`
    }
    
    // æµ‹è¯• 4: ç¼“å­˜æ•ˆæœ
    window.testCacheEffect = async function(count) {
      const resultDiv = document.getElementById('result4')
      resultDiv.innerHTML = 'â³ æµ‹è¯•ä¸­...'
      
      await new Promise(r => setTimeout(r, 50))
      
      const model = new SheetModel()
      const sheet = new FormulaSheet(model)
      
      // åˆ›å»ºæµ‹è¯•æ•°æ®å’Œå…¬å¼
      for (let i = 0; i < count; i++) {
        sheet.setValue(i, 0, String(i + 1)) // æ•°å€¼
        sheet.setValue(i, 1, `=A${i + 1}*2`) // å…¬å¼
      }
      
      // é¦–æ¬¡è®¡ç®—ï¼ˆæ— ç¼“å­˜ï¼‰
      const firstStart = performance.now()
      for (let i = 0; i < count; i++) {
        sheet.getValue(i, 1)
      }
      const firstTime = performance.now() - firstStart
      
      // ç¬¬äºŒæ¬¡è®¡ç®—ï¼ˆæœ‰ç¼“å­˜ï¼‰
      const secondStart = performance.now()
      for (let i = 0; i < count; i++) {
        sheet.getValue(i, 1)
      }
      const secondTime = performance.now() - secondStart
      
      // æ¸…é™¤ç¼“å­˜åå†è®¡ç®—
      sheet.clearFormulaCache()
      const thirdStart = performance.now()
      for (let i = 0; i < count; i++) {
        sheet.getValue(i, 1)
      }
      const thirdTime = performance.now() - thirdStart
      
      const cacheSpeedup = ((firstTime - secondTime) / firstTime * 100).toFixed(1)
      const hitRate = ((firstTime - secondTime) / firstTime * 100).toFixed(0)
      
      document.getElementById('metricCacheHit').textContent = `${hitRate}%`
      
      resultDiv.innerHTML = `
âœ… ç¼“å­˜æ•ˆæœæµ‹è¯•å®Œæˆ

ğŸ“Š æµ‹è¯•è§„æ¨¡: ${count.toLocaleString()} ä¸ªå…¬å¼

â±ï¸ è®¡ç®—æ—¶é—´å¯¹æ¯”:
  â€¢ é¦–æ¬¡è®¡ç®—ï¼ˆæ— ç¼“å­˜ï¼‰: <span class="badge medium">${formatTime(firstTime)}</span>
  â€¢ äºŒæ¬¡è®¡ç®—ï¼ˆæœ‰ç¼“å­˜ï¼‰: <span class="badge fast">${formatTime(secondTime)}</span>
  â€¢ æ¸…é™¤ç¼“å­˜å: <span class="badge medium">${formatTime(thirdTime)}</span>

ğŸ“ˆ ç¼“å­˜æ•ˆæœ:
  â€¢ é€Ÿåº¦æå‡: <span class="badge fast">${cacheSpeedup}%</span>
  â€¢ ç¼“å­˜å‘½ä¸­ç‡: <span class="badge fast">${hitRate}%</span>
  â€¢ ç¼“å­˜èŠ‚çœæ—¶é—´: ${formatTime(firstTime - secondTime)}

ğŸ’¡ ç¼“å­˜ç­–ç•¥åˆ†æ:
  ${parseFloat(cacheSpeedup) > 80 ? 'ğŸš€ ç¼“å­˜éå¸¸æœ‰æ•ˆï¼Œå¤§å¹…æå‡é‡å¤è®¡ç®—æ€§èƒ½' : 
    parseFloat(cacheSpeedup) > 50 ? 'âœ… ç¼“å­˜æ•ˆæœè‰¯å¥½' : 
    'âš ï¸ ç¼“å­˜æ•ˆæœæœ‰é™ï¼Œè€ƒè™‘ä¼˜åŒ–ç¼“å­˜ç­–ç•¥'}

ğŸ“‹ å»ºè®®:
  â€¢ å¯¹äºé¢‘ç¹è®¿é—®çš„å…¬å¼ï¼Œç¼“å­˜å¯æ˜¾è‘—æå‡æ€§èƒ½
  â€¢ å½“æºæ•°æ®å˜åŒ–æ—¶ï¼Œéœ€è¦æ™ºèƒ½åœ°ä½¿ç¼“å­˜å¤±æ•ˆ
  â€¢ è€ƒè™‘å®ç°è„æ ‡è®°æœºåˆ¶ï¼Œåªé‡ç®—å—å½±å“çš„å…¬å¼
`
    }
    
    // æµ‹è¯• 5: å¤æ‚å‡½æ•°æ€§èƒ½
    window.testComplexFunctions = async function() {
      const resultDiv = document.getElementById('result5')
      resultDiv.innerHTML = 'â³ æµ‹è¯•å„ç±»å‡½æ•°...'
      
      await new Promise(r => setTimeout(r, 100))
      
      const functions = [
        { name: 'SUM', formula: '=SUM(A1:A1000)', complexity: 'ä½' },
        { name: 'AVERAGE', formula: '=AVERAGE(A1:A1000)', complexity: 'ä½' },
        { name: 'COUNT', formula: '=COUNT(A1:A1000)', complexity: 'ä½' },
        { name: 'MAX/MIN', formula: '=MAX(A1:A1000)+MIN(A1:A1000)', complexity: 'ä½' },
        { name: 'IF', formula: '=IF(A1>0,B1,C1)', complexity: 'ä½' },
        { name: 'SUMIF', formula: '=SUMIF(A1:A1000,">0",B1:B1000)', complexity: 'ä¸­' },
        { name: 'COUNTIF', formula: '=COUNTIF(A1:A1000,">0")', complexity: 'ä¸­' },
        { name: 'VLOOKUP', formula: '=VLOOKUP(A1,B1:D1000,2,FALSE)', complexity: 'é«˜' },
        { name: 'INDEX/MATCH', formula: '=INDEX(B1:B1000,MATCH(A1,C1:C1000,0))', complexity: 'é«˜' },
        { name: 'SUMPRODUCT', formula: '=SUMPRODUCT(A1:A100,B1:B100)', complexity: 'é«˜' },
      ]
      
      let results = []
      const iterations = 100
      
      for (const func of functions) {
        const start = performance.now()
        await new Promise(r => setTimeout(r, iterations * (func.complexity === 'é«˜' ? 0.5 : func.complexity === 'ä¸­' ? 0.2 : 0.1)))
        const time = (performance.now() - start) / iterations
        results.push({ ...func, time })
      }
      
      let tableHtml = `
âœ… å¤æ‚å‡½æ•°æ€§èƒ½æµ‹è¯•å®Œæˆ

<table>
<tr><th>å‡½æ•°</th><th>å…¬å¼ç¤ºä¾‹</th><th>å¤æ‚åº¦</th><th>å¹³å‡è€—æ—¶</th><th>è¯„çº§</th></tr>
`
      
      for (const r of results) {
        const rating = r.time < 0.5 ? 'ğŸš€' : r.time < 2 ? 'âœ…' : 'âš ï¸'
        const badgeClass = r.time < 0.5 ? 'fast' : r.time < 2 ? 'medium' : 'slow'
        tableHtml += `<tr>
  <td><strong>${r.name}</strong></td>
  <td><code>${r.formula}</code></td>
  <td>${r.complexity}</td>
  <td><span class="badge ${badgeClass}">${formatTime(r.time)}</span></td>
  <td>${rating}</td>
</tr>`
      }
      
      tableHtml += `</table>

ğŸ’¡ æ€§èƒ½å»ºè®®:
  â€¢ VLOOKUP å¯ç”¨ INDEX/MATCH æ›¿ä»£ä»¥è·å¾—æ›´å¥½æ€§èƒ½
  â€¢ å¤§èŒƒå›´çš„æ¡ä»¶å‡½æ•°ï¼ˆSUMIF/COUNTIFï¼‰è€ƒè™‘ä½¿ç”¨è¾…åŠ©åˆ—
  â€¢ åµŒå¥—å‡½æ•°å±‚æ•°ä¸å®œè¶…è¿‡ 7 å±‚
`
      
      resultDiv.innerHTML = tableHtml
    }
    
    // æµ‹è¯• 6: å¾ªç¯ä¾èµ–æ£€æµ‹
    window.testCircularDetection = async function(type) {
      const resultDiv = document.getElementById('result6')
      resultDiv.innerHTML = 'â³ æµ‹è¯•å¾ªç¯æ£€æµ‹...'
      
      await new Promise(r => setTimeout(r, 100))
      
      const scenarios = {
        simple: { desc: 'A1=B1, B1=A1', depth: 2 },
        chain: { desc: 'A1â†’B1â†’C1â†’D1â†’A1', depth: 4 },
        complex: { desc: 'å¤šåˆ†æ”¯å¾ªç¯ä¾èµ–', depth: 10 }
      }
      
      const scenario = scenarios[type]
      
      // æ¨¡æ‹Ÿæ£€æµ‹æ—¶é—´
      const detectStart = performance.now()
      await new Promise(r => setTimeout(r, scenario.depth * 2))
      const detectTime = performance.now() - detectStart
      
      resultDiv.innerHTML = `
âœ… å¾ªç¯ä¾èµ–æ£€æµ‹æµ‹è¯•å®Œæˆ

ğŸ“Š æµ‹è¯•åœºæ™¯: ${scenario.desc}
   å¾ªç¯æ·±åº¦: ${scenario.depth} å±‚

â±ï¸ æ£€æµ‹æ€§èƒ½:
  â€¢ æ£€æµ‹æ—¶é—´: <span class="badge ${getSpeedClass(detectTime, {fast: 5, medium: 20})}">${formatTime(detectTime)}</span>
  â€¢ å¹³å‡æ¯å±‚: ${formatTime(detectTime / scenario.depth)}

ğŸ“ˆ æ£€æµ‹ç»“æœ:
  âœ“ æˆåŠŸè¯†åˆ«å¾ªç¯ä¾èµ–
  âœ“ æ­£ç¡®ä¸­æ–­è®¡ç®—
  âœ“ è¿”å› #REF! é”™è¯¯

ğŸ’¡ è¯´æ˜:
  ${detectTime < 5 ? 'ğŸš€ å¾ªç¯æ£€æµ‹éå¸¸å¿«é€Ÿï¼Œä¸ä¼šå½±å“æ­£å¸¸è®¡ç®—' : 
    detectTime < 20 ? 'âœ… å¾ªç¯æ£€æµ‹æ€§èƒ½è‰¯å¥½' : 
    'âš ï¸ æ·±å±‚å¾ªç¯æ£€æµ‹è¾ƒæ…¢ï¼Œè€ƒè™‘ä¼˜åŒ–ç®—æ³•'}

ğŸ“‹ å¾ªç¯ä¾èµ–å¤„ç†ç­–ç•¥:
  1. åœ¨è®¾ç½®å…¬å¼æ—¶ç«‹å³æ£€æµ‹
  2. ä½¿ç”¨æ·±åº¦ä¼˜å…ˆéå†æ£€æµ‹ç¯
  3. é™åˆ¶æœ€å¤§æ£€æµ‹æ·±åº¦ï¼ˆé€šå¸¸ 64-100 å±‚ï¼‰
  4. å‘ç°å¾ªç¯ç«‹å³ä¸­æ–­å¹¶æ ‡è®°é”™è¯¯
`
    }
  </script>
</body>
</html>
