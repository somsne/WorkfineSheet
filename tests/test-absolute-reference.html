<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç»å¯¹å¼•ç”¨æµ‹è¯• - Excel $ç¬¦å·</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
      background: #f5f5f5;
    }
    h1 {
      color: #2c3e50;
      border-bottom: 3px solid #3498db;
      padding-bottom: 10px;
    }
    .test-section {
      margin: 20px 0;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .test-section h2 {
      margin-top: 0;
      color: #3498db;
    }
    button {
      padding: 10px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .result {
      margin-top: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-left: 4px solid #3498db;
      border-radius: 4px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 14px;
      line-height: 1.8;
      white-space: pre-wrap;
    }
    .pass {
      color: #27ae60;
      font-weight: bold;
    }
    .fail {
      color: #e74c3c;
      font-weight: bold;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }
    th, td {
      padding: 10px;
      text-align: left;
      border: 1px solid #ddd;
    }
    th {
      background: #3498db;
      color: white;
    }
    .formula {
      background: #e8f5e9;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <h1>ğŸ“Š Excel ç»å¯¹å¼•ç”¨æµ‹è¯• ($ ç¬¦å·)</h1>
  
  <div class="test-section">
    <h2>æµ‹è¯• 1: ç›¸å¯¹å¼•ç”¨ vs ç»å¯¹å¼•ç”¨</h2>
    <p>éªŒè¯ <code>A1</code> å’Œ <code>$A$1</code> åœ¨æ’å…¥è¡Œæ—¶çš„ä¸åŒè¡Œä¸º</p>
    <button onclick="test1()">è¿è¡Œæµ‹è¯•</button>
    <div id="result1" class="result"></div>
  </div>

  <div class="test-section">
    <h2>æµ‹è¯• 2: æ··åˆå¼•ç”¨ - åˆ—ç»å¯¹ ($A1)</h2>
    <p>éªŒè¯ <code>$A1</code>ï¼šåˆ—ä¿æŒä¸å˜ï¼Œè¡Œè‡ªåŠ¨è°ƒæ•´</p>
    <button onclick="test2()">è¿è¡Œæµ‹è¯•</button>
    <div id="result2" class="result"></div>
  </div>

  <div class="test-section">
    <h2>æµ‹è¯• 3: æ··åˆå¼•ç”¨ - è¡Œç»å¯¹ (A$1)</h2>
    <p>éªŒè¯ <code>A$1</code>ï¼šè¡Œä¿æŒä¸å˜ï¼Œåˆ—è‡ªåŠ¨è°ƒæ•´</p>
    <button onclick="test3()">è¿è¡Œæµ‹è¯•</button>
    <div id="result3" class="result"></div>
  </div>

  <div class="test-section">
    <h2>æµ‹è¯• 4: å¤åˆ¶ç²˜è´´æ—¶çš„ç»å¯¹å¼•ç”¨</h2>
    <p>éªŒè¯å¤åˆ¶åŒ…å«ç»å¯¹å¼•ç”¨çš„å…¬å¼æ—¶ï¼Œç»å¯¹å¼•ç”¨ä¸å˜</p>
    <button onclick="test4()">è¿è¡Œæµ‹è¯•</button>
    <div id="result4" class="result"></div>
  </div>

  <div class="test-section">
    <h2>æµ‹è¯• 5: ç»¼åˆæµ‹è¯• - æ··åˆä½¿ç”¨</h2>
    <p>éªŒè¯å…¬å¼ä¸­åŒæ—¶åŒ…å«ç›¸å¯¹å’Œç»å¯¹å¼•ç”¨</p>
    <button onclick="test5()">è¿è¡Œæµ‹è¯•</button>
    <div id="result5" class="result"></div>
  </div>

  <div class="test-section">
    <h2>æµ‹è¯• 6: åˆ é™¤è¡Œåˆ—å¯¹ç»å¯¹å¼•ç”¨çš„å½±å“</h2>
    <p>éªŒè¯åˆ é™¤è¢«å¼•ç”¨çš„è¡Œæ—¶ï¼Œç»å¯¹å¼•ç”¨å˜ä¸º #REF!</p>
    <button onclick="test6()">è¿è¡Œæµ‹è¯•</button>
    <div id="result6" class="result"></div>
  </div>

  <script type="module">
    import { SheetModel } from '../src/lib/SheetModel.ts'
    import { FormulaSheet } from '../src/lib/FormulaSheet.ts'

    window.SheetModel = SheetModel
    window.FormulaSheet = FormulaSheet

    function displayResult(elementId, content, passed = true) {
      const element = document.getElementById(elementId)
      const statusClass = passed ? 'pass' : 'fail'
      const statusText = passed ? 'âœ… æµ‹è¯•é€šè¿‡' : 'âŒ æµ‹è¯•å¤±è´¥'
      element.innerHTML = `<span class="${statusClass}">${statusText}</span>\n\n${content}`
    }

    // æµ‹è¯• 1: ç›¸å¯¹å¼•ç”¨ vs ç»å¯¹å¼•ç”¨
    window.test1 = function() {
      const model = new SheetModel()
      const sheet = new FormulaSheet(model, false)  // ç¦ç”¨å¼‚æ­¥ï¼Œä¾¿äºæµ‹è¯•

      // è®¾ç½®åˆå§‹æ•°æ®
      sheet.setValue(0, 0, '10')  // A1 = 10
      sheet.setValue(1, 0, '20')  // A2 = 20

      // B1: ç›¸å¯¹å¼•ç”¨
      sheet.setValue(0, 1, '=A1')
      // C1: ç»å¯¹å¼•ç”¨
      sheet.setValue(0, 2, '=$A$1')

      const before_B1 = sheet.getDisplayValue(0, 1)
      const before_C1 = sheet.getDisplayValue(0, 2)
      const before_B1_value = sheet.getValue(0, 1)
      const before_C1_value = sheet.getValue(0, 2)

      // åœ¨ç¬¬ 1 è¡Œå‰æ’å…¥æ–°è¡Œ
      sheet.adjustAllFormulas('insertRow', 0, 1)

      const after_B1 = sheet.getDisplayValue(1, 1)  // B2 (åŸ B1)
      const after_C1 = sheet.getDisplayValue(1, 2)  // C2 (åŸ C1)
      const after_B1_value = sheet.getValue(1, 1)
      const after_C1_value = sheet.getValue(1, 2)

      const test1_pass = after_B1 === '=A2'  // ç›¸å¯¹å¼•ç”¨åº”è¯¥è°ƒæ•´ä¸º A2
      const test2_pass = after_C1 === '=$A$1' // ç»å¯¹å¼•ç”¨åº”è¯¥ä¿æŒ $A$1
      const test3_pass = after_B1_value === 20  // B2 ç°åœ¨åº”è¯¥å¼•ç”¨ A2 (å€¼ä¸º 20)
      const test4_pass = after_C1_value === 10  // C2 åº”è¯¥å¼•ç”¨ $A$1ï¼Œä½† A1 ç°åœ¨æ˜¯ç©ºçš„ï¼Œå€¼ä¸º 0 æˆ– undefined

      let result = `
ğŸ“‹ <strong>åˆå§‹çŠ¶æ€ï¼š</strong>
  A1 = 10
  A2 = 20
  B1 = ${before_B1} (ç›¸å¯¹å¼•ç”¨) â†’ è®¡ç®—å€¼: ${before_B1_value}
  C1 = ${before_C1} (ç»å¯¹å¼•ç”¨) â†’ è®¡ç®—å€¼: ${before_C1_value}

âš¡ <strong>æ“ä½œï¼š</strong>åœ¨ç¬¬ 1 è¡Œå‰æ’å…¥ 1 è¡Œ

ğŸ“Š <strong>æ’å…¥åçš„æ•°æ®ä½ç½®ï¼š</strong>
  A1 = (ç©º)
  A2 = 10 (åŸ A1)
  A3 = 20 (åŸ A2)
  B2 = ${after_B1} (åŸ B1) â†’ è®¡ç®—å€¼: ${after_B1_value}  ${test3_pass ? 'âœ…' : 'âŒ'} (é¢„æœŸ: 20)
  C2 = ${after_C1} (åŸ C1) â†’ è®¡ç®—å€¼: ${after_C1_value}  ${test4_pass ? 'âœ…' : 'âŒ'} (é¢„æœŸ: 0 æˆ–ç©º)

ğŸ“ <strong>å…¬å¼éªŒè¯ï¼š</strong>
  åŸ B1 â†’ B2 = ${after_B1}  ${test1_pass ? 'âœ…' : 'âŒ'} (é¢„æœŸ: =A2)
  åŸ C1 â†’ C2 = ${after_C1}  ${test2_pass ? 'âœ…' : 'âŒ'} (é¢„æœŸ: =$A$1)

ğŸ’¡ <strong>è¯´æ˜ï¼š</strong>
  - ç›¸å¯¹å¼•ç”¨ A1â†’A2ï¼šå› ä¸ºå…¬å¼å’Œæ•°æ®éƒ½ä¸‹ç§»ï¼Œç›¸å¯¹ä½ç½®ä¿æŒä¸å˜
  - ç»å¯¹å¼•ç”¨ $A$1ï¼šå§‹ç»ˆæŒ‡å‘ç¬¬1è¡Œç¬¬Aåˆ—ï¼Œå³ä½¿æ’å…¥åå˜ä¸ºç©º
  - B2 è®¡ç®—å€¼åº”ä¸º 20 (A2çš„å€¼)
  - C2 è®¡ç®—å€¼åº”ä¸º 0 (A1ç°åœ¨æ˜¯ç©ºçš„)
`

      displayResult('result1', result, test1_pass && test2_pass && test3_pass)
    }

    // æµ‹è¯• 2: æ··åˆå¼•ç”¨ - åˆ—ç»å¯¹
    window.test2 = function() {
      const model = new SheetModel()
      const sheet = new FormulaSheet(model)

      sheet.setValue(0, 0, '100')  // A1 = 100
      sheet.setValue(1, 0, '=A1')  // A2 = A1
      sheet.setValue(0, 1, '=$A1')  // B1 = $A1 (åˆ—ç»å¯¹ï¼Œè¡Œç›¸å¯¹)

      const before = sheet.getDisplayValue(0, 1)

      // åœ¨åˆ— A å·¦ä¾§æ’å…¥æ–°åˆ—
      sheet.adjustAllFormulas('insertCol', 0, 1)

      const after = sheet.getDisplayValue(0, 2)  // C1 (åŸ B1)
      const test_pass = after === '=$A1'  // åˆ—ä¿æŒ $Aï¼Œè¡Œä¿æŒ 1

      let result = `
ğŸ“‹ <strong>åˆå§‹çŠ¶æ€ï¼š</strong>
  A1 = 100
  B1 = ${before} (åˆ—ç»å¯¹ $Aï¼Œè¡Œç›¸å¯¹ 1)

âš¡ <strong>æ“ä½œï¼š</strong>åœ¨åˆ— A å·¦ä¾§æ’å…¥ 1 åˆ—

ğŸ“Š <strong>ç»“æœï¼š</strong>
  åŸ B1 â†’ C1 = ${after}  ${test_pass ? 'âœ…' : 'âŒ'} (é¢„æœŸ: =$A1)

ğŸ’¡ <strong>è¯´æ˜ï¼š</strong>
  - åˆ—æ ‡è®° $A ä¿æŒä¸å˜ (ç»å¯¹å¼•ç”¨)
  - è¡Œå· 1 ä¿æŒä¸å˜ (å› ä¸ºæ²¡æœ‰æ’å…¥è¡Œ)
  - å³ä½¿ B1 ç§»åˆ°äº† C1ï¼Œä¾ç„¶å¼•ç”¨ $A1
`

      displayResult('result2', result, test_pass)
    }

    // æµ‹è¯• 3: æ··åˆå¼•ç”¨ - è¡Œç»å¯¹
    window.test3 = function() {
      const model = new SheetModel()
      const sheet = new FormulaSheet(model)

      sheet.setValue(0, 0, '100')  // A1 = 100
      sheet.setValue(1, 0, '=A$1')  // A2 = A$1 (è¡Œç»å¯¹ï¼Œåˆ—ç›¸å¯¹)

      const before = sheet.getDisplayValue(1, 0)

      // åœ¨ç¬¬ 1 è¡Œå‰æ’å…¥æ–°è¡Œ
      sheet.adjustAllFormulas('insertRow', 0, 1)

      const after = sheet.getDisplayValue(2, 0)  // A3 (åŸ A2)
      const test_pass = after === '=A$1'  // åˆ—ä¿æŒ Aï¼Œè¡Œä¿æŒ $1

      let result = `
ğŸ“‹ <strong>åˆå§‹çŠ¶æ€ï¼š</strong>
  A1 = 100
  A2 = ${before} (è¡Œç»å¯¹ $1ï¼Œåˆ—ç›¸å¯¹ A)

âš¡ <strong>æ“ä½œï¼š</strong>åœ¨ç¬¬ 1 è¡Œå‰æ’å…¥ 1 è¡Œ

ğŸ“Š <strong>ç»“æœï¼š</strong>
  åŸ A2 â†’ A3 = ${after}  ${test_pass ? 'âœ…' : 'âŒ'} (é¢„æœŸ: =A$1)

ğŸ’¡ <strong>è¯´æ˜ï¼š</strong>
  - è¡Œå· $1 ä¿æŒä¸å˜ (ç»å¯¹å¼•ç”¨)
  - åˆ—æ ‡è®° A ä¿æŒä¸å˜ (å› ä¸ºæ²¡æœ‰æ’å…¥åˆ—)
  - å§‹ç»ˆå¼•ç”¨ç¬¬ 1 è¡Œçš„æ•°æ®
`

      displayResult('result3', result, test_pass)
    }

    // æµ‹è¯• 4: å¤åˆ¶ç²˜è´´æ—¶çš„ç»å¯¹å¼•ç”¨
    window.test4 = function() {
      const model = new SheetModel()
      const sheet = new FormulaSheet(model)

      sheet.setValue(0, 0, '999')  // A1 = 999 (å¸¸é‡)
      sheet.setValue(0, 1, '10')   // B1 = 10
      sheet.setValue(1, 1, '=$A$1+B1')  // B2 = $A$1+B1

      const before = sheet.getDisplayValue(1, 1)

      // å¤åˆ¶ B2 åˆ° D4
      sheet.copyCell(1, 1, 3, 3)

      const after = sheet.getDisplayValue(3, 3)
      const test_pass = after === '=$A$1+D3'  // $A$1 ä¸å˜ï¼ŒB1â†’D3

      let result = `
ğŸ“‹ <strong>åˆå§‹çŠ¶æ€ï¼š</strong>
  A1 = 999 (å¸¸é‡)
  B1 = 10
  B2 = ${before}

âš¡ <strong>æ“ä½œï¼š</strong>å¤åˆ¶ B2 åˆ° D4

ğŸ“Š <strong>ç»“æœï¼š</strong>
  D4 = ${after}  ${test_pass ? 'âœ…' : 'âŒ'} (é¢„æœŸ: =$A$1+D3)

ğŸ’¡ <strong>è¯´æ˜ï¼š</strong>
  - ç»å¯¹å¼•ç”¨ $A$1 ä¿æŒä¸å˜ (å§‹ç»ˆå¼•ç”¨å¸¸é‡å•å…ƒæ ¼)
  - ç›¸å¯¹å¼•ç”¨ B1 è°ƒæ•´ä¸º D3 (ç›¸å¯¹ä½ç½®ä¸å˜)
  - è¿™æ˜¯ Excel ä¸­å¸¸è§çš„æ¨¡å¼ï¼šç”¨ç»å¯¹å¼•ç”¨é”å®šå¸¸é‡
`

      displayResult('result4', result, test_pass)
    }

    // æµ‹è¯• 5: ç»¼åˆæµ‹è¯•
    window.test5 = function() {
      const model = new SheetModel()
      const sheet = new FormulaSheet(model)

      sheet.setValue(0, 0, '100')  // A1 = 100 (ç¨ç‡)
      sheet.setValue(0, 1, '1000') // B1 = 1000 (é‡‘é¢1)
      sheet.setValue(1, 1, '2000') // B2 = 2000 (é‡‘é¢2)
      sheet.setValue(2, 1, '3000') // B3 = 3000 (é‡‘é¢3)

      // Cåˆ—ï¼šè®¡ç®—å«ç¨é‡‘é¢ = é‡‘é¢ * (1 + $A$1)
      sheet.setValue(0, 2, '=B1*(1+$A$1/100)')
      sheet.setValue(1, 2, '=B2*(1+$A$1/100)')
      sheet.setValue(2, 2, '=B3*(1+$A$1/100)')

      const before1 = sheet.getDisplayValue(0, 2)
      const before2 = sheet.getDisplayValue(1, 2)
      const before3 = sheet.getDisplayValue(2, 2)

      // åœ¨ç¬¬ 1 è¡Œå‰æ’å…¥æ–°è¡Œ
      sheet.adjustAllFormulas('insertRow', 0, 1)

      const after1 = sheet.getDisplayValue(1, 2)  // C2 (åŸ C1)
      const after2 = sheet.getDisplayValue(2, 2)  // C3 (åŸ C2)
      const after3 = sheet.getDisplayValue(3, 2)  // C4 (åŸ C3)

      const test1 = after1 === '=B2*(1+$A$1/100)'
      const test2 = after2 === '=B3*(1+$A$1/100)'
      const test3 = after3 === '=B4*(1+$A$1/100)'

      let result = `
ğŸ“‹ <strong>åœºæ™¯ï¼š</strong>è®¡ç®—å«ç¨é‡‘é¢è¡¨
  A1 = 100 (ç¨ç‡å¸¸é‡)
  Båˆ— = é‡‘é¢
  Cåˆ— = å«ç¨é‡‘é¢ (ä½¿ç”¨ç»å¯¹å¼•ç”¨ç¨ç‡)

<strong>åˆå§‹å…¬å¼ï¼š</strong>
  C1 = ${before1}
  C2 = ${before2}
  C3 = ${before3}

âš¡ <strong>æ“ä½œï¼š</strong>åœ¨ç¬¬ 1 è¡Œå‰æ’å…¥æ ‡é¢˜è¡Œ

ğŸ“Š <strong>ç»“æœï¼š</strong>
  C2 = ${after1}  ${test1 ? 'âœ…' : 'âŒ'}
  C3 = ${after2}  ${test2 ? 'âœ…' : 'âŒ'}
  C4 = ${after3}  ${test3 ? 'âœ…' : 'âŒ'}

ğŸ’¡ <strong>è¯´æ˜ï¼š</strong>
  - æ‰€æœ‰å…¬å¼ä¸­çš„ $A$1 ä¿æŒä¸å˜ (ç¨ç‡ä½ç½®å›ºå®š)
  - ç›¸å¯¹å¼•ç”¨ B1â†’B2, B2â†’B3, B3â†’B4 (è·Ÿéšæ•°æ®ç§»åŠ¨)
  - è¿™æ˜¯ Excel ä¸­å…¸å‹çš„"å›ºå®šå¸¸é‡"åº”ç”¨åœºæ™¯
`

      displayResult('result5', result, test1 && test2 && test3)
    }

    // æµ‹è¯• 6: åˆ é™¤è¡Œåˆ—å¯¹ç»å¯¹å¼•ç”¨çš„å½±å“
    window.test6 = function() {
      const model = new SheetModel()
      const sheet = new FormulaSheet(model)

      sheet.setValue(0, 0, '100')  // A1 = 100
      sheet.setValue(1, 0, '=$A$1*2')  // A2 = $A$1*2

      const before = sheet.getDisplayValue(1, 0)

      // åˆ é™¤ç¬¬ 1 è¡Œ (A1 è¢«åˆ é™¤)
      sheet.adjustAllFormulas('deleteRow', 0, 1)

      const after = sheet.getDisplayValue(0, 0)  // A1 (åŸ A2)
      const test_pass = after.includes('#REF!')  // åº”è¯¥åŒ…å« #REF!

      let result = `
ğŸ“‹ <strong>åˆå§‹çŠ¶æ€ï¼š</strong>
  A1 = 100
  A2 = ${before}

âš¡ <strong>æ“ä½œï¼š</strong>åˆ é™¤ç¬¬ 1 è¡Œ (A1 è¢«åˆ é™¤)

ğŸ“Š <strong>ç»“æœï¼š</strong>
  æ–° A1 (åŸ A2) = ${after}  ${test_pass ? 'âœ…' : 'âŒ'}

ğŸ’¡ <strong>è¯´æ˜ï¼š</strong>
  - å½“ç»å¯¹å¼•ç”¨çš„å•å…ƒæ ¼è¢«åˆ é™¤æ—¶ï¼Œå¼•ç”¨å˜ä¸º #REF! é”™è¯¯
  - è¿™ä¸ Excel çš„è¡Œä¸ºå®Œå…¨ä¸€è‡´
  - #REF! è¡¨ç¤º"å¼•ç”¨é”™è¯¯"
`

      displayResult('result6', result, test_pass)
    }

    console.log('âœ… ç»å¯¹å¼•ç”¨æµ‹è¯•é¡µé¢å·²åŠ è½½')
    console.log('ğŸ’¡ ç‚¹å‡»å„ä¸ªæµ‹è¯•æŒ‰é’®éªŒè¯åŠŸèƒ½')
  </script>
</body>
</html>
