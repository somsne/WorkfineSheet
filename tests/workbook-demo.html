<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¤šå·¥ä½œè¡¨æ¼”ç¤º - WorkfineSheet</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f5f5f5;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    header {
      background: #2c3e50;
      color: white;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    header h1 {
      font-size: 18px;
      font-weight: 500;
    }
    
    .toolbar {
      display: flex;
      gap: 10px;
      flex: 1;
    }
    
    .toolbar button {
      padding: 6px 12px;
      border: none;
      background: #3498db;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    
    .toolbar button:hover {
      background: #2980b9;
    }
    
    .toolbar button:active {
      background: #1f618d;
    }
    
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    #workbook-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .info-panel {
      background: #ecf0f1;
      padding: 10px 20px;
      border-top: 1px solid #bdc3c7;
      font-size: 13px;
      display: flex;
      gap: 30px;
    }
    
    .info-item {
      display: flex;
      gap: 8px;
    }
    
    .info-label {
      color: #7f8c8d;
    }
    
    .info-value {
      font-weight: 500;
      color: #2c3e50;
    }
    
    /* æš—é»‘æ¨¡å¼æ”¯æŒ */
    @media (prefers-color-scheme: dark) {
      body {
        background: #1a1a2e;
      }
      
      header {
        background: #16213e;
      }
      
      .info-panel {
        background: #0f0f23;
        border-top-color: #333;
      }
      
      .info-label {
        color: #888;
      }
      
      .info-value {
        color: #e0e0e0;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ“Š å¤šå·¥ä½œè¡¨æ¼”ç¤º</h1>
    <div class="toolbar">
      <button onclick="addSheet()">+ æ–°å»ºå·¥ä½œè¡¨</button>
      <button onclick="duplicateSheet()">å¤åˆ¶å½“å‰å·¥ä½œè¡¨</button>
      <button onclick="removeSheet()">åˆ é™¤å½“å‰å·¥ä½œè¡¨</button>
      <button onclick="renameSheet()">é‡å‘½å</button>
      <button onclick="testCrossSheet()">è·¨è¡¨å…¬å¼æµ‹è¯•</button>
      <button onclick="exportJSON()">å¯¼å‡º JSON</button>
    </div>
  </header>
  
  <main>
    <div id="workbook-container"></div>
    <div class="info-panel">
      <div class="info-item">
        <span class="info-label">æ´»åŠ¨å·¥ä½œè¡¨:</span>
        <span class="info-value" id="activeSheet">-</span>
      </div>
      <div class="info-item">
        <span class="info-label">å·¥ä½œè¡¨æ•°é‡:</span>
        <span class="info-value" id="sheetCount">-</span>
      </div>
      <div class="info-item">
        <span class="info-label">å½“å‰é€‰åŒº:</span>
        <span class="info-value" id="selection">-</span>
      </div>
    </div>
  </main>

  <script type="module">
    import { createApp, ref, onMounted, nextTick } from 'vue'
    import WorkbookSheet from '../src/components/WorkbookSheet.vue'
    
    // å…¨å±€å˜é‡
    let workbookRef = null
    
    const app = createApp({
      components: { WorkbookSheet },
      template: `
        <WorkbookSheet 
          ref="workbookRef"
          :initial-sheets="['é”€å”®æ•°æ®', 'äº§å“åˆ—è¡¨', 'æ±‡æ€»è¡¨']"
          @sheet-change="onSheetChange"
          @sheet-add="onSheetAdd"
          @sheet-delete="onSheetDelete"
          @sheet-rename="onSheetRename"
          @loaded="onLoaded"
        />
      `,
      setup() {
        const workbookRefLocal = ref(null)
        
        const updateInfo = () => {
          if (!workbookRefLocal.value) return
          
          const wb = workbookRefLocal.value.getWorkbook()
          const activeSheet = wb.getActiveSheet()
          const selection = workbookRefLocal.value.getSelection()
          
          document.getElementById('activeSheet').textContent = activeSheet?.metadata.name || '-'
          document.getElementById('sheetCount').textContent = wb.getSheetCount()
          document.getElementById('selection').textContent = 
            selection.row >= 0 ? `R${selection.row + 1}C${selection.col + 1}` : '-'
        }
        
        const onSheetChange = (sheetId, sheetName) => {
          console.log('å·¥ä½œè¡¨åˆ‡æ¢:', sheetName)
          nextTick(updateInfo)
        }
        
        const onSheetAdd = (sheetId, sheetName) => {
          console.log('æ–°å¢å·¥ä½œè¡¨:', sheetName)
          nextTick(updateInfo)
        }
        
        const onSheetDelete = (sheetId, sheetName) => {
          console.log('åˆ é™¤å·¥ä½œè¡¨:', sheetName)
          nextTick(updateInfo)
        }
        
        const onSheetRename = (sheetId, oldName, newName) => {
          console.log('é‡å‘½åå·¥ä½œè¡¨:', oldName, '->', newName)
          nextTick(updateInfo)
        }
        
        const onLoaded = () => {
          console.log('å·¥ä½œç°¿åŠ è½½å®Œæˆ')
          
          // åˆå§‹åŒ–å„å·¥ä½œè¡¨çš„æ¼”ç¤ºæ•°æ®
          nextTick(() => {
            const wb = workbookRefLocal.value.getWorkbook()
            
            // é”€å”®æ•°æ®è¡¨
            const salesSheet = wb.getSheetByName('é”€å”®æ•°æ®')
            if (salesSheet) {
              salesSheet.model.setValue(0, 0, 'äº§å“')
              salesSheet.model.setValue(0, 1, 'æ•°é‡')
              salesSheet.model.setValue(0, 2, 'å•ä»·')
              salesSheet.model.setValue(0, 3, 'é‡‘é¢')
              
              salesSheet.model.setValue(1, 0, 'ç¬”è®°æœ¬ç”µè„‘')
              salesSheet.model.setValue(1, 1, '10')
              salesSheet.model.setValue(1, 2, '5000')
              salesSheet.model.setValue(1, 3, '=B2*C2')
              
              salesSheet.model.setValue(2, 0, 'æ˜¾ç¤ºå™¨')
              salesSheet.model.setValue(2, 1, '20')
              salesSheet.model.setValue(2, 2, '2000')
              salesSheet.model.setValue(2, 3, '=B3*C3')
              
              salesSheet.model.setValue(3, 0, 'é”®ç›˜')
              salesSheet.model.setValue(3, 1, '50')
              salesSheet.model.setValue(3, 2, '200')
              salesSheet.model.setValue(3, 3, '=B4*C4')
              
              salesSheet.model.setValue(5, 0, 'æ€»è®¡')
              salesSheet.model.setValue(5, 3, '=SUM(D2:D4)')
            }
            
            // äº§å“åˆ—è¡¨è¡¨
            const productSheet = wb.getSheetByName('äº§å“åˆ—è¡¨')
            if (productSheet) {
              productSheet.model.setValue(0, 0, 'äº§å“ç¼–å·')
              productSheet.model.setValue(0, 1, 'äº§å“åç§°')
              productSheet.model.setValue(0, 2, 'ç±»åˆ«')
              productSheet.model.setValue(0, 3, 'åº“å­˜')
              
              productSheet.model.setValue(1, 0, 'P001')
              productSheet.model.setValue(1, 1, 'ç¬”è®°æœ¬ç”µè„‘')
              productSheet.model.setValue(1, 2, 'ç”µå­äº§å“')
              productSheet.model.setValue(1, 3, '100')
              
              productSheet.model.setValue(2, 0, 'P002')
              productSheet.model.setValue(2, 1, 'æ˜¾ç¤ºå™¨')
              productSheet.model.setValue(2, 2, 'ç”µå­äº§å“')
              productSheet.model.setValue(2, 3, '200')
              
              productSheet.model.setValue(3, 0, 'P003')
              productSheet.model.setValue(3, 1, 'é”®ç›˜')
              productSheet.model.setValue(3, 2, 'å¤–è®¾')
              productSheet.model.setValue(3, 3, '500')
            }
            
            // æ±‡æ€»è¡¨
            const summarySheet = wb.getSheetByName('æ±‡æ€»è¡¨')
            if (summarySheet) {
              summarySheet.model.setValue(0, 0, 'è·¨è¡¨å¼•ç”¨æ¼”ç¤º')
              summarySheet.model.setValue(2, 0, 'é”€å”®æ•°æ®æ€»è®¡:')
              summarySheet.model.setValue(2, 1, "='é”€å”®æ•°æ®'!D6")
              
              summarySheet.model.setValue(4, 0, 'äº§å“æ€»åº“å­˜:')
              summarySheet.model.setValue(4, 1, "=SUM('äº§å“åˆ—è¡¨'!D2:D4)")
            }
            
            updateInfo()
            workbookRefLocal.value.redraw()
          })
        }
        
        onMounted(() => {
          workbookRef = workbookRefLocal.value
          window.workbookRef = workbookRef
          
          // å®šæœŸæ›´æ–°é€‰åŒºä¿¡æ¯
          setInterval(updateInfo, 500)
        })
        
        return {
          workbookRef: workbookRefLocal,
          onSheetChange,
          onSheetAdd,
          onSheetDelete,
          onSheetRename,
          onLoaded
        }
      }
    })
    
    app.mount('#workbook-container')
    
    // å…¨å±€å‡½æ•°
    window.addSheet = () => {
      if (workbookRef) {
        const name = prompt('è¯·è¾“å…¥å·¥ä½œè¡¨åç§°:')
        if (name) {
          workbookRef.addSheet(name)
        }
      }
    }
    
    window.duplicateSheet = () => {
      if (workbookRef) {
        const wb = workbookRef.getWorkbook()
        const activeSheet = wb.getActiveSheet()
        if (activeSheet) {
          wb.duplicateSheet(activeSheet.metadata.id)
        }
      }
    }
    
    window.removeSheet = () => {
      if (workbookRef) {
        const wb = workbookRef.getWorkbook()
        if (wb.getSheetCount() <= 1) {
          alert('æ— æ³•åˆ é™¤æœ€åä¸€ä¸ªå·¥ä½œè¡¨')
          return
        }
        const activeSheet = wb.getActiveSheet()
        if (activeSheet && confirm(`ç¡®å®šè¦åˆ é™¤å·¥ä½œè¡¨ "${activeSheet.metadata.name}" å—ï¼Ÿ`)) {
          workbookRef.removeSheet(activeSheet.metadata.id)
        }
      }
    }
    
    window.renameSheet = () => {
      if (workbookRef) {
        const wb = workbookRef.getWorkbook()
        const activeSheet = wb.getActiveSheet()
        if (activeSheet) {
          const newName = prompt('è¯·è¾“å…¥æ–°åç§°:', activeSheet.metadata.name)
          if (newName && newName !== activeSheet.metadata.name) {
            workbookRef.renameSheet(activeSheet.metadata.id, newName)
          }
        }
      }
    }
    
    window.testCrossSheet = () => {
      if (workbookRef) {
        const wb = workbookRef.getWorkbook()
        // åˆ‡æ¢åˆ°æ±‡æ€»è¡¨
        const summarySheet = wb.getSheetByName('æ±‡æ€»è¡¨')
        if (summarySheet) {
          wb.setActiveSheet(summarySheet.metadata.id)
          alert('å·²åˆ‡æ¢åˆ°æ±‡æ€»è¡¨ï¼Œè¯¥è¡¨åŒ…å«è·¨è¡¨å…¬å¼å¼•ç”¨ç¤ºä¾‹')
        }
      }
    }
    
    window.exportJSON = () => {
      if (workbookRef) {
        const json = workbookRef.toJSON()
        console.log('å·¥ä½œç°¿ JSON:', json)
        const blob = new Blob([JSON.stringify(json, null, 2)], { type: 'application/json' })
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url
        a.download = 'workbook.json'
        a.click()
        URL.revokeObjectURL(url)
      }
    }
  </script>
</body>
</html>
