<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¡¨æ ¼æ¸²æŸ“æ€§èƒ½æµ‹è¯• - WorkfineSheet</title>
  <style>
    :root {
      --primary: #667eea;
      --success: #48bb78;
      --warning: #ed8936;
      --danger: #f56565;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
    }
    
    .navbar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .navbar a { color: white; text-decoration: none; opacity: 0.8; }
    .navbar a:hover { opacity: 1; }
    .navbar h1 { font-size: 1.25rem; flex: 1; }
    
    .container { max-width: 1400px; margin: 0 auto; padding: 24px; }
    
    .main-layout {
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 24px;
    }
    
    @media (max-width: 1024px) {
      .main-layout {
        grid-template-columns: 1fr;
      }
    }
    
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .card h3 {
      color: #1f2937;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1rem;
    }
    
    .card .desc {
      color: #6b7280;
      font-size: 0.85rem;
      margin-bottom: 16px;
      line-height: 1.5;
    }
    
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    
    .metric-card {
      background: #f9fafb;
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }
    
    .metric-card .value {
      font-size: 1.25rem;
      font-weight: 700;
      color: #667eea;
    }
    
    .metric-card .label {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 2px;
    }
    
    .controls {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover { background: #5a67d8; }
    .btn-primary:disabled { background: #a0aec0; cursor: not-allowed; }
    
    .btn-secondary {
      background: #e2e8f0;
      color: #4a5568;
    }
    
    .btn-secondary:hover { background: #cbd5e0; }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-warning {
      background: var(--warning);
      color: white;
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-sm {
      padding: 6px 12px;
      font-size: 0.8rem;
    }
    
    .input-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .input-row label {
      font-size: 0.85rem;
      color: #4a5568;
      min-width: 40px;
    }
    
    .input-row input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 0.85rem;
    }
    
    .progress {
      height: 4px;
      background: #e2e8f0;
      border-radius: 2px;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 100%;
      background: var(--primary);
      border-radius: 2px;
      width: 0;
      transition: width 0.3s;
    }
    
    .result {
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 0.8rem;
      background: #1f2937;
      color: #e5e7eb;
      padding: 12px;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    
    .result:empty { display: none; }
    
    .rating {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .rating.fast { background: #c6f6d5; color: #22543d; }
    .rating.medium { background: #feebc8; color: #744210; }
    .rating.slow { background: #fed7d7; color: #822727; }
    
    /* è¡¨æ ¼å®¹å™¨æ ·å¼ */
    .sheet-panel {
      display: flex;
      flex-direction: column;
    }
    
    .sheet-container {
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      overflow: hidden;
      background: white;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .sheet-container-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 10px 16px;
      font-size: 0.9rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .sheet-container-body {
      flex: 1;
      min-height: 500px;
    }
    
    .status-badge {
      background: rgba(255,255,255,0.2);
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.8rem;
    }
    
    /* å†å²è®°å½• */
    .history-list {
      max-height: 200px;
      overflow-y: auto;
    }
    
    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f3f4f6;
      font-size: 0.85rem;
    }
    
    .history-item:last-child {
      border-bottom: none;
    }
    
    .history-item .size {
      color: #6b7280;
    }
    
    .history-item .time {
      font-weight: 600;
      color: #1f2937;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <a href="index.html">â† è¿”å›æµ‹è¯•é¦–é¡µ</a>
    <h1>ğŸ“Š è¡¨æ ¼æ¸²æŸ“æ€§èƒ½æµ‹è¯•</h1>
  </nav>
  
  <div class="container">
    <div class="main-layout">
      <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
      <div class="sidebar">
        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="card">
          <h3>ğŸ“ˆ æµ‹è¯•ç»Ÿè®¡</h3>
          <div class="metrics-grid">
            <div class="metric-card">
              <div class="value" id="totalTests">0</div>
              <div class="label">æµ‹è¯•æ¬¡æ•°</div>
            </div>
            <div class="metric-card">
              <div class="value" id="totalCells">0</div>
              <div class="label">å•å…ƒæ ¼æ•°</div>
            </div>
            <div class="metric-card">
              <div class="value" id="avgRenderTime">-</div>
              <div class="label">å¹³å‡æ¸²æŸ“</div>
            </div>
            <div class="metric-card">
              <div class="value" id="avgTimePerCell">-</div>
              <div class="label">å•å…ƒæ ¼è€—æ—¶</div>
            </div>
          </div>
        </div>
        
        <!-- å¿«é€Ÿæµ‹è¯• -->
        <div class="card">
          <h3>ğŸš€ å¿«é€Ÿæµ‹è¯•</h3>
          <p class="desc">é€‰æ‹©é¢„è®¾è§„æ¨¡å¿«é€Ÿæµ‹è¯•æ¸²æŸ“æ€§èƒ½</p>
          <div class="controls">
            <div class="btn-row">
              <button class="btn-primary btn-sm" onclick="runTest(100, 10)">1K</button>
              <button class="btn-primary btn-sm" onclick="runTest(500, 20)">10K</button>
              <button class="btn-primary btn-sm" onclick="runTest(1000, 26)">26K</button>
              <button class="btn-warning btn-sm" onclick="runTest(2000, 30)">60K</button>
              <button class="btn-warning btn-sm" onclick="runTest(5000, 50)">250K</button>
              <button class="btn-danger btn-sm" onclick="runTest(10000, 50)">500K</button>
            </div>
          </div>
        </div>
        
        <!-- è‡ªå®šä¹‰æµ‹è¯• -->
        <div class="card">
          <h3>âš™ï¸ è‡ªå®šä¹‰æµ‹è¯•</h3>
          <p class="desc">è¾“å…¥è‡ªå®šä¹‰çš„è¡Œåˆ—æ•°è¿›è¡Œæµ‹è¯•</p>
          <div class="controls">
            <div class="input-row">
              <label>è¡Œæ•°:</label>
              <input type="number" id="customRows" value="1000" min="1" max="100000">
            </div>
            <div class="input-row">
              <label>åˆ—æ•°:</label>
              <input type="number" id="customCols" value="26" min="1" max="100">
            </div>
            <div class="btn-row">
              <button class="btn-success" onclick="runCustomTest()">å¼€å§‹æµ‹è¯•</button>
              <button class="btn-secondary" onclick="clearSheet()">æ¸…ç©ºè¡¨æ ¼</button>
            </div>
          </div>
        </div>
        
        <!-- å‹åŠ›æµ‹è¯• -->
        <div class="card">
          <h3>ğŸ”¥ å‹åŠ›æµ‹è¯•</h3>
          <p class="desc">é€æ­¥å¢åŠ æ•°æ®é‡æµ‹è¯•æ€§èƒ½æé™</p>
          <div class="controls">
            <div class="btn-row">
              <button class="btn-danger" onclick="runStressTest()">å¼€å§‹å‹åŠ›æµ‹è¯•</button>
            </div>
          </div>
        </div>
        
        <!-- è¿›åº¦å’Œæ—¥å¿— -->
        <div class="card">
          <h3>ğŸ“‹ æµ‹è¯•æ—¥å¿—</h3>
          <div class="progress" style="margin-bottom: 12px;">
            <div class="progress-bar" id="progressBar"></div>
          </div>
          <div id="result" class="result"></div>
        </div>
        
        <!-- å†å²è®°å½• -->
        <div class="card">
          <h3>ğŸ“œ æµ‹è¯•å†å²</h3>
          <div class="history-list" id="historyList">
            <div style="color: #9ca3af; font-size: 0.85rem;">æš‚æ— æµ‹è¯•è®°å½•</div>
          </div>
        </div>
      </div>
      
      <!-- å³ä¾§è¡¨æ ¼åŒºåŸŸ -->
      <div class="sheet-panel">
        <div class="sheet-container">
          <div class="sheet-container-header">
            <span>ğŸ“Š WorkfineSheet é¢„è§ˆ</span>
            <span class="status-badge" id="sheetStatus">å°±ç»ª</span>
          </div>
          <div class="sheet-container-body" id="sheetMount"></div>
        </div>
      </div>
    </div>
  </div>
  
  <script type="module">
    import { Workbook } from '../src/lib/Workbook.js'
    import { createApp, h, shallowRef, nextTick } from 'vue'
    import WorkbookSheet from '../src/components/WorkbookSheet.vue'
    
    // ==================== å…¨å±€çŠ¶æ€ ====================
    let testResults = []
    let isRunning = false
    let sheetApp = null
    let workbook = null
    let sheetApi = null
    
    // ==================== å·¥å…·å‡½æ•° ====================
    function formatNumber(num) {
      if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M'
      if (num >= 1000) return (num / 1000).toFixed(1) + 'K'
      return num.toString()
    }
    
    function formatTime(ms) {
      if (ms < 1) return ms.toFixed(3) + ' ms'
      if (ms < 1000) return ms.toFixed(2) + ' ms'
      return (ms / 1000).toFixed(2) + ' s'
    }
    
    function getRating(timePerCell) {
      if (timePerCell < 0.5) return { text: 'æé€Ÿ', class: 'fast' }
      if (timePerCell < 2) return { text: 'ä¼˜ç§€', class: 'fast' }
      if (timePerCell < 5) return { text: 'è‰¯å¥½', class: 'medium' }
      if (timePerCell < 20) return { text: 'ä¸€èˆ¬', class: 'medium' }
      return { text: 'è¾ƒæ…¢', class: 'slow' }
    }
    
    function updateProgress(percent) {
      document.getElementById('progressBar').style.width = percent + '%'
    }
    
    function log(message, clear = false) {
      const el = document.getElementById('result')
      if (clear) {
        el.textContent = message + '\n'
      } else {
        el.textContent += message + '\n'
      }
      el.scrollTop = el.scrollHeight
    }
    
    function updateStatus(text) {
      document.getElementById('sheetStatus').textContent = text
    }
    
    function updateMetrics() {
      document.getElementById('totalTests').textContent = testResults.length
      
      if (testResults.length > 0) {
        const totalCells = testResults.reduce((sum, r) => sum + r.cellCount, 0)
        const avgRender = testResults.reduce((sum, r) => sum + r.renderTime, 0) / testResults.length
        const avgPerCell = testResults.reduce((sum, r) => sum + r.timePerCell, 0) / testResults.length
        
        document.getElementById('totalCells').textContent = formatNumber(totalCells)
        document.getElementById('avgRenderTime').textContent = formatTime(avgRender)
        document.getElementById('avgTimePerCell').textContent = avgPerCell.toFixed(2) + ' Î¼s'
      }
    }
    
    function updateHistory() {
      const list = document.getElementById('historyList')
      if (testResults.length === 0) {
        list.innerHTML = '<div style="color: #9ca3af; font-size: 0.85rem;">æš‚æ— æµ‹è¯•è®°å½•</div>'
        return
      }
      
      // æ˜¾ç¤ºæœ€è¿‘ 10 æ¡
      const recent = testResults.slice(-10).reverse()
      list.innerHTML = recent.map(r => {
        const rating = getRating(r.timePerCell)
        return `
          <div class="history-item">
            <span class="size">${r.rows}Ã—${r.cols}</span>
            <span class="time">${formatTime(r.renderTime)}</span>
            <span class="rating ${rating.class}">${rating.text}</span>
          </div>
        `
      }).join('')
    }
    
    // ==================== åˆå§‹åŒ–è¡¨æ ¼ ====================
    async function initSheet() {
      const mountPoint = document.getElementById('sheetMount')
      
      // åˆ›å»º Workbook
      workbook = new Workbook()
      
      // åˆ›å»º Vue åº”ç”¨
      const app = createApp({
        setup() {
          const workbookRef = shallowRef(workbook)
          const sheetRef = shallowRef(null)
          
          // æš´éœ² ref ä¾›å¤–éƒ¨è®¿é—®
          const getSheetRef = () => sheetRef.value
          
          return { workbookRef, sheetRef, getSheetRef }
        },
        render() {
          return h(WorkbookSheet, {
            ref: 'sheetRef',
            workbook: this.workbookRef,
            style: { width: '100%', height: '100%' }
          })
        },
        mounted() {
          // ç»„ä»¶æŒ‚è½½åè·å–å¼•ç”¨
          sheetApi = this.$refs.sheetRef
          console.log('Sheet API ready from $refs', sheetApi)
          updateStatus('å°±ç»ª')
        }
      })
      
      // æŒ‚è½½
      sheetApp = app
      app.mount(mountPoint)
      
      // ç­‰å¾…ç»„ä»¶æŒ‚è½½
      await nextTick()
      await new Promise(r => setTimeout(r, 50))
      
      console.log('Sheet initialized, api:', !!sheetApi)
    }
    
    // ==================== æµ‹è¯•å‡½æ•° ====================
    
    // é»˜è®¤è¡¨æ ¼å°ºå¯¸
    const DEFAULT_ROWS = 200
    const DEFAULT_COLS = 50
    
    // å½“å‰è¡¨æ ¼å®é™…å°ºå¯¸ï¼ˆä¼šåŠ¨æ€æ‰©å±•ï¼‰
    let currentTotalRows = DEFAULT_ROWS
    let currentTotalCols = DEFAULT_COLS
    
    // æ‰©å±•è¡¨æ ¼è¡Œåˆ—ï¼ˆå¦‚æœéœ€è¦ï¼‰- ä½¿ç”¨ batch æ¨¡å¼é¿å…ä¸­é—´æ¸²æŸ“
    async function ensureSheetSize(targetRows, targetCols) {
      if (!sheetApi) {
        console.error('sheetApi not ready')
        return
      }
      
      const rowsToAdd = targetRows > currentTotalRows ? targetRows - currentTotalRows : 0
      const colsToAdd = targetCols > currentTotalCols ? targetCols - currentTotalCols : 0
      
      if (rowsToAdd === 0 && colsToAdd === 0) {
        return // æ— éœ€æ‰©å±•
      }
      
      // ä½¿ç”¨ batch æ¨¡å¼æ‰¹é‡æ’å…¥ï¼Œè·³è¿‡æ‰€æœ‰ä¸­é—´æ¸²æŸ“
      await workbook.batch(async () => {
        // éœ€è¦æ‰©å±•çš„è¡Œæ•°
        if (rowsToAdd > 0) {
          log(`æ‰©å±•è¡Œæ•°: ${currentTotalRows} â†’ ${targetRows} (+${rowsToAdd})`)
          // åœ¨æœ€åä¸€è¡Œä¸‹æ–¹æ‰¹é‡æ’å…¥
          await sheetApi.insertRowBelow(currentTotalRows - 1, rowsToAdd)
          currentTotalRows = targetRows
        }
        
        // éœ€è¦æ‰©å±•çš„åˆ—æ•°
        if (colsToAdd > 0) {
          log(`æ‰©å±•åˆ—æ•°: ${currentTotalCols} â†’ ${targetCols} (+${colsToAdd})`)
          // åœ¨æœ€åä¸€åˆ—å³ä¾§æ‰¹é‡æ’å…¥
          await sheetApi.insertColRight(currentTotalCols - 1, colsToAdd)
          currentTotalCols = targetCols
        }
      })
    }
    
    // å¡«å……æµ‹è¯•æ•°æ®
    function fillTestData(rows, cols) {
      const model = workbook.getActiveModel()
      if (!model) {
        console.error('No active model')
        return
      }
      
      // ä½¿ç”¨ batch æ¨¡å¼
      workbook.batch(() => {
        const data = []
        for (let r = 0; r < rows; r++) {
          const rowData = []
          for (let c = 0; c < cols; c++) {
            let value
            if (r === 0) {
              value = `åˆ—${c + 1}`
            } else if (c === 0) {
              value = r
            } else if ((r + c) % 7 === 0) {
              value = `=A${r + 1}*${c}`
            } else if ((r + c) % 3 === 0) {
              value = (Math.random() * 1000).toFixed(2)
            } else {
              value = `R${r}C${c}`
            }
            rowData.push(String(value))
          }
          data.push(rowData)
        }
        model.setValues(0, 0, data)
      })
    }
    
    // æµ‹é‡æ¸²æŸ“æ—¶é—´
    async function measureRenderTime() {
      return new Promise((resolve) => {
        const start = performance.now()
        
        if (sheetApi && sheetApi.redraw) {
          sheetApi.redraw()
        }
        
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            resolve(performance.now() - start)
          })
        })
      })
    }
    
    // è¿è¡Œæµ‹è¯•
    window.runTest = async function(rows, cols) {
      if (isRunning) {
        alert('æµ‹è¯•æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç­‰å¾…...')
        return
      }
      
      // æ£€æŸ¥ API æ˜¯å¦å°±ç»ª
      if (!sheetApi) {
        alert('è¡¨æ ¼å°šæœªåˆå§‹åŒ–å®Œæˆï¼Œè¯·ç¨å€™å†è¯•')
        return
      }
      
      isRunning = true
      const cellCount = rows * cols
      
      log(`æµ‹è¯•: ${rows}Ã—${cols} (${formatNumber(cellCount)} å•å…ƒæ ¼)`, true)
      updateProgress(10)
      updateStatus('å‡†å¤‡ä¸­...')
      
      // æ¸…ç©ºç°æœ‰æ•°æ®ï¼ˆä½¿ç”¨ sheetApi ç¡®ä¿å…¬å¼ç¼“å­˜ä¹Ÿè¢«æ¸…é™¤ï¼‰
      const model = workbook.getActiveModel()
      if (model && sheetApi) {
        let maxRow = -1, maxCol = -1
        model.forEach((r, c) => {
          if (r > maxRow) maxRow = r
          if (c > maxCol) maxCol = c
        })
        if (maxRow >= 0 && maxCol >= 0) {
          // ä½¿ç”¨ clearValues ç¡®ä¿å…¬å¼ç¼“å­˜ä¹Ÿè¢«æ¸…é™¤
          sheetApi.clearValues(0, 0, maxRow, maxCol)
        }
      }
      await nextTick()
      updateProgress(20)
      
      // æ‰©å±•è¡¨æ ¼å°ºå¯¸ï¼ˆå¦‚æœéœ€è¦ï¼‰
      log('æ£€æŸ¥è¡¨æ ¼å°ºå¯¸...')
      updateStatus('æ‰©å±•è¡¨æ ¼...')
      const expandStart = performance.now()
      await ensureSheetSize(rows, cols)
      const expandTime = performance.now() - expandStart
      if (expandTime > 1) {
        log(`è¡¨æ ¼æ‰©å±•: ${formatTime(expandTime)}`)
      }
      updateProgress(40)
      
      // ç”Ÿæˆæ•°æ®
      log('ç”Ÿæˆæµ‹è¯•æ•°æ®...')
      updateStatus(`ç”Ÿæˆ ${rows}Ã—${cols}`)
      const dataStart = performance.now()
      fillTestData(rows, cols)
      const dataTime = performance.now() - dataStart
      log(`æ•°æ®ç”Ÿæˆ: ${formatTime(dataTime)}`)
      updateProgress(55)
      
      // ç­‰å¾…å“åº”
      await nextTick()
      await new Promise(r => setTimeout(r, 50))
      updateProgress(70)
      
      // æµ‹é‡æ¸²æŸ“
      log('æµ‹é‡æ¸²æŸ“...')
      updateStatus('æµ‹é‡æ¸²æŸ“...')
      const renderTime = await measureRenderTime()
      updateProgress(90)
      
      // è®¡ç®—ç»“æœ
      const timePerCell = (renderTime * 1000) / cellCount
      const rating = getRating(timePerCell)
      
      const result = { rows, cols, cellCount, dataTime, renderTime, timePerCell, expandTime }
      testResults.push(result)
      
      // è¾“å‡ºç»“æœ
      log('')
      log(`ğŸ“Š ç»“æœ:`)
      log(`   è¡¨æ ¼å°ºå¯¸: ${currentTotalRows}Ã—${currentTotalCols}`)
      if (expandTime > 1) {
        log(`   æ‰©å±•è€—æ—¶: ${formatTime(expandTime)}`)
      }
      log(`   æ¸²æŸ“è€—æ—¶: ${formatTime(renderTime)}`)
      log(`   æ¯å•å…ƒæ ¼: ${timePerCell.toFixed(2)} Î¼s`)
      log(`   æ€§èƒ½è¯„çº§: ${rating.text}`)
      
      updateProgress(100)
      updateStatus(`${rows}Ã—${cols} - ${rating.text}`)
      updateMetrics()
      updateHistory()
      
      // ç¡®ä¿æ˜¾ç¤º
      if (sheetApi && sheetApi.redraw) {
        sheetApi.redraw()
      }
      
      isRunning = false
    }
    
    // è‡ªå®šä¹‰æµ‹è¯•
    window.runCustomTest = async function() {
      const rows = parseInt(document.getElementById('customRows').value) || 1000
      const cols = parseInt(document.getElementById('customCols').value) || 26
      await window.runTest(rows, cols)
    }
    
    // å‹åŠ›æµ‹è¯•
    window.runStressTest = async function() {
      if (isRunning) {
        alert('æµ‹è¯•æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç­‰å¾…...')
        return
      }
      
      log('========== å‹åŠ›æµ‹è¯• ==========', true)
      log('é€æ­¥å¢åŠ æ•°æ®é‡...')
      
      const testSizes = [
        { rows: 1000, cols: 26 },
        { rows: 2000, cols: 30 },
        { rows: 5000, cols: 40 },
        { rows: 10000, cols: 50 }
      ]
      
      for (const ts of testSizes) {
        await window.runTest(ts.rows, ts.cols)
        
        const lastResult = testResults[testResults.length - 1]
        if (lastResult && lastResult.timePerCell > 50) {
          log(`\nâš ï¸ æ€§èƒ½ç“¶é¢ˆ: åœ¨ ${ts.rows}Ã—${ts.cols} è§„æ¨¡æ—¶æ€§èƒ½æ˜æ˜¾ä¸‹é™`)
          break
        }
        
        await new Promise(r => setTimeout(r, 500))
      }
      
      log('\nå‹åŠ›æµ‹è¯•å®Œæˆ')
    }
    
    // æ¸…ç©ºè¡¨æ ¼
    window.clearSheet = function() {
      const model = workbook.getActiveModel()
      if (model && sheetApi) {
        let maxRow = -1, maxCol = -1
        model.forEach((r, c) => {
          if (r > maxRow) maxRow = r
          if (c > maxCol) maxCol = c
        })
        if (maxRow >= 0 && maxCol >= 0) {
          // ä½¿ç”¨ clearValues ç¡®ä¿å…¬å¼ç¼“å­˜ä¹Ÿè¢«æ¸…é™¤
          sheetApi.clearValues(0, 0, maxRow, maxCol)
        }
        // æ³¨æ„ï¼šæ¸…ç©ºæ•°æ®ä¸ä¼šç¼©å‡è¡¨æ ¼å°ºå¯¸ï¼ŒcurrentTotalRows/Cols ä¿æŒä¸å˜
        updateStatus('å·²æ¸…ç©º')
        log(`è¡¨æ ¼å·²æ¸…ç©º (å½“å‰å°ºå¯¸: ${currentTotalRows}Ã—${currentTotalCols})`, true)
      }
    }
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    initSheet()
  </script>
</body>
</html>