<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åŸºå‡†æµ‹è¯• - WorkfineSheet</title>
  <style>
    :root { --primary: #667eea; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f7fa; min-height: 100vh; }
    .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px 24px; display: flex; align-items: center; gap: 16px; }
    .navbar a { color: white; text-decoration: none; opacity: 0.8; }
    .navbar a:hover { opacity: 1; }
    .navbar h1 { font-size: 1.25rem; flex: 1; }
    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .intro { background: white; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .intro h2 { color: #1f2937; margin-bottom: 12px; }
    .intro p { color: #6b7280; line-height: 1.6; }
    .score-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; padding: 32px; color: white; text-align: center; margin: 24px 0; }
    .score-value { font-size: 4rem; font-weight: 700; line-height: 1; }
    .score-label { font-size: 1.25rem; opacity: 0.9; margin-top: 8px; }
    .score-desc { font-size: 0.9rem; opacity: 0.7; margin-top: 16px; }
    .controls { display: flex; justify-content: center; gap: 16px; margin: 24px 0; }
    button { padding: 14px 32px; background: white; color: #667eea; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: transform 0.2s, box-shadow 0.2s; }
    button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    button.running { background: #e5e7eb; color: #9ca3af; cursor: not-allowed; }
    .benchmark-list { display: grid; gap: 16px; }
    .benchmark-item { background: white; border-radius: 12px; padding: 20px; display: flex; align-items: center; gap: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .benchmark-icon { width: 48px; height: 48px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
    .benchmark-icon.render { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .benchmark-icon.formula { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .benchmark-icon.data { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .benchmark-icon.memory { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
    .benchmark-icon.interaction { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
    .benchmark-info { flex: 1; }
    .benchmark-name { font-weight: 600; color: #1f2937; margin-bottom: 4px; }
    .benchmark-desc { font-size: 0.85rem; color: #6b7280; }
    .benchmark-result { text-align: right; min-width: 120px; }
    .benchmark-score { font-size: 1.5rem; font-weight: 700; color: #667eea; }
    .benchmark-time { font-size: 0.8rem; color: #9ca3af; }
    .benchmark-status { font-size: 0.85rem; color: #9ca3af; }
    .progress-bar { width: 100%; height: 4px; background: #e5e7eb; border-radius: 2px; margin-top: 8px; overflow: hidden; }
    .progress-bar-fill { height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); width: 0%; transition: width 0.3s ease; }
    .badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; margin-left: 8px; }
    .badge.excellent { background: #d1fae5; color: #065f46; }
    .badge.good { background: #dbeafe; color: #1e40af; }
    .badge.average { background: #fef3c7; color: #92400e; }
    .badge.poor { background: #fee2e2; color: #991b1b; }
    .summary { background: white; border-radius: 12px; padding: 24px; margin-top: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .summary h3 { color: #1f2937; margin-bottom: 16px; }
    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
    .summary-item { background: #f9fafb; border-radius: 8px; padding: 16px; text-align: center; }
    .summary-value { font-size: 1.5rem; font-weight: 700; color: #667eea; }
    .summary-label { font-size: 0.85rem; color: #6b7280; margin-top: 4px; }
  </style>
</head>
<body>
  <nav class="navbar">
    <a href="index.html">â† è¿”å›</a>
    <h1>ğŸ“ˆ åŸºå‡†æµ‹è¯• (Benchmark)</h1>
  </nav>
  
  <div class="container">
    <div class="intro">
      <h2>WorkfineSheet åŸºå‡†æµ‹è¯•</h2>
      <p>è¿è¡Œæ ‡å‡†åŒ–åŸºå‡†æµ‹è¯•ï¼Œä½¿ç”¨çœŸå®çš„ SheetModel å’Œ FormulaSheet ç»„ä»¶è¯„ä¼°æ€§èƒ½ã€‚å¯ç”¨äºç‰ˆæœ¬é—´æ€§èƒ½å¯¹æ¯”å’Œå›å½’æ£€æµ‹ã€‚</p>
    </div>
    
    <div class="score-card">
      <div class="score-value" id="totalScore">--</div>
      <div class="score-label">ç»¼åˆè¯„åˆ†</div>
      <div class="score-desc" id="scoreDesc">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•</div>
    </div>
    
    <div class="controls">
      <button id="runBtn" onclick="runAllBenchmarks()">ğŸš€ è¿è¡Œå…¨éƒ¨åŸºå‡†æµ‹è¯•</button>
    </div>
    
    <div class="benchmark-list" id="benchmarkList">
      <div class="benchmark-item" data-benchmark="dataWrite">
        <div class="benchmark-icon data">ğŸ’¾</div>
        <div class="benchmark-info">
          <div class="benchmark-name">æ•°æ®å†™å…¥</div>
          <div class="benchmark-desc">SheetModel å†™å…¥ 50,000 å•å…ƒæ ¼</div>
          <div class="progress-bar"><div class="progress-bar-fill" id="progress-dataWrite"></div></div>
        </div>
        <div class="benchmark-result">
          <div class="benchmark-status" id="status-dataWrite">ç­‰å¾…æµ‹è¯•</div>
        </div>
      </div>
      
      <div class="benchmark-item" data-benchmark="dataRead">
        <div class="benchmark-icon data">ğŸ“–</div>
        <div class="benchmark-info">
          <div class="benchmark-name">æ•°æ®è¯»å–</div>
          <div class="benchmark-desc">SheetModel è¯»å– 50,000 å•å…ƒæ ¼</div>
          <div class="progress-bar"><div class="progress-bar-fill" id="progress-dataRead"></div></div>
        </div>
        <div class="benchmark-result">
          <div class="benchmark-status" id="status-dataRead">ç­‰å¾…æµ‹è¯•</div>
        </div>
      </div>
      
      <div class="benchmark-item" data-benchmark="formulaSet">
        <div class="benchmark-icon formula">ğŸ“</div>
        <div class="benchmark-info">
          <div class="benchmark-name">å…¬å¼è®¾ç½®</div>
          <div class="benchmark-desc">FormulaSheet è®¾ç½® 2,000 ä¸ªå…¬å¼</div>
          <div class="progress-bar"><div class="progress-bar-fill" id="progress-formulaSet"></div></div>
        </div>
        <div class="benchmark-result">
          <div class="benchmark-status" id="status-formulaSet">ç­‰å¾…æµ‹è¯•</div>
        </div>
      </div>
      
      <div class="benchmark-item" data-benchmark="formulaCalc">
        <div class="benchmark-icon formula">ğŸ”¢</div>
        <div class="benchmark-info">
          <div class="benchmark-name">å…¬å¼è®¡ç®—</div>
          <div class="benchmark-desc">FormulaSheet è®¡ç®— 2,000 ä¸ªå…¬å¼ç»“æœ</div>
          <div class="progress-bar"><div class="progress-bar-fill" id="progress-formulaCalc"></div></div>
        </div>
        <div class="benchmark-result">
          <div class="benchmark-status" id="status-formulaCalc">ç­‰å¾…æµ‹è¯•</div>
        </div>
      </div>
      
      <div class="benchmark-item" data-benchmark="styleSet">
        <div class="benchmark-icon interaction">ğŸ¨</div>
        <div class="benchmark-info">
          <div class="benchmark-name">æ ·å¼è®¾ç½®</div>
          <div class="benchmark-desc">SheetModel è®¾ç½® 10,000 ä¸ªå•å…ƒæ ¼æ ·å¼</div>
          <div class="progress-bar"><div class="progress-bar-fill" id="progress-styleSet"></div></div>
        </div>
        <div class="benchmark-result">
          <div class="benchmark-status" id="status-styleSet">ç­‰å¾…æµ‹è¯•</div>
        </div>
      </div>
      
      <div class="benchmark-item" data-benchmark="mergeSet">
        <div class="benchmark-icon interaction">ğŸ”—</div>
        <div class="benchmark-info">
          <div class="benchmark-name">åˆå¹¶å•å…ƒæ ¼</div>
          <div class="benchmark-desc">SheetModel åˆå¹¶/å–æ¶ˆåˆå¹¶ 500 ä¸ªåŒºåŸŸ</div>
          <div class="progress-bar"><div class="progress-bar-fill" id="progress-mergeSet"></div></div>
        </div>
        <div class="benchmark-result">
          <div class="benchmark-status" id="status-mergeSet">ç­‰å¾…æµ‹è¯•</div>
        </div>
      </div>
      
      <div class="benchmark-item" data-benchmark="mergeQuery">
        <div class="benchmark-icon data">ğŸ”</div>
        <div class="benchmark-info">
          <div class="benchmark-name">åˆå¹¶æŸ¥è¯¢</div>
          <div class="benchmark-desc">SheetModel æŸ¥è¯¢ 20,000 ä¸ªå•å…ƒæ ¼åˆå¹¶çŠ¶æ€</div>
          <div class="progress-bar"><div class="progress-bar-fill" id="progress-mergeQuery"></div></div>
        </div>
        <div class="benchmark-result">
          <div class="benchmark-status" id="status-mergeQuery">ç­‰å¾…æµ‹è¯•</div>
        </div>
      </div>
      
      <div class="benchmark-item" data-benchmark="styleQuery">
        <div class="benchmark-icon data">ğŸ”</div>
        <div class="benchmark-info">
          <div class="benchmark-name">æ ·å¼æŸ¥è¯¢</div>
          <div class="benchmark-desc">SheetModel æŸ¥è¯¢ 20,000 ä¸ªå•å…ƒæ ¼æ ·å¼</div>
          <div class="progress-bar"><div class="progress-bar-fill" id="progress-styleQuery"></div></div>
        </div>
        <div class="benchmark-result">
          <div class="benchmark-status" id="status-styleQuery">ç­‰å¾…æµ‹è¯•</div>
        </div>
      </div>
      
      <div class="benchmark-item" data-benchmark="renderBasic">
        <div class="benchmark-icon render">ğŸ–¼ï¸</div>
        <div class="benchmark-info">
          <div class="benchmark-name">åŸºç¡€æ¸²æŸ“</div>
          <div class="benchmark-desc">Canvas æ¸²æŸ“ 5,000 å•å…ƒæ ¼ (30 å¸§)</div>
          <div class="progress-bar"><div class="progress-bar-fill" id="progress-renderBasic"></div></div>
        </div>
        <div class="benchmark-result">
          <div class="benchmark-status" id="status-renderBasic">ç­‰å¾…æµ‹è¯•</div>
        </div>
      </div>
      
      <div class="benchmark-item" data-benchmark="renderScroll">
        <div class="benchmark-icon render">ğŸ“œ</div>
        <div class="benchmark-info">
          <div class="benchmark-name">æ»šåŠ¨æ¸²æŸ“</div>
          <div class="benchmark-desc">50 æ¬¡éšæœºæ»šåŠ¨æ¸²æŸ“æµ‹è¯•</div>
          <div class="progress-bar"><div class="progress-bar-fill" id="progress-renderScroll"></div></div>
        </div>
        <div class="benchmark-result">
          <div class="benchmark-status" id="status-renderScroll">ç­‰å¾…æµ‹è¯•</div>
        </div>
      </div>
      
      <div class="benchmark-item" data-benchmark="fillPattern">
        <div class="benchmark-icon interaction">ğŸ¯</div>
        <div class="benchmark-info">
          <div class="benchmark-name">å¡«å……æŸ„ - æ¨¡å¼æ£€æµ‹</div>
          <div class="benchmark-desc">æ£€æµ‹ 10,000 ç»„æ•°æ®çš„åºåˆ—æ¨¡å¼</div>
          <div class="progress-bar"><div class="progress-bar-fill" id="progress-fillPattern"></div></div>
        </div>
        <div class="benchmark-result">
          <div class="benchmark-status" id="status-fillPattern">ç­‰å¾…æµ‹è¯•</div>
        </div>
      </div>
      
      <div class="benchmark-item" data-benchmark="fillGenerate">
        <div class="benchmark-icon interaction">âœ¨</div>
        <div class="benchmark-info">
          <div class="benchmark-name">å¡«å……æŸ„ - å€¼ç”Ÿæˆ</div>
          <div class="benchmark-desc">ç”Ÿæˆ 100x100 å¡«å……åŒºåŸŸå€¼</div>
          <div class="progress-bar"><div class="progress-bar-fill" id="progress-fillGenerate"></div></div>
        </div>
        <div class="benchmark-result">
          <div class="benchmark-status" id="status-fillGenerate">ç­‰å¾…æµ‹è¯•</div>
        </div>
      </div>
      
      <div class="benchmark-item" data-benchmark="fillFormula">
        <div class="benchmark-icon formula">ğŸ“</div>
        <div class="benchmark-info">
          <div class="benchmark-name">å¡«å……æŸ„ - å…¬å¼è°ƒæ•´</div>
          <div class="benchmark-desc">è°ƒæ•´ 10,000 ä¸ªå…¬å¼å¼•ç”¨</div>
          <div class="progress-bar"><div class="progress-bar-fill" id="progress-fillFormula"></div></div>
        </div>
        <div class="benchmark-result">
          <div class="benchmark-status" id="status-fillFormula">ç­‰å¾…æµ‹è¯•</div>
        </div>
      </div>
      
      <div class="benchmark-item" data-benchmark="autoRowHeight">
        <div class="benchmark-icon render">ğŸ“</div>
        <div class="benchmark-info">
          <div class="benchmark-name">è‡ªåŠ¨è¡Œé«˜è®¡ç®—</div>
          <div class="benchmark-desc">è®¡ç®— 2,000 ä¸ªè‡ªåŠ¨æ¢è¡Œå•å…ƒæ ¼è¡Œé«˜</div>
          <div class="progress-bar"><div class="progress-bar-fill" id="progress-autoRowHeight"></div></div>
        </div>
        <div class="benchmark-result">
          <div class="benchmark-status" id="status-autoRowHeight">ç­‰å¾…æµ‹è¯•</div>
        </div>
      </div>
    </div>
    
    <div class="summary" id="summary" style="display: none;">
      <h3>ğŸ“Š æµ‹è¯•æ€»ç»“</h3>
      <div class="summary-grid">
        <div class="summary-item">
          <div class="summary-value" id="summaryTotal">--</div>
          <div class="summary-label">æ€»è€—æ—¶</div>
        </div>
        <div class="summary-item">
          <div class="summary-value" id="summaryPassed">--</div>
          <div class="summary-label">é€šè¿‡åŸºå‡†</div>
        </div>
        <div class="summary-item">
          <div class="summary-value" id="summaryGrade">--</div>
          <div class="summary-label">è¯„çº§</div>
        </div>
        <div class="summary-item">
          <div class="summary-value" id="summaryThroughput">--</div>
          <div class="summary-label">å¹³å‡ååé‡</div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { SheetModel } from '../src/lib/SheetModel.ts'
    import { FormulaSheet } from '../src/lib/FormulaSheet.ts'
    import { getColWidth, getRowHeight, getColLeft, getRowTop, getVisibleRange } from '../src/components/sheet/geometry.ts'
    import { detectFillPattern, generateFillValues, adjustFormulaReferences, calculateFillHandlePosition } from '../src/components/sheet/fillHandle.ts'
    
    // åŸºå‡†å€¼å®šä¹‰ (æ¯«ç§’)
    const baselines = {
      dataWrite: { excellent: 100, good: 300, average: 600, count: 50000 },
      dataRead: { excellent: 50, good: 150, average: 300, count: 50000 },
      formulaSet: { excellent: 200, good: 500, average: 1000, count: 2000 },
      formulaCalc: { excellent: 100, good: 300, average: 600, count: 2000 },
      styleSet: { excellent: 100, good: 300, average: 600, count: 10000 },
      mergeSet: { excellent: 100, good: 300, average: 600, count: 500 },
      mergeQuery: { excellent: 50, good: 150, average: 300, count: 20000 },
      styleQuery: { excellent: 50, good: 150, average: 300, count: 20000 },
      renderBasic: { excellent: 16, good: 33, average: 50, count: 30, isFps: true },
      renderScroll: { excellent: 16, good: 33, average: 50, count: 50, isFps: true },
      fillPattern: { excellent: 50, good: 150, average: 300, count: 10000 },
      fillGenerate: { excellent: 100, good: 300, average: 600, count: 10000 },
      fillFormula: { excellent: 50, good: 150, average: 300, count: 10000 },
      autoRowHeight: { excellent: 100, good: 300, average: 600, count: 2000 }
    }
    
    // æ¸²æŸ“é…ç½®
    const geometryCfg = {
      defaultColWidth: 80,
      defaultRowHeight: 25,
      frozenCols: 0,
      frozenRows: 0,
      colHeaderHeight: 0,
      rowHeaderWidth: 0
    }
    
    // åˆ›å»ºéšè— canvas
    const testCanvas = document.createElement('canvas')
    testCanvas.width = 1200
    testCanvas.height = 600
    const testCtx = testCanvas.getContext('2d')
    
    const results = {}
    
    function formatTime(ms) {
      if (ms < 1000) return `${ms.toFixed(0)} ms`
      return `${(ms / 1000).toFixed(2)} s`
    }
    
    function getGrade(value, baseline) {
      if (value <= baseline.excellent) return { grade: 'excellent', label: 'ä¼˜ç§€', score: 100 }
      if (value <= baseline.good) return { grade: 'good', label: 'è‰¯å¥½', score: 80 }
      if (value <= baseline.average) return { grade: 'average', label: 'ä¸€èˆ¬', score: 60 }
      return { grade: 'poor', label: 'è¾ƒå·®', score: 40 }
    }
    
    function updateStatus(name, status, time, extraInfo = null) {
      const statusEl = document.getElementById(`status-${name}`)
      const progressEl = document.getElementById(`progress-${name}`)
      
      if (status === 'running') {
        statusEl.innerHTML = 'â³ æµ‹è¯•ä¸­...'
        progressEl.style.width = '50%'
      } else if (status === 'done') {
        const baseline = baselines[name]
        const { grade, label } = getGrade(time, baseline)
        
        let rateHtml
        if (baseline.isFps) {
          // å¯¹äºæ¸²æŸ“æµ‹è¯•ï¼Œæ˜¾ç¤º FPS
          const fps = extraInfo?.fps || (1000 / time)
          rateHtml = `${fps.toFixed(1)} FPS`
          results[name] = { time, grade, rate: Math.round(fps) }
        } else {
          const rate = Math.round(baseline.count / (time / 1000))
          rateHtml = `${rate.toLocaleString()}/ç§’`
          results[name] = { time, grade, rate }
        }
        
        statusEl.innerHTML = `
          <div class="benchmark-score">${formatTime(time)}</div>
          <div class="benchmark-time">${rateHtml}</div>
          <span class="badge ${grade}">${label}</span>
        `
        progressEl.style.width = '100%'
      }
    }
    
    // æ•°æ®å†™å…¥æµ‹è¯•
    async function benchmarkDataWrite() {
      updateStatus('dataWrite', 'running')
      await new Promise(r => setTimeout(r, 50))
      
      const count = baselines.dataWrite.count
      const model = new SheetModel()
      
      const start = performance.now()
      for (let i = 0; i < count; i++) {
        model.setValue(Math.floor(i / 100), i % 100, `Value-${i}`)
      }
      const time = performance.now() - start
      
      updateStatus('dataWrite', 'done', time)
      return time
    }
    
    // æ•°æ®è¯»å–æµ‹è¯•
    async function benchmarkDataRead() {
      updateStatus('dataRead', 'running')
      await new Promise(r => setTimeout(r, 50))
      
      const count = baselines.dataRead.count
      const model = new SheetModel()
      
      // å…ˆå¡«å……æ•°æ®
      for (let i = 0; i < count; i++) {
        model.setValue(Math.floor(i / 100), i % 100, `Value-${i}`)
      }
      
      const start = performance.now()
      for (let i = 0; i < count; i++) {
        model.getValue(Math.floor(i / 100), i % 100)
      }
      const time = performance.now() - start
      
      updateStatus('dataRead', 'done', time)
      return time
    }
    
    // å…¬å¼è®¾ç½®æµ‹è¯•
    async function benchmarkFormulaSet() {
      updateStatus('formulaSet', 'running')
      await new Promise(r => setTimeout(r, 50))
      
      const count = baselines.formulaSet.count
      const model = new SheetModel()
      const sheet = new FormulaSheet(model)
      
      // å…ˆå¡«å……åŸºç¡€æ•°æ®
      for (let r = 0; r < 100; r++) {
        for (let c = 0; c < 10; c++) {
          model.setValue(r, c, r * 10 + c)
        }
      }
      
      const formulas = ['=A1+B1', '=SUM(A1:E1)', '=AVERAGE(A1:J1)', '=A1*2']
      
      const start = performance.now()
      for (let i = 0; i < count; i++) {
        const r = Math.floor(i / 50) + 100
        const c = i % 50
        sheet.setValue(r, c, formulas[i % formulas.length])
      }
      const time = performance.now() - start
      
      updateStatus('formulaSet', 'done', time)
      
      // ä¿å­˜ sheet ä¾›åç»­è®¡ç®—æµ‹è¯•ä½¿ç”¨
      window._benchmarkSheet = sheet
      window._benchmarkFormulaCount = count
      
      return time
    }
    
    // å…¬å¼è®¡ç®—æµ‹è¯•
    async function benchmarkFormulaCalc() {
      updateStatus('formulaCalc', 'running')
      await new Promise(r => setTimeout(r, 50))
      
      const sheet = window._benchmarkSheet
      const count = window._benchmarkFormulaCount || baselines.formulaCalc.count
      
      const start = performance.now()
      for (let i = 0; i < count; i++) {
        const r = Math.floor(i / 50) + 100
        const c = i % 50
        sheet.getValue(r, c)
      }
      const time = performance.now() - start
      
      updateStatus('formulaCalc', 'done', time)
      return time
    }
    
    // æ ·å¼è®¾ç½®æµ‹è¯•
    async function benchmarkStyleSet() {
      updateStatus('styleSet', 'running')
      await new Promise(r => setTimeout(r, 50))
      
      const count = baselines.styleSet.count
      const model = new SheetModel()
      
      // å…ˆå¡«å……æ•°æ®
      for (let i = 0; i < count; i++) {
        model.setValue(Math.floor(i / 100), i % 100, `Cell-${i}`)
      }
      
      const styles = [
        { bgColor: '#ffcccc' },
        { fontWeight: 'bold' },
        { color: '#0000ff' },
        { textAlign: 'center' }
      ]
      
      const start = performance.now()
      for (let i = 0; i < count; i++) {
        model.setCellStyle(Math.floor(i / 100), i % 100, styles[i % styles.length])
      }
      const time = performance.now() - start
      
      updateStatus('styleSet', 'done', time)
      
      // ä¿å­˜ model ä¾›åç»­æŸ¥è¯¢æµ‹è¯•ä½¿ç”¨
      window._benchmarkStyleModel = model
      
      return time
    }
    
    // åˆå¹¶å•å…ƒæ ¼è®¾ç½®æµ‹è¯•
    async function benchmarkMergeSet() {
      updateStatus('mergeSet', 'running')
      await new Promise(r => setTimeout(r, 50))
      
      const count = baselines.mergeSet.count
      const model = new SheetModel()
      
      // å…ˆå¡«å……ä¸€äº›æ•°æ®
      for (let r = 0; r < 200; r++) {
        for (let c = 0; c < 100; c++) {
          model.setValue(r, c, `R${r}C${c}`)
        }
      }
      
      // è®¾ç½®ä¸€äº›è¾¹æ¡†ç”¨äºæµ‹è¯•è¾¹æ¡†åˆå¹¶è¡Œä¸º
      for (let i = 0; i < count; i++) {
        const baseRow = Math.floor(i / 25) * 4
        const baseCol = (i % 25) * 4
        model.setCellBorder(baseRow, baseCol, { 
          top: { style: 'thin', color: '#000000' },
          left: { style: 'thin', color: '#000000' }
        })
      }
      
      const start = performance.now()
      
      // åˆå¹¶æµ‹è¯•ï¼šåˆ›å»º 2x2 çš„åˆå¹¶åŒºåŸŸ
      for (let i = 0; i < count; i++) {
        const baseRow = Math.floor(i / 25) * 4
        const baseCol = (i % 25) * 4
        model.mergeCells(baseRow, baseCol, baseRow + 1, baseCol + 1)
      }
      
      // å–æ¶ˆåˆå¹¶æµ‹è¯•
      for (let i = 0; i < count; i++) {
        const baseRow = Math.floor(i / 25) * 4
        const baseCol = (i % 25) * 4
        model.unmergeCells(baseRow, baseCol)
      }
      
      const time = performance.now() - start
      
      updateStatus('mergeSet', 'done', time)
      
      // ä¿å­˜å¸¦åˆå¹¶çš„ model ä¾›åç»­æµ‹è¯•ä½¿ç”¨
      // é‡æ–°åˆ›å»ºä¸€äº›åˆå¹¶åŒºåŸŸ
      for (let i = 0; i < count; i++) {
        const baseRow = Math.floor(i / 25) * 4
        const baseCol = (i % 25) * 4
        model.mergeCells(baseRow, baseCol, baseRow + 1, baseCol + 1)
      }
      window._benchmarkMergeModel = model
      
      return time
    }
    
    // åˆå¹¶çŠ¶æ€æŸ¥è¯¢æµ‹è¯•
    async function benchmarkMergeQuery() {
      updateStatus('mergeQuery', 'running')
      await new Promise(r => setTimeout(r, 50))
      
      const count = baselines.mergeQuery.count
      const model = window._benchmarkMergeModel || new SheetModel()
      
      // å¦‚æœæ²¡æœ‰ç°æˆçš„ modelï¼Œåˆ›å»ºä¸€äº›åˆå¹¶åŒºåŸŸ
      if (!window._benchmarkMergeModel) {
        for (let i = 0; i < 500; i++) {
          const baseRow = Math.floor(i / 25) * 4
          const baseCol = (i % 25) * 4
          model.mergeCells(baseRow, baseCol, baseRow + 1, baseCol + 1)
        }
      }
      
      const start = performance.now()
      
      for (let i = 0; i < count; i++) {
        const row = Math.floor(Math.random() * 200)
        const col = Math.floor(Math.random() * 100)
        // æµ‹è¯•å„ç§æŸ¥è¯¢æ–¹æ³•
        model.getMergedRegion(row, col)
        model.isMergedCell(row, col)
        model.getMergedCellInfo(row, col)
      }
      
      const time = performance.now() - start
      
      updateStatus('mergeQuery', 'done', time)
      return time
    }
    
    // æ ·å¼æŸ¥è¯¢æµ‹è¯•
    async function benchmarkStyleQuery() {
      updateStatus('styleQuery', 'running')
      await new Promise(r => setTimeout(r, 50))
      
      const count = baselines.styleQuery.count
      const model = window._benchmarkStyleModel || new SheetModel()
      
      // å¦‚æœæ²¡æœ‰ç°æˆçš„ modelï¼Œè®¾ç½®ä¸€äº›æ ·å¼
      if (!window._benchmarkStyleModel) {
        for (let i = 0; i < 10000; i++) {
          model.setCellStyle(Math.floor(i / 100), i % 100, { bold: true })
        }
      }
      
      const start = performance.now()
      
      for (let i = 0; i < count; i++) {
        const row = Math.floor(Math.random() * 100)
        const col = Math.floor(Math.random() * 100)
        model.getCellStyle(row, col)
        model.hasCellStyle(row, col)
      }
      
      const time = performance.now() - start
      
      updateStatus('styleQuery', 'done', time)
      return time
    }
    
    // æ¸²æŸ“è¾…åŠ©å‡½æ•°
    function renderCells(ctx, model, viewport, sizes, totalRows, totalCols) {
      const { startRow, endRow, startCol, endCol } = getVisibleRange(
        ctx.canvas.width, ctx.canvas.height, viewport, sizes, geometryCfg, totalRows, totalCols
      )
      
      ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height)
      
      for (let row = startRow; row <= endRow; row++) {
        for (let col = startCol; col <= endCol; col++) {
          const x = getColLeft(col, sizes, geometryCfg) - viewport.scrollLeft
          const y = getRowTop(row, sizes, geometryCfg) - viewport.scrollTop
          const w = getColWidth(col, sizes, geometryCfg)
          const h = getRowHeight(row, sizes, geometryCfg)
          
          ctx.strokeStyle = '#e0e0e0'
          ctx.strokeRect(x, y, w, h)
          
          const value = model.getValue(row, col)
          if (value !== undefined && value !== null && value !== '') {
            ctx.fillStyle = '#333'
            ctx.font = '12px Arial'
            ctx.fillText(String(value).substring(0, 10), x + 4, y + 16)
          }
        }
      }
    }
    
    // åŸºç¡€æ¸²æŸ“æµ‹è¯•
    async function benchmarkRenderBasic() {
      updateStatus('renderBasic', 'running')
      await new Promise(r => setTimeout(r, 50))
      
      const model = new SheetModel()
      const totalRows = 100, totalCols = 50
      
      // å¡«å……æ•°æ®
      for (let r = 0; r < totalRows; r++) {
        for (let c = 0; c < totalCols; c++) {
          model.setValue(r, c, `R${r}C${c}`)
        }
      }
      
      const sizes = { colWidths: new Map(), rowHeights: new Map(), hiddenCols: new Set(), hiddenRows: new Set() }
      const viewport = { scrollLeft: 0, scrollTop: 0 }
      
      const iterations = baselines.renderBasic.count
      const times = []
      
      for (let i = 0; i < iterations; i++) {
        const start = performance.now()
        renderCells(testCtx, model, viewport, sizes, totalRows, totalCols)
        times.push(performance.now() - start)
      }
      
      const avgTime = times.reduce((a, b) => a + b, 0) / times.length
      const fps = 1000 / avgTime
      
      updateStatus('renderBasic', 'done', avgTime, { fps })
      return avgTime
    }
    
    // æ»šåŠ¨æ¸²æŸ“æµ‹è¯•
    async function benchmarkRenderScroll() {
      updateStatus('renderScroll', 'running')
      await new Promise(r => setTimeout(r, 50))
      
      const model = new SheetModel()
      const totalRows = 500, totalCols = 100
      
      // å¡«å……å¤§é‡æ•°æ®
      for (let r = 0; r < totalRows; r++) {
        for (let c = 0; c < totalCols; c++) {
          model.setValue(r, c, (Math.random() * 1000).toFixed(2))
        }
      }
      
      const sizes = { colWidths: new Map(), rowHeights: new Map(), hiddenCols: new Set(), hiddenRows: new Set() }
      
      // ç”Ÿæˆéšæœºæ»šåŠ¨ä½ç½®
      const iterations = baselines.renderScroll.count
      const times = []
      
      for (let i = 0; i < iterations; i++) {
        const viewport = {
          scrollLeft: Math.random() * 5000,
          scrollTop: Math.random() * 10000
        }
        
        const start = performance.now()
        renderCells(testCtx, model, viewport, sizes, totalRows, totalCols)
        times.push(performance.now() - start)
      }
      
      const avgTime = times.reduce((a, b) => a + b, 0) / times.length
      const fps = 1000 / avgTime
      
      updateStatus('renderScroll', 'done', avgTime, { fps })
      return avgTime
    }
    
    // å¡«å……æŸ„ - æ¨¡å¼æ£€æµ‹æµ‹è¯•
    async function benchmarkFillPattern() {
      updateStatus('fillPattern', 'running')
      await new Promise(r => setTimeout(r, 50))
      
      const count = baselines.fillPattern.count
      
      // å‡†å¤‡å¤šç§æµ‹è¯•æ•°æ®
      const testDataSets = [
        ['1', '2', '3'],           // æ•°å­—åºåˆ—
        ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰'],  // æ˜ŸæœŸ
        ['2024-01-01', '2024-01-02'], // æ—¥æœŸ
        ['Item1', 'Item2'],        // æ–‡æœ¬+æ•°å­—
        ['A', 'B', 'C'],           // æ™®é€šæ–‡æœ¬
        ['10', '20', '30']         // ç­‰å·®åºåˆ—
      ]
      
      const start = performance.now()
      
      for (let i = 0; i < count; i++) {
        const dataSet = testDataSets[i % testDataSets.length]
        detectFillPattern(dataSet)
      }
      
      const time = performance.now() - start
      updateStatus('fillPattern', 'done', time)
      return time
    }
    
    // å¡«å……æŸ„ - å€¼ç”Ÿæˆæµ‹è¯•
    async function benchmarkFillGenerate() {
      updateStatus('fillGenerate', 'running')
      await new Promise(r => setTimeout(r, 50))
      
      const count = baselines.fillGenerate.count
      
      // å‡†å¤‡æºæ•°æ® (10x10)
      const sourceValues = []
      for (let r = 0; r < 10; r++) {
        const row = []
        for (let c = 0; c < 10; c++) {
          row.push(`${r * 10 + c + 1}`)
        }
        sourceValues.push(row)
      }
      
      const patterns = [
        { type: 'linear', step: 1 },
        { type: 'copy' },
        { type: 'date' },
        { type: 'weekday', values: ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'], startIndex: 0 }
      ]
      
      const start = performance.now()
      
      // ç”Ÿæˆ 100x100 åŒºåŸŸ (å¾ªç¯å¤šæ¬¡ä»¥è¾¾åˆ° count)
      for (let i = 0; i < count / 100; i++) {
        const pattern = patterns[i % patterns.length]
        generateFillValues({
          sourceValues,
          pattern,
          direction: 'down',
          targetRowCount: 100,
          targetColCount: 10
        })
      }
      
      const time = performance.now() - start
      updateStatus('fillGenerate', 'done', time)
      return time
    }
    
    // å¡«å……æŸ„ - å…¬å¼è°ƒæ•´æµ‹è¯•
    async function benchmarkFillFormula() {
      updateStatus('fillFormula', 'running')
      await new Promise(r => setTimeout(r, 50))
      
      const count = baselines.fillFormula.count
      
      // å‡†å¤‡å¤šç§å…¬å¼
      const formulas = [
        '=A1+B2',
        '=SUM(A1:Z100)',
        '=$A$1+B$2+$C3',
        '=AVERAGE(A1:B10)*C5',
        '=IF(A1>0,B1,C1)'
      ]
      
      const start = performance.now()
      
      for (let i = 0; i < count; i++) {
        const formula = formulas[i % formulas.length]
        const rowOffset = i % 100
        const colOffset = Math.floor(i / 100) % 26
        adjustFormulaReferences(formula, rowOffset, colOffset)
      }
      
      const time = performance.now() - start
      updateStatus('fillFormula', 'done', time)
      return time
    }
    
    // è‡ªåŠ¨è¡Œé«˜è®¡ç®—æµ‹è¯•
    async function benchmarkAutoRowHeight() {
      updateStatus('autoRowHeight', 'running')
      await new Promise(r => setTimeout(r, 50))
      
      const count = baselines.autoRowHeight.count
      
      // åˆ›å»ºæµ‹é‡å…ƒç´  (å¤ç”¨)
      const measureEl = document.createElement('span')
      measureEl.style.cssText = `
        position: absolute;
        visibility: hidden;
        white-space: pre-wrap;
        word-break: break-word;
        font-family: sans-serif;
        font-size: 13px;
        line-height: 18.2px;
        display: block;
      `
      document.body.appendChild(measureEl)
      
      // ç”Ÿæˆæµ‹è¯•æ–‡æœ¬ (å„ç§é•¿åº¦å’Œå¤æ‚åº¦)
      const testTexts = []
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789ä¸­æ–‡æµ‹è¯• '
      for (let i = 0; i < count; i++) {
        const length = 20 + Math.floor(Math.random() * 200)  // 20-220 å­—ç¬¦
        let text = ''
        for (let j = 0; j < length; j++) {
          if (j > 0 && j % 50 === 0 && Math.random() > 0.5) {
            text += '\n'  // éšæœºæ’å…¥æ¢è¡Œ
          } else {
            text += chars[Math.floor(Math.random() * chars.length)]
          }
        }
        testTexts.push(text)
      }
      
      // ç”Ÿæˆæµ‹è¯•å®½åº¦ (æ¨¡æ‹Ÿä¸åŒåˆ—å®½)
      const cellWidths = [80, 100, 120, 150, 200]
      
      const start = performance.now()
      
      // æµ‹é‡æ¯ä¸ªæ–‡æœ¬çš„é«˜åº¦
      for (let i = 0; i < count; i++) {
        const text = testTexts[i]
        const width = cellWidths[i % cellWidths.length]
        
        measureEl.style.width = `${width}px`
        measureEl.textContent = text || ' '
        const height = measureEl.offsetHeight
        
        // æ¨¡æ‹Ÿè¡Œé«˜è®¡ç®— (æœ€å°é«˜åº¦ 25)
        const rowHeight = Math.max(25, height + 4)
      }
      
      const time = performance.now() - start
      
      // æ¸…ç†
      document.body.removeChild(measureEl)
      
      updateStatus('autoRowHeight', 'done', time)
      return time
    }
    
    // è¿è¡Œæ‰€æœ‰æµ‹è¯•
    window.runAllBenchmarks = async function() {
      const btn = document.getElementById('runBtn')
      btn.classList.add('running')
      btn.textContent = 'â³ æµ‹è¯•ä¸­...'
      btn.disabled = true
      
      document.getElementById('totalScore').textContent = '...'
      document.getElementById('scoreDesc').textContent = 'æ­£åœ¨è¿è¡ŒåŸºå‡†æµ‹è¯• (çœŸå®ç»„ä»¶)'
      document.getElementById('summary').style.display = 'none'
      
      // é‡ç½®æ‰€æœ‰çŠ¶æ€
      for (const name of Object.keys(baselines)) {
        document.getElementById(`status-${name}`).innerHTML = 'ç­‰å¾…æµ‹è¯•'
        document.getElementById(`progress-${name}`).style.width = '0%'
      }
      
      const startTime = performance.now()
      
      // ä¾æ¬¡è¿è¡Œæµ‹è¯•
      await benchmarkDataWrite()
      await benchmarkDataRead()
      await benchmarkFormulaSet()
      await benchmarkFormulaCalc()
      await benchmarkStyleSet()
      await benchmarkMergeSet()
      await benchmarkMergeQuery()
      await benchmarkStyleQuery()
      await benchmarkRenderBasic()
      await benchmarkRenderScroll()
      await benchmarkFillPattern()
      await benchmarkFillGenerate()
      await benchmarkFillFormula()
      await benchmarkAutoRowHeight()
      
      const totalTime = performance.now() - startTime
      
      // è®¡ç®—æ€»åˆ†
      let totalScore = 0
      let passedCount = 0
      let totalRate = 0
      let rateCount = 0
      
      for (const [name, result] of Object.entries(results)) {
        const baseline = baselines[name]
        const { score } = getGrade(result.time, baseline)
        totalScore += score
        
        // æ¸²æŸ“æµ‹è¯•ä¸è®¡å…¥ååé‡ç»Ÿè®¡
        if (!baseline.isFps) {
          totalRate += result.rate
          rateCount++
        }
        
        if (result.grade === 'excellent' || result.grade === 'good') {
          passedCount++
        }
      }
      
      const avgScore = Math.round(totalScore / Object.keys(results).length)
      const avgRate = rateCount > 0 ? Math.round(totalRate / rateCount) : 0
      
      // æ›´æ–°æ€»åˆ†æ˜¾ç¤º
      document.getElementById('totalScore').textContent = avgScore
      
      let gradeText, gradeEmoji
      if (avgScore >= 90) { gradeText = 'æ€§èƒ½å“è¶Š'; gradeEmoji = 'ğŸ†' }
      else if (avgScore >= 75) { gradeText = 'æ€§èƒ½ä¼˜è‰¯'; gradeEmoji = 'ğŸ¥‡' }
      else if (avgScore >= 60) { gradeText = 'æ€§èƒ½ä¸€èˆ¬'; gradeEmoji = 'ğŸ¥ˆ' }
      else { gradeText = 'éœ€è¦ä¼˜åŒ–'; gradeEmoji = 'âš ï¸' }
      
      document.getElementById('scoreDesc').textContent = `${gradeEmoji} ${gradeText} (ä½¿ç”¨çœŸå® SheetModel + FormulaSheet)`
      
      // æ˜¾ç¤ºæ€»ç»“
      document.getElementById('summary').style.display = 'block'
      document.getElementById('summaryTotal').textContent = formatTime(totalTime)
      document.getElementById('summaryPassed').textContent = `${passedCount}/${Object.keys(baselines).length}`
      document.getElementById('summaryGrade').textContent = gradeText
      document.getElementById('summaryThroughput').textContent = `${avgRate.toLocaleString()}/ç§’`
      
      // æ¢å¤æŒ‰é’®
      btn.classList.remove('running')
      btn.textContent = 'ğŸ”„ é‡æ–°æµ‹è¯•'
      btn.disabled = false
    }
  </script>
</body>
</html>
