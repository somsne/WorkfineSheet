<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¡«å……æŸ„åŠŸèƒ½æµ‹è¯• - WorkfineSheet</title>
  <style>
    :root { --primary: #667eea; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f7fa; min-height: 100vh; }
    .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px 24px; display: flex; align-items: center; gap: 16px; }
    .navbar a { color: white; text-decoration: none; opacity: 0.8; }
    .navbar a:hover { opacity: 1; }
    .navbar h1 { font-size: 1.25rem; flex: 1; }
    .container { max-width: 1400px; margin: 0 auto; padding: 24px; }
    .intro { background: white; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .intro h2 { color: #1f2937; margin-bottom: 12px; }
    .intro p { color: #6b7280; line-height: 1.6; }
    .controls { display: flex; gap: 12px; margin: 24px 0; flex-wrap: wrap; }
    button { padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95rem; font-weight: 600; transition: transform 0.2s, box-shadow 0.2s; }
    button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    button.secondary { background: #e5e7eb; color: #4b5563; }
    button.secondary:hover { background: #d1d5db; }
    .test-section { background: white; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .test-section h3 { color: #1f2937; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    .test-section h3 .icon { font-size: 1.25rem; }
    .test-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; }
    .test-item { background: #f9fafb; border-radius: 8px; padding: 16px; border-left: 4px solid #667eea; }
    .test-item.pass { border-left-color: #10b981; }
    .test-item.fail { border-left-color: #ef4444; }
    .test-item .name { font-weight: 600; color: #1f2937; margin-bottom: 8px; }
    .test-item .desc { font-size: 0.85rem; color: #6b7280; margin-bottom: 8px; }
    .test-item .result { font-size: 0.9rem; color: #374151; }
    .test-item .result.pass { color: #10b981; }
    .test-item .result.fail { color: #ef4444; }
    .log-area { background: #1f2937; border-radius: 8px; padding: 16px; font-family: 'Monaco', 'Menlo', monospace; font-size: 0.85rem; color: #e5e7eb; max-height: 300px; overflow-y: auto; margin-top: 16px; }
    .log-area .log-line { margin-bottom: 4px; }
    .log-area .log-line.info { color: #60a5fa; }
    .log-area .log-line.success { color: #34d399; }
    .log-area .log-line.error { color: #f87171; }
    .log-area .log-line.warn { color: #fbbf24; }
    .summary { display: flex; gap: 24px; margin-top: 24px; flex-wrap: wrap; }
    .summary-card { flex: 1; min-width: 200px; background: white; border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .summary-card .value { font-size: 2rem; font-weight: 700; color: #667eea; }
    .summary-card .label { font-size: 0.9rem; color: #6b7280; margin-top: 4px; }
    .summary-card.success .value { color: #10b981; }
    .summary-card.error .value { color: #ef4444; }
  </style>
</head>
<body>
  <nav class="navbar">
    <a href="index.html">â† è¿”å›</a>
    <h1>ğŸ¯ å¡«å……æŸ„åŠŸèƒ½æµ‹è¯•</h1>
  </nav>
  
  <div class="container">
    <div class="intro">
      <h2>å¡«å……æŸ„ (Fill Handle) åŠŸèƒ½æµ‹è¯•</h2>
      <p>æµ‹è¯•å¡«å……æŸ„çš„å„é¡¹åŠŸèƒ½ï¼ŒåŒ…æ‹¬ä½ç½®è®¡ç®—ã€æ–¹å‘æ£€æµ‹ã€åºåˆ—æ¨¡å¼è¯†åˆ«ã€å¡«å……å€¼ç”Ÿæˆã€å…¬å¼å¼•ç”¨è°ƒæ•´ã€æ¸…é™¤åŒºåŸŸè®¡ç®—ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚</p>
    </div>
    
    <div class="controls">
      <button onclick="runAllTests()">ğŸš€ è¿è¡Œå…¨éƒ¨æµ‹è¯•</button>
      <button class="secondary" onclick="clearResults()">ğŸ—‘ï¸ æ¸…é™¤ç»“æœ</button>
    </div>
    
    <div class="summary" id="summary" style="display: none;">
      <div class="summary-card success">
        <div class="value" id="passCount">0</div>
        <div class="label">é€šè¿‡</div>
      </div>
      <div class="summary-card error">
        <div class="value" id="failCount">0</div>
        <div class="label">å¤±è´¥</div>
      </div>
      <div class="summary-card">
        <div class="value" id="totalTime">0ms</div>
        <div class="label">æ€»è€—æ—¶</div>
      </div>
    </div>
    
    <!-- ä½ç½®è®¡ç®—æµ‹è¯• -->
    <div class="test-section">
      <h3><span class="icon">ğŸ“</span> ä½ç½®è®¡ç®—æµ‹è¯•</h3>
      <div class="test-grid" id="positionTests"></div>
    </div>
    
    <!-- æ–¹å‘æ£€æµ‹æµ‹è¯• -->
    <div class="test-section">
      <h3><span class="icon">ğŸ§­</span> æ–¹å‘æ£€æµ‹æµ‹è¯•</h3>
      <div class="test-grid" id="directionTests"></div>
    </div>
    
    <!-- å¡«å……åŒºåŸŸè®¡ç®—æµ‹è¯• -->
    <div class="test-section">
      <h3><span class="icon">ğŸ“</span> å¡«å……åŒºåŸŸè®¡ç®—æµ‹è¯•</h3>
      <div class="test-grid" id="rangeTests"></div>
    </div>
    
    <!-- æ¸…é™¤åŒºåŸŸè®¡ç®—æµ‹è¯• -->
    <div class="test-section">
      <h3><span class="icon">ğŸ§¹</span> æ¸…é™¤åŒºåŸŸè®¡ç®—æµ‹è¯•</h3>
      <div class="test-grid" id="clearTests"></div>
    </div>
    
    <!-- åºåˆ—æ¨¡å¼æ£€æµ‹æµ‹è¯• -->
    <div class="test-section">
      <h3><span class="icon">ğŸ”¢</span> åºåˆ—æ¨¡å¼æ£€æµ‹æµ‹è¯•</h3>
      <div class="test-grid" id="patternTests"></div>
    </div>
    
    <!-- å¡«å……å€¼ç”Ÿæˆæµ‹è¯• -->
    <div class="test-section">
      <h3><span class="icon">âœ¨</span> å¡«å……å€¼ç”Ÿæˆæµ‹è¯•</h3>
      <div class="test-grid" id="generateTests"></div>
    </div>
    
    <!-- å…¬å¼å¼•ç”¨è°ƒæ•´æµ‹è¯• -->
    <div class="test-section">
      <h3><span class="icon">ğŸ“</span> å…¬å¼å¼•ç”¨è°ƒæ•´æµ‹è¯•</h3>
      <div class="test-grid" id="formulaTests"></div>
    </div>
    
    <!-- æ—¥å¿—è¾“å‡º -->
    <div class="test-section">
      <h3><span class="icon">ğŸ“‹</span> æµ‹è¯•æ—¥å¿—</h3>
      <div class="log-area" id="logArea">
        <div class="log-line info">ç‚¹å‡»"è¿è¡Œå…¨éƒ¨æµ‹è¯•"å¼€å§‹æµ‹è¯•...</div>
      </div>
    </div>
  </div>

  <script type="module">
    import {
      calculateFillHandlePosition,
      isPointOnFillHandle,
      determineFillDirection,
      calculateFillRange,
      calculateClearRange,
      detectFillPattern,
      generateFillValues,
      adjustFormulaReferences,
      BUILT_IN_SEQUENCES
    } from '../src/components/sheet/fillHandle.ts'
    import { DEFAULT_FILL_HANDLE_STATE, FILL_HANDLE_CONFIG } from '../src/components/sheet/types.ts'
    
    // æµ‹è¯•å·¥å…·å‡½æ•°
    function createDefaultGeometryConfig() {
      return {
        defaultRowHeight: 26,
        defaultColWidth: 100,
        rowHeaderWidth: 40,
        colHeaderHeight: 26
      }
    }
    
    function createDefaultSizeAccess() {
      return {
        rowHeights: new Map(),
        colWidths: new Map(),
        hiddenRows: new Set(),
        hiddenCols: new Set()
      }
    }
    
    function createDefaultViewport() {
      return { scrollTop: 0, scrollLeft: 0 }
    }
    
    // æµ‹è¯•ç»“æœ
    let passCount = 0
    let failCount = 0
    const startTime = { value: 0 }
    
    // æ—¥å¿—å‡½æ•°
    function log(message, type = 'info') {
      const logArea = document.getElementById('logArea')
      const line = document.createElement('div')
      line.className = `log-line ${type}`
      line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`
      logArea.appendChild(line)
      logArea.scrollTop = logArea.scrollHeight
    }
    
    // æ–­è¨€å‡½æ•°
    function assertEqual(actual, expected, message) {
      const pass = JSON.stringify(actual) === JSON.stringify(expected)
      if (pass) {
        passCount++
        log(`âœ“ ${message}`, 'success')
      } else {
        failCount++
        log(`âœ— ${message}`, 'error')
        log(`  æœŸæœ›: ${JSON.stringify(expected)}`, 'warn')
        log(`  å®é™…: ${JSON.stringify(actual)}`, 'warn')
      }
      return pass
    }
    
    function assertTrue(actual, message) {
      return assertEqual(actual, true, message)
    }
    
    function assertFalse(actual, message) {
      return assertEqual(actual, false, message)
    }
    
    function assertNull(actual, message) {
      return assertEqual(actual, null, message)
    }
    
    // æ¸²æŸ“æµ‹è¯•ç»“æœ
    function renderTestResult(containerId, name, desc, pass, result) {
      const container = document.getElementById(containerId)
      const item = document.createElement('div')
      item.className = `test-item ${pass ? 'pass' : 'fail'}`
      item.innerHTML = `
        <div class="name">${pass ? 'âœ“' : 'âœ—'} ${name}</div>
        <div class="desc">${desc}</div>
        <div class="result ${pass ? 'pass' : 'fail'}">${result}</div>
      `
      container.appendChild(item)
    }
    
    // ä½ç½®è®¡ç®—æµ‹è¯•
    function runPositionTests() {
      log('â–¶ å¼€å§‹ä½ç½®è®¡ç®—æµ‹è¯•...', 'info')
      
      // æµ‹è¯•1: åŸºæœ¬ä½ç½®è®¡ç®—
      {
        const result = calculateFillHandlePosition({
          selectionRange: { startRow: 0, startCol: 0, endRow: 0, endCol: 0 },
          viewport: createDefaultViewport(),
          geometryConfig: createDefaultGeometryConfig(),
          sizes: createDefaultSizeAccess(),
          canvasWidth: 800,
          canvasHeight: 600
        })
        const pass = result.visible === true && result.rect.x === 136 && result.rect.y === 48
        renderTestResult('positionTests', 'åŸºæœ¬ä½ç½®è®¡ç®—', 'å•å…ƒæ ¼ A1 çš„å¡«å……æŸ„ä½ç½®', pass, 
          `visible: ${result.visible}, x: ${result.rect.x}, y: ${result.rect.y}`)
        assertEqual(result.visible, true, 'å¡«å……æŸ„åº”è¯¥å¯è§')
      }
      
      // æµ‹è¯•2: å¤šå•å…ƒæ ¼é€‰åŒºä½ç½®
      {
        const result = calculateFillHandlePosition({
          selectionRange: { startRow: 0, startCol: 0, endRow: 2, endCol: 2 },
          viewport: createDefaultViewport(),
          geometryConfig: createDefaultGeometryConfig(),
          sizes: createDefaultSizeAccess(),
          canvasWidth: 800,
          canvasHeight: 600
        })
        const pass = result.rect.x === 336 && result.rect.y === 100
        renderTestResult('positionTests', 'å¤šå•å…ƒæ ¼é€‰åŒº', '3x3 é€‰åŒºçš„å¡«å……æŸ„ä½ç½®', pass,
          `x: ${result.rect.x}, y: ${result.rect.y}`)
      }
      
      // æµ‹è¯•3: æ»šåŠ¨åä½ç½®
      {
        const result = calculateFillHandlePosition({
          selectionRange: { startRow: 0, startCol: 0, endRow: 0, endCol: 0 },
          viewport: { scrollTop: 50, scrollLeft: 100 },
          geometryConfig: createDefaultGeometryConfig(),
          sizes: createDefaultSizeAccess(),
          canvasWidth: 800,
          canvasHeight: 600
        })
        const pass = result.rect.x === 36 && result.rect.y === -2
        renderTestResult('positionTests', 'æ»šåŠ¨åä½ç½®', 'æ»šåŠ¨ (100, 50) åçš„ä½ç½®', pass,
          `x: ${result.rect.x}, y: ${result.rect.y}`)
      }
      
      // æµ‹è¯•4: ç‚¹å‡»æ£€æµ‹ - åœ¨å¡«å……æŸ„ä¸Š
      {
        const state = {
          ...DEFAULT_FILL_HANDLE_STATE,
          visible: true,
          rect: { x: 100, y: 100, width: FILL_HANDLE_CONFIG.SIZE, height: FILL_HANDLE_CONFIG.SIZE }
        }
        const pass = isPointOnFillHandle(103, 103, state)
        renderTestResult('positionTests', 'ç‚¹å‡»æ£€æµ‹ - ä¸­å¿ƒ', 'é¼ æ ‡åœ¨å¡«å……æŸ„ä¸­å¿ƒ', pass, `ç»“æœ: ${pass}`)
      }
      
      // æµ‹è¯•5: ç‚¹å‡»æ£€æµ‹ - ä¸åœ¨å¡«å……æŸ„ä¸Š
      {
        const state = {
          ...DEFAULT_FILL_HANDLE_STATE,
          visible: true,
          rect: { x: 100, y: 100, width: FILL_HANDLE_CONFIG.SIZE, height: FILL_HANDLE_CONFIG.SIZE }
        }
        const pass = !isPointOnFillHandle(50, 50, state)
        renderTestResult('positionTests', 'ç‚¹å‡»æ£€æµ‹ - è¿œç¦»', 'é¼ æ ‡è¿œç¦»å¡«å……æŸ„', pass, `ç»“æœ: ${!pass}`)
      }
    }
    
    // æ–¹å‘æ£€æµ‹æµ‹è¯•
    function runDirectionTests() {
      log('â–¶ å¼€å§‹æ–¹å‘æ£€æµ‹æµ‹è¯•...', 'info')
      
      const sourceRange = { startRow: 5, startCol: 5, endRow: 5, endCol: 5 }
      
      // æµ‹è¯•å„ä¸ªæ–¹å‘
      const directions = [
        { name: 'å‘ä¸‹æ‹–æ‹½', startY: 100, endY: 200, expected: 'down' },
        { name: 'å‘ä¸Šæ‹–æ‹½', startY: 200, endY: 100, expected: 'up' },
        { name: 'å‘å³æ‹–æ‹½', startX: 100, endX: 200, expected: 'right' },
        { name: 'å‘å·¦æ‹–æ‹½', startX: 200, endX: 100, expected: 'left' }
      ]
      
      for (const test of directions) {
        const direction = determineFillDirection(
          test.startX ?? 100, test.startY ?? 100,
          test.endX ?? 100, test.endY ?? 100,
          sourceRange,
          createDefaultViewport(),
          createDefaultGeometryConfig(),
          createDefaultSizeAccess()
        )
        const pass = direction === test.expected
        renderTestResult('directionTests', test.name, `åº”è¯¥æ£€æµ‹ä¸º ${test.expected}`, pass, `ç»“æœ: ${direction}`)
        assertEqual(direction, test.expected, `${test.name}åº”è¯¥è¿”å› ${test.expected}`)
      }
    }
    
    // å¡«å……åŒºåŸŸè®¡ç®—æµ‹è¯•
    function runRangeTests() {
      log('â–¶ å¼€å§‹å¡«å……åŒºåŸŸè®¡ç®—æµ‹è¯•...', 'info')
      
      // æµ‹è¯•1: å‘ä¸‹å¡«å……
      {
        const result = calculateFillRange({
          sourceRange: { startRow: 0, startCol: 0, endRow: 0, endCol: 0 },
          currentRow: 3,
          currentCol: 0,
          direction: 'down',
          totalRows: 100,
          totalCols: 26
        })
        const pass = result && result.startRow === 1 && result.endRow === 3
        renderTestResult('rangeTests', 'å‘ä¸‹å¡«å……', 'ä» A1 å‘ä¸‹å¡«å……åˆ° A4', pass,
          result ? `rows: ${result.startRow}-${result.endRow}` : 'null')
      }
      
      // æµ‹è¯•2: å‘å³å¡«å……
      {
        const result = calculateFillRange({
          sourceRange: { startRow: 0, startCol: 0, endRow: 0, endCol: 0 },
          currentRow: 0,
          currentCol: 3,
          direction: 'right',
          totalRows: 100,
          totalCols: 26
        })
        const pass = result && result.startCol === 1 && result.endCol === 3
        renderTestResult('rangeTests', 'å‘å³å¡«å……', 'ä» A1 å‘å³å¡«å……åˆ° D1', pass,
          result ? `cols: ${result.startCol}-${result.endCol}` : 'null')
      }
      
      // æµ‹è¯•3: å‘ä¸Šå¡«å……
      {
        const result = calculateFillRange({
          sourceRange: { startRow: 5, startCol: 0, endRow: 5, endCol: 0 },
          currentRow: 2,
          currentCol: 0,
          direction: 'up',
          totalRows: 100,
          totalCols: 26
        })
        const pass = result && result.startRow === 2 && result.endRow === 4
        renderTestResult('rangeTests', 'å‘ä¸Šå¡«å……', 'ä» A6 å‘ä¸Šå¡«å……åˆ° A3', pass,
          result ? `rows: ${result.startRow}-${result.endRow}` : 'null')
      }
    }
    
    // æ¸…é™¤åŒºåŸŸè®¡ç®—æµ‹è¯•
    function runClearTests() {
      log('â–¶ å¼€å§‹æ¸…é™¤åŒºåŸŸè®¡ç®—æµ‹è¯•...', 'info')
      
      const sourceRange = { startRow: 2, startCol: 2, endRow: 6, endCol: 4 }
      
      // æµ‹è¯•1: å‘ä¸Šç¼©å°
      {
        const result = calculateClearRange(sourceRange, 4, 3, 'up')
        const pass = result && result.startRow === 5 && result.endRow === 6
        renderTestResult('clearTests', 'å‘ä¸Šç¼©å°', 'æ¸…é™¤ä¸‹æ–¹è¡Œ (row 5-6)', pass,
          result ? `rows: ${result.startRow}-${result.endRow}` : 'null')
      }
      
      // æµ‹è¯•2: å‘ä¸‹ç¼©å°
      {
        const result = calculateClearRange(sourceRange, 4, 3, 'down')
        const pass = result && result.startRow === 2 && result.endRow === 3
        renderTestResult('clearTests', 'å‘ä¸‹ç¼©å°', 'æ¸…é™¤ä¸Šæ–¹è¡Œ (row 2-3)', pass,
          result ? `rows: ${result.startRow}-${result.endRow}` : 'null')
      }
      
      // æµ‹è¯•3: å‘å·¦ç¼©å°
      {
        const result = calculateClearRange(sourceRange, 4, 3, 'left')
        const pass = result && result.startCol === 4 && result.endCol === 4
        renderTestResult('clearTests', 'å‘å·¦ç¼©å°', 'æ¸…é™¤å³æ–¹åˆ— (col 4)', pass,
          result ? `cols: ${result.startCol}-${result.endCol}` : 'null')
      }
      
      // æµ‹è¯•4: å‘å³ç¼©å°
      {
        const result = calculateClearRange(sourceRange, 4, 3, 'right')
        const pass = result && result.startCol === 2 && result.endCol === 2
        renderTestResult('clearTests', 'å‘å³ç¼©å°', 'æ¸…é™¤å·¦æ–¹åˆ— (col 2)', pass,
          result ? `cols: ${result.startCol}-${result.endCol}` : 'null')
      }
      
      // æµ‹è¯•5: é¼ æ ‡åœ¨æºåŒºåŸŸå¤–
      {
        const result = calculateClearRange(sourceRange, 1, 3, 'up')
        const pass = result === null
        renderTestResult('clearTests', 'åŒºåŸŸå¤– - è¿”å› null', 'é¼ æ ‡åœ¨æºåŒºåŸŸå¤–', pass, `ç»“æœ: ${result}`)
      }
    }
    
    // åºåˆ—æ¨¡å¼æ£€æµ‹æµ‹è¯•
    function runPatternTests() {
      log('â–¶ å¼€å§‹åºåˆ—æ¨¡å¼æ£€æµ‹æµ‹è¯•...', 'info')
      
      const tests = [
        { name: 'æ•°å­—åºåˆ—', values: ['1', '2', '3'], expected: 'linear' },
        { name: 'ç­‰å·®åºåˆ—', values: ['2', '4', '6'], expected: 'linear' },
        { name: 'ä¸­æ–‡æ˜ŸæœŸ', values: ['å‘¨ä¸€', 'å‘¨äºŒ'], expected: 'weekday' },
        { name: 'è‹±æ–‡æ˜ŸæœŸ', values: ['Monday', 'Tuesday'], expected: 'weekday' },
        { name: 'æ—¥æœŸæ ¼å¼', values: ['2024-01-01', '2024-01-02'], expected: 'date' },
        { name: 'æ–‡æœ¬+æ•°å­—', values: ['Item1', 'Item2'], expected: 'linear' },
        { name: 'æ™®é€šæ–‡æœ¬', values: ['Hello', 'World'], expected: 'copy' },
        { name: 'å•ä¸ªæ•°å­—', values: ['5'], expected: 'copy' }
      ]
      
      for (const test of tests) {
        const pattern = detectFillPattern(test.values)
        const pass = pattern.type === test.expected
        renderTestResult('patternTests', test.name, `åº”æ£€æµ‹ä¸º ${test.expected}`, pass,
          `ç»“æœ: ${pattern.type}`)
        assertEqual(pattern.type, test.expected, `${test.name}åº”è¯¥æ£€æµ‹ä¸º ${test.expected}`)
      }
    }
    
    // å¡«å……å€¼ç”Ÿæˆæµ‹è¯•
    function runGenerateTests() {
      log('â–¶ å¼€å§‹å¡«å……å€¼ç”Ÿæˆæµ‹è¯•...', 'info')
      
      // æµ‹è¯•1: å¤åˆ¶æ¨¡å¼
      {
        const result = generateFillValues({
          sourceValues: [['A']],
          pattern: { type: 'copy' },
          direction: 'down',
          targetRowCount: 3,
          targetColCount: 1
        })
        const pass = JSON.stringify(result) === JSON.stringify([['A'], ['A'], ['A']])
        renderTestResult('generateTests', 'å¤åˆ¶æ¨¡å¼', 'å¤åˆ¶ A ä¸‰æ¬¡', pass, `ç»“æœ: ${JSON.stringify(result)}`)
      }
      
      // æµ‹è¯•2: ç­‰å·®åºåˆ—
      {
        const result = generateFillValues({
          sourceValues: [['1'], ['2']],
          pattern: { type: 'linear', step: 1 },
          direction: 'down',
          targetRowCount: 3,
          targetColCount: 1
        })
        const pass = JSON.stringify(result) === JSON.stringify([['3'], ['4'], ['5']])
        renderTestResult('generateTests', 'ç­‰å·®åºåˆ—', '1,2 â†’ 3,4,5', pass, `ç»“æœ: ${JSON.stringify(result)}`)
      }
      
      // æµ‹è¯•3: æ˜ŸæœŸå¾ªç¯
      {
        const result = generateFillValues({
          sourceValues: [['å‘¨å…­']],
          pattern: { type: 'weekday', values: BUILT_IN_SEQUENCES.weekdaysCN, startIndex: 5 },
          direction: 'down',
          targetRowCount: 3,
          targetColCount: 1
        })
        const expected = [['å‘¨æ—¥'], ['å‘¨ä¸€'], ['å‘¨äºŒ']]
        const pass = JSON.stringify(result) === JSON.stringify(expected)
        renderTestResult('generateTests', 'æ˜ŸæœŸå¾ªç¯', 'å‘¨å…­ â†’ å‘¨æ—¥,å‘¨ä¸€,å‘¨äºŒ', pass, `ç»“æœ: ${JSON.stringify(result)}`)
      }
      
      // æµ‹è¯•4: æ—¥æœŸå¡«å……
      {
        const result = generateFillValues({
          sourceValues: [['2024-01-01']],
          pattern: { type: 'date' },
          direction: 'down',
          targetRowCount: 3,
          targetColCount: 1
        })
        const expected = [['2024-01-02'], ['2024-01-03'], ['2024-01-04']]
        const pass = JSON.stringify(result) === JSON.stringify(expected)
        renderTestResult('generateTests', 'æ—¥æœŸå¡«å……', '2024-01-01 â†’ 02,03,04', pass, `ç»“æœ: ${JSON.stringify(result)}`)
      }
      
      // æµ‹è¯•5: åå‘å¡«å……ï¼ˆå‘ä¸Šï¼‰
      {
        const result = generateFillValues({
          sourceValues: [['5']],
          pattern: { type: 'linear', step: 1 },
          direction: 'up',
          targetRowCount: 3,
          targetColCount: 1
        })
        const expected = [['2'], ['3'], ['4']]
        const pass = JSON.stringify(result) === JSON.stringify(expected)
        renderTestResult('generateTests', 'åå‘å¡«å……(å‘ä¸Š)', '5 â†’ 4,3,2', pass, `ç»“æœ: ${JSON.stringify(result)}`)
      }
    }
    
    // å…¬å¼å¼•ç”¨è°ƒæ•´æµ‹è¯•
    function runFormulaTests() {
      log('â–¶ å¼€å§‹å…¬å¼å¼•ç”¨è°ƒæ•´æµ‹è¯•...', 'info')
      
      const tests = [
        { name: 'ç›¸å¯¹å¼•ç”¨ - è¡Œåç§»', formula: '=A1', rowOffset: 1, colOffset: 0, expected: '=A2' },
        { name: 'ç›¸å¯¹å¼•ç”¨ - åˆ—åç§»', formula: '=A1', rowOffset: 0, colOffset: 1, expected: '=B1' },
        { name: 'ç»å¯¹å¼•ç”¨ - ä¸å˜', formula: '=$A$1', rowOffset: 1, colOffset: 1, expected: '=$A$1' },
        { name: 'æ··åˆå¼•ç”¨ - åˆ—ç»å¯¹', formula: '=$A1', rowOffset: 1, colOffset: 1, expected: '=$A2' },
        { name: 'æ··åˆå¼•ç”¨ - è¡Œç»å¯¹', formula: '=A$1', rowOffset: 1, colOffset: 1, expected: '=B$1' },
        { name: 'å¤æ‚å…¬å¼', formula: '=A1+B2', rowOffset: 1, colOffset: 0, expected: '=A2+B3' },
        { name: 'SUM èŒƒå›´', formula: '=SUM(A1:B5)', rowOffset: 2, colOffset: 1, expected: '=SUM(B3:C7)' },
        { name: 'éå…¬å¼æ–‡æœ¬', formula: 'Hello', rowOffset: 1, colOffset: 1, expected: 'Hello' },
        { name: 'å¤šåˆ—å­—æ¯', formula: '=AA1', rowOffset: 0, colOffset: 1, expected: '=AB1' },
        { name: 'Zâ†’AA è·¨ç•Œ', formula: '=Z1', rowOffset: 0, colOffset: 1, expected: '=AA1' }
      ]
      
      for (const test of tests) {
        const result = adjustFormulaReferences(test.formula, test.rowOffset, test.colOffset)
        const pass = result === test.expected
        renderTestResult('formulaTests', test.name, `${test.formula} â†’ ${test.expected}`, pass, `ç»“æœ: ${result}`)
        assertEqual(result, test.expected, `${test.name}åº”è¯¥è¿”å› ${test.expected}`)
      }
    }
    
    // è¿è¡Œæ‰€æœ‰æµ‹è¯•
    window.runAllTests = function() {
      passCount = 0
      failCount = 0
      startTime.value = performance.now()
      
      // æ¸…é™¤ä¹‹å‰çš„ç»“æœ
      document.querySelectorAll('.test-grid').forEach(el => el.innerHTML = '')
      document.getElementById('logArea').innerHTML = ''
      
      log('ğŸš€ å¼€å§‹è¿è¡Œå¡«å……æŸ„åŠŸèƒ½æµ‹è¯•...', 'info')
      
      try {
        runPositionTests()
        runDirectionTests()
        runRangeTests()
        runClearTests()
        runPatternTests()
        runGenerateTests()
        runFormulaTests()
        
        const totalTime = (performance.now() - startTime.value).toFixed(0)
        
        log(`\nâœ… æµ‹è¯•å®Œæˆï¼é€šè¿‡: ${passCount}, å¤±è´¥: ${failCount}, è€—æ—¶: ${totalTime}ms`, 
          failCount === 0 ? 'success' : 'warn')
        
        // æ›´æ–°æ‘˜è¦
        document.getElementById('summary').style.display = 'flex'
        document.getElementById('passCount').textContent = passCount
        document.getElementById('failCount').textContent = failCount
        document.getElementById('totalTime').textContent = `${totalTime}ms`
        
      } catch (error) {
        log(`âŒ æµ‹è¯•å‡ºé”™: ${error.message}`, 'error')
        console.error(error)
      }
    }
    
    // æ¸…é™¤ç»“æœ
    window.clearResults = function() {
      document.querySelectorAll('.test-grid').forEach(el => el.innerHTML = '')
      document.getElementById('logArea').innerHTML = '<div class="log-line info">ç‚¹å‡»"è¿è¡Œå…¨éƒ¨æµ‹è¯•"å¼€å§‹æµ‹è¯•...</div>'
      document.getElementById('summary').style.display = 'none'
      passCount = 0
      failCount = 0
    }
  </script>
</body>
</html>
