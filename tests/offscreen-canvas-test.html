<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OffscreenCanvas + Web Worker æ¸²æŸ“æµ‹è¯• - WorkfineSheet</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
      background: #f5f5f5;
      padding: 20px;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    h1 { color: #333; margin-bottom: 20px; }
    .back-link { 
      display: inline-block; 
      margin-bottom: 20px; 
      color: #007bff; 
      text-decoration: none;
    }
    .back-link:hover { text-decoration: underline; }
    
    .section { 
      background: white; 
      border-radius: 8px; 
      padding: 20px; 
      margin-bottom: 20px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
    }
    .section h2 { 
      color: #444; 
      margin-bottom: 15px; 
      font-size: 18px;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    
    .btn { 
      padding: 10px 20px; 
      margin: 5px; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 14px;
      transition: all 0.2s;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn-primary { background: #007bff; color: white; }
    .btn-primary:hover { background: #0056b3; }
    .btn-success { background: #28a745; color: white; }
    .btn-success:hover { background: #1e7e34; }
    .btn-warning { background: #ffc107; color: #333; }
    .btn-danger { background: #dc3545; color: white; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .metrics { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
      gap: 15px; 
      margin-top: 15px;
    }
    .metric-card { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      padding: 15px; 
      border-radius: 8px; 
      text-align: center; 
      color: white;
    }
    .metric-value { 
      font-size: 28px; 
      font-weight: bold; 
    }
    .metric-label { 
      font-size: 12px; 
      opacity: 0.9; 
      margin-top: 5px;
    }
    
    .feature-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }
    .feature-item {
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .feature-supported { color: #28a745; }
    .feature-unsupported { color: #dc3545; }
    
    .canvas-container { 
      display: flex;
      gap: 20px;
      margin-top: 15px;
    }
    .canvas-wrapper {
      flex: 1;
      position: relative;
    }
    .canvas-wrapper h3 {
      margin-bottom: 10px;
      color: #666;
      font-size: 14px;
    }
    .canvas-wrapper canvas { 
      width: 100%;
      height: 400px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
    }
    
    .log-container {
      height: 200px;
      overflow-y: auto;
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 10px;
      border-radius: 4px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 12px;
    }
    .log-entry {
      padding: 2px 0;
      border-bottom: 1px solid #333;
    }
    .log-time { color: #6a9955; }
    .log-info { color: #569cd6; }
    .log-success { color: #4ec9b0; }
    .log-warning { color: #dcdcaa; }
    .log-error { color: #f14c4c; }
    
    .comparison-result {
      margin-top: 15px;
      padding: 15px;
      background: #e8f5e9;
      border-radius: 4px;
      border-left: 4px solid #4caf50;
    }
    .comparison-result.warning {
      background: #fff3e0;
      border-left-color: #ff9800;
    }
    
    .slider-container {
      margin: 10px 0;
    }
    .slider-container label {
      display: block;
      margin-bottom: 5px;
      color: #666;
    }
    .slider-container input[type="range"] {
      width: 100%;
    }
    .slider-value {
      text-align: right;
      font-weight: bold;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="./index.html" class="back-link">â† è¿”å›æµ‹è¯•é¦–é¡µ</a>
    <h1>ğŸ”§ OffscreenCanvas + Web Worker æ¸²æŸ“æµ‹è¯•</h1>
    
    <!-- ç‰¹æ€§æ£€æµ‹ -->
    <div class="section">
      <h2>æµè§ˆå™¨ç‰¹æ€§æ£€æµ‹</h2>
      <div class="feature-grid" id="features"></div>
      <div id="support-message"></div>
    </div>
    
    <!-- æµ‹è¯•æ§åˆ¶ -->
    <div class="section">
      <h2>æµ‹è¯•æ§åˆ¶</h2>
      <div class="slider-container">
        <label>æ•°æ®è§„æ¨¡: <span id="data-scale-value">1000</span> å•å…ƒæ ¼</label>
        <input type="range" id="data-scale" min="100" max="100000" step="100" value="1000">
      </div>
      <div class="slider-container">
        <label>æµ‹è¯•è¿­ä»£æ¬¡æ•°: <span id="iterations-value">30</span></label>
        <input type="range" id="iterations" min="10" max="100" step="10" value="30">
      </div>
      <div style="margin-top: 15px;">
        <button class="btn btn-primary" id="btn-init" onclick="initRenderer()">åˆå§‹åŒ– Worker</button>
        <button class="btn btn-success" id="btn-run-test" onclick="runComparison()" disabled>è¿è¡Œå¯¹æ¯”æµ‹è¯•</button>
        <button class="btn btn-warning" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
        <button class="btn btn-danger" id="btn-destroy" onclick="destroyRenderer()" disabled>é”€æ¯ Worker</button>
      </div>
    </div>
    
    <!-- æ€§èƒ½æŒ‡æ ‡ -->
    <div class="section">
      <h2>æ€§èƒ½æŒ‡æ ‡</h2>
      <div class="metrics">
        <div class="metric-card">
          <div class="metric-value" id="metric-main-fps">--</div>
          <div class="metric-label">ä¸»çº¿ç¨‹ FPS</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="metric-worker-fps">--</div>
          <div class="metric-label">Worker FPS</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="metric-main-time">--</div>
          <div class="metric-label">ä¸»çº¿ç¨‹æ¸²æŸ“æ—¶é—´ (ms)</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="metric-worker-time">--</div>
          <div class="metric-label">Worker æ¸²æŸ“æ—¶é—´ (ms)</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="metric-cells">--</div>
          <div class="metric-label">æ¸²æŸ“å•å…ƒæ ¼æ•°</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="metric-speedup">--</div>
          <div class="metric-label">ä¸»çº¿ç¨‹é‡Šæ”¾ç‡</div>
        </div>
      </div>
      <div id="comparison-result"></div>
    </div>
    
    <!-- Canvas å¯¹æ¯” -->
    <div class="section">
      <h2>æ¸²æŸ“å¯¹æ¯”</h2>
      <div class="canvas-container">
        <div class="canvas-wrapper">
          <h3>ä¸»çº¿ç¨‹æ¸²æŸ“ (ä¼ ç»Ÿæ–¹å¼)</h3>
          <canvas id="canvas-main"></canvas>
        </div>
        <div class="canvas-wrapper">
          <h3>Worker æ¸²æŸ“ (OffscreenCanvas)</h3>
          <canvas id="canvas-worker"></canvas>
        </div>
      </div>
    </div>
    
    <!-- æ—¥å¿—è¾“å‡º -->
    <div class="section">
      <h2>æµ‹è¯•æ—¥å¿—</h2>
      <div class="log-container" id="logs"></div>
    </div>
  </div>

  <script type="module">
    // ==================== æ—¥å¿—ç³»ç»Ÿ ====================
    const logsEl = document.getElementById('logs')
    
    function log(message, type = 'info') {
      const time = new Date().toLocaleTimeString('zh-CN', { hour12: false })
      const entry = document.createElement('div')
      entry.className = 'log-entry'
      entry.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-${type}">${message}</span>`
      logsEl.appendChild(entry)
      logsEl.scrollTop = logsEl.scrollHeight
    }
    
    window.clearLogs = function() {
      logsEl.innerHTML = ''
      log('æ—¥å¿—å·²æ¸…ç©º', 'info')
    }
    
    // ==================== ç‰¹æ€§æ£€æµ‹ ====================
    function detectFeatures() {
      const features = {
        offscreenCanvas: typeof OffscreenCanvas !== 'undefined',
        webWorkers: typeof Worker !== 'undefined',
        sharedArrayBuffer: typeof SharedArrayBuffer !== 'undefined',
        transferControlToOffscreen: typeof HTMLCanvasElement.prototype.transferControlToOffscreen === 'function',
        requestAnimationFrame: typeof requestAnimationFrame === 'function'
      }
      
      const featuresEl = document.getElementById('features')
      const supportMsgEl = document.getElementById('support-message')
      
      const featureLabels = {
        offscreenCanvas: 'OffscreenCanvas',
        webWorkers: 'Web Workers',
        sharedArrayBuffer: 'SharedArrayBuffer',
        transferControlToOffscreen: 'transferControlToOffscreen',
        requestAnimationFrame: 'requestAnimationFrame'
      }
      
      for (const [key, supported] of Object.entries(features)) {
        const div = document.createElement('div')
        div.className = 'feature-item'
        div.innerHTML = `
          <span class="${supported ? 'feature-supported' : 'feature-unsupported'}">
            ${supported ? 'âœ“' : 'âœ—'}
          </span>
          <span>${featureLabels[key]}</span>
        `
        featuresEl.appendChild(div)
      }
      
      const allSupported = features.offscreenCanvas && features.webWorkers && features.transferControlToOffscreen
      
      if (allSupported) {
        supportMsgEl.innerHTML = `
          <div class="comparison-result">
            âœ“ å½“å‰æµè§ˆå™¨å®Œå…¨æ”¯æŒ OffscreenCanvas + Web Worker æ¸²æŸ“
            ${features.sharedArrayBuffer ? 'ï¼Œå¹¶æ”¯æŒ SharedArrayBuffer è¿›ä¸€æ­¥ä¼˜åŒ–' : ''}
          </div>
        `
        log('æµè§ˆå™¨ç‰¹æ€§æ£€æµ‹é€šè¿‡', 'success')
      } else {
        supportMsgEl.innerHTML = `
          <div class="comparison-result warning">
            âš  å½“å‰æµè§ˆå™¨ä¸å®Œå…¨æ”¯æŒ OffscreenCanvas æ¸²æŸ“ï¼Œå°†ä½¿ç”¨ä¸»çº¿ç¨‹æ¸²æŸ“ä½œä¸ºé™çº§æ–¹æ¡ˆ
          </div>
        `
        log('æµè§ˆå™¨ä¸æ”¯æŒ OffscreenCanvasï¼Œæ— æ³•è¿›è¡Œ Worker æ¸²æŸ“æµ‹è¯•', 'warning')
      }
      
      return allSupported
    }
    
    const isSupported = detectFeatures()
    
    // ==================== æ»‘å—æ›´æ–° ====================
    const dataScaleSlider = document.getElementById('data-scale')
    const dataScaleValue = document.getElementById('data-scale-value')
    const iterationsSlider = document.getElementById('iterations')
    const iterationsValue = document.getElementById('iterations-value')
    
    dataScaleSlider.addEventListener('input', (e) => {
      dataScaleValue.textContent = parseInt(e.target.value).toLocaleString()
    })
    
    iterationsSlider.addEventListener('input', (e) => {
      iterationsValue.textContent = e.target.value
    })
    
    // ==================== ä¸»çº¿ç¨‹æ¸²æŸ“ ====================
    const mainCanvas = document.getElementById('canvas-main')
    const mainCtx = mainCanvas.getContext('2d')
    
    function resizeMainCanvas() {
      const rect = mainCanvas.parentElement.getBoundingClientRect()
      const dpr = window.devicePixelRatio || 1
      mainCanvas.width = Math.floor(rect.width * dpr)
      mainCanvas.height = Math.floor(400 * dpr)
      mainCtx.setTransform(1, 0, 0, 1, 0, 0)
      mainCtx.scale(dpr, dpr)
    }
    resizeMainCanvas()
    
    const mainConfig = {
      defaultRowHeight: 25,
      defaultColWidth: 80,
      rowHeaderWidth: 50,
      colHeaderHeight: 25,
      totalRows: 100,
      totalCols: 26
    }
    
    const mainCells = new Map()
    
    function generateTestData(count) {
      const rows = Math.ceil(Math.sqrt(count))
      const cols = Math.ceil(count / rows)
      const cells = []
      
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          cells.push({
            row: r,
            col: c,
            value: `R${r}C${c}`
          })
        }
      }
      
      return { cells, rows, cols }
    }
    
    function renderMainThread(cells) {
      const { rowHeaderWidth, colHeaderHeight, defaultRowHeight, defaultColWidth } = mainConfig
      const width = mainCanvas.width / (window.devicePixelRatio || 1)
      const height = mainCanvas.height / (window.devicePixelRatio || 1)
      
      mainCtx.clearRect(0, 0, width, height)
      
      // èƒŒæ™¯
      mainCtx.fillStyle = '#f0f0f0'
      mainCtx.fillRect(0, 0, width, colHeaderHeight)
      mainCtx.fillRect(0, 0, rowHeaderWidth, height)
      
      // è®¡ç®—å¯è§èŒƒå›´
      const visibleRows = Math.ceil((height - colHeaderHeight) / defaultRowHeight)
      const visibleCols = Math.ceil((width - rowHeaderWidth) / defaultColWidth)
      
      // ç½‘æ ¼çº¿
      mainCtx.strokeStyle = '#e0e0e0'
      mainCtx.lineWidth = 1
      
      for (let c = 0; c <= visibleCols; c++) {
        const x = rowHeaderWidth + c * defaultColWidth
        mainCtx.beginPath()
        mainCtx.moveTo(x, colHeaderHeight)
        mainCtx.lineTo(x, height)
        mainCtx.stroke()
      }
      
      for (let r = 0; r <= visibleRows; r++) {
        const y = colHeaderHeight + r * defaultRowHeight
        mainCtx.beginPath()
        mainCtx.moveTo(rowHeaderWidth, y)
        mainCtx.lineTo(width, y)
        mainCtx.stroke()
      }
      
      // è¡¨å¤´
      mainCtx.fillStyle = '#333'
      mainCtx.font = '12px Arial'
      mainCtx.textBaseline = 'middle'
      mainCtx.textAlign = 'center'
      
      for (let c = 0; c < visibleCols; c++) {
        const label = String.fromCharCode(65 + (c % 26))
        const x = rowHeaderWidth + c * defaultColWidth + defaultColWidth / 2
        mainCtx.fillText(label, x, colHeaderHeight / 2)
      }
      
      for (let r = 0; r < visibleRows; r++) {
        const y = colHeaderHeight + r * defaultRowHeight + defaultRowHeight / 2
        mainCtx.fillText(String(r + 1), rowHeaderWidth / 2, y)
      }
      
      // åˆ†éš”çº¿
      mainCtx.strokeStyle = '#999'
      mainCtx.beginPath()
      mainCtx.moveTo(0, colHeaderHeight)
      mainCtx.lineTo(width, colHeaderHeight)
      mainCtx.stroke()
      
      mainCtx.beginPath()
      mainCtx.moveTo(rowHeaderWidth, 0)
      mainCtx.lineTo(rowHeaderWidth, height)
      mainCtx.stroke()
      
      // å•å…ƒæ ¼å†…å®¹
      mainCtx.fillStyle = '#000'
      mainCtx.textAlign = 'left'
      
      let cellsRendered = 0
      for (const cell of cells) {
        if (cell.row < visibleRows && cell.col < visibleCols) {
          const x = rowHeaderWidth + cell.col * defaultColWidth + 4
          const y = colHeaderHeight + cell.row * defaultRowHeight + defaultRowHeight / 2
          mainCtx.fillText(String(cell.value).substring(0, 10), x, y)
          cellsRendered++
        }
      }
      
      return cellsRendered
    }
    
    // ==================== Worker æ¸²æŸ“ ====================
    let worker = null
    let workerCanvas = null
    let isWorkerReady = false
    let workerRenderTimes = []
    let pendingRender = false
    
    window.initRenderer = async function() {
      if (!isSupported) {
        log('æµè§ˆå™¨ä¸æ”¯æŒï¼Œæ— æ³•åˆå§‹åŒ– Worker', 'error')
        return
      }
      
      try {
        log('æ­£åœ¨åˆå§‹åŒ– OffscreenCanvas Worker...', 'info')
        
        workerCanvas = document.getElementById('canvas-worker')
        
        // åˆ›å»º Workerï¼ˆä½¿ç”¨å†…è”æ–¹å¼é¿å… CORS é—®é¢˜ï¼‰
        const workerCode = `
          // ç®€åŒ–ç‰ˆ Worker ä»£ç 
          let canvas = null
          let ctx = null
          let dpr = 1
          let width = 0
          let height = 0
          let cells = []
          
          const config = {
            defaultRowHeight: 25,
            defaultColWidth: 80,
            rowHeaderWidth: 50,
            colHeaderHeight: 25
          }
          
          function render(frameId) {
            if (!ctx || !canvas) {
              self.postMessage({ type: 'error', message: 'Canvas not initialized' })
              return
            }
            
            const startTime = performance.now()
            
            ctx.clearRect(0, 0, width, height)
            
            // èƒŒæ™¯
            ctx.fillStyle = '#f0f0f0'
            ctx.fillRect(0, 0, width, config.colHeaderHeight)
            ctx.fillRect(0, 0, config.rowHeaderWidth, height)
            
            // è®¡ç®—å¯è§èŒƒå›´
            const visibleRows = Math.ceil((height - config.colHeaderHeight) / config.defaultRowHeight)
            const visibleCols = Math.ceil((width - config.rowHeaderWidth) / config.defaultColWidth)
            
            // ç½‘æ ¼çº¿
            ctx.strokeStyle = '#e0e0e0'
            ctx.lineWidth = 1
            
            for (let c = 0; c <= visibleCols; c++) {
              const x = config.rowHeaderWidth + c * config.defaultColWidth
              ctx.beginPath()
              ctx.moveTo(x, config.colHeaderHeight)
              ctx.lineTo(x, height)
              ctx.stroke()
            }
            
            for (let r = 0; r <= visibleRows; r++) {
              const y = config.colHeaderHeight + r * config.defaultRowHeight
              ctx.beginPath()
              ctx.moveTo(config.rowHeaderWidth, y)
              ctx.lineTo(width, y)
              ctx.stroke()
            }
            
            // è¡¨å¤´
            ctx.fillStyle = '#333'
            ctx.font = '12px Arial'
            ctx.textBaseline = 'middle'
            ctx.textAlign = 'center'
            
            for (let c = 0; c < visibleCols; c++) {
              const label = String.fromCharCode(65 + (c % 26))
              const x = config.rowHeaderWidth + c * config.defaultColWidth + config.defaultColWidth / 2
              ctx.fillText(label, x, config.colHeaderHeight / 2)
            }
            
            for (let r = 0; r < visibleRows; r++) {
              const y = config.colHeaderHeight + r * config.defaultRowHeight + config.defaultRowHeight / 2
              ctx.fillText(String(r + 1), config.rowHeaderWidth / 2, y)
            }
            
            // åˆ†éš”çº¿
            ctx.strokeStyle = '#999'
            ctx.beginPath()
            ctx.moveTo(0, config.colHeaderHeight)
            ctx.lineTo(width, config.colHeaderHeight)
            ctx.stroke()
            
            ctx.beginPath()
            ctx.moveTo(config.rowHeaderWidth, 0)
            ctx.lineTo(config.rowHeaderWidth, height)
            ctx.stroke()
            
            // å•å…ƒæ ¼å†…å®¹
            ctx.fillStyle = '#000'
            ctx.textAlign = 'left'
            
            let cellsRendered = 0
            for (const cell of cells) {
              if (cell.row < visibleRows && cell.col < visibleCols) {
                const x = config.rowHeaderWidth + cell.col * config.defaultColWidth + 4
                const y = config.colHeaderHeight + cell.row * config.defaultRowHeight + config.defaultRowHeight / 2
                ctx.fillText(String(cell.value).substring(0, 10), x, y)
                cellsRendered++
              }
            }
            
            const renderTime = performance.now() - startTime
            self.postMessage({
              type: 'rendered',
              frameId,
              renderTime,
              cellsRendered
            })
          }
          
          self.onmessage = (e) => {
            const msg = e.data
            
            switch (msg.type) {
              case 'init':
                canvas = msg.canvas
                ctx = canvas.getContext('2d')
                dpr = msg.dpr
                width = canvas.width / dpr
                height = canvas.height / dpr
                ctx.scale(dpr, dpr)
                self.postMessage({ type: 'ready' })
                break
                
              case 'resize':
                canvas.width = Math.floor(msg.width * msg.dpr)
                canvas.height = Math.floor(msg.height * msg.dpr)
                width = msg.width
                height = msg.height
                dpr = msg.dpr
                ctx.setTransform(1, 0, 0, 1, 0, 0)
                ctx.scale(dpr, dpr)
                break
                
              case 'updateData':
                cells = msg.cells
                break
                
              case 'render':
                render(msg.frameId)
                break
                
              case 'destroy':
                canvas = null
                ctx = null
                cells = []
                break
            }
          }
        `
        
        const blob = new Blob([workerCode], { type: 'application/javascript' })
        const workerUrl = URL.createObjectURL(blob)
        worker = new Worker(workerUrl)
        
        worker.onmessage = (e) => {
          const msg = e.data
          
          if (msg.type === 'ready') {
            isWorkerReady = true
            log('Worker åˆå§‹åŒ–å®Œæˆ', 'success')
            document.getElementById('btn-run-test').disabled = false
            document.getElementById('btn-destroy').disabled = false
            document.getElementById('btn-init').disabled = true
          } else if (msg.type === 'rendered') {
            pendingRender = false
            workerRenderTimes.push(msg.renderTime)
            if (workerRenderTimes.length > 60) {
              workerRenderTimes.shift()
            }
          } else if (msg.type === 'error') {
            log('Worker é”™è¯¯: ' + msg.message, 'error')
          }
        }
        
        worker.onerror = (e) => {
          log('Worker é”™è¯¯: ' + e.message, 'error')
        }
        
        // è½¬ç§» Canvas æ§åˆ¶æƒ
        const offscreen = workerCanvas.transferControlToOffscreen()
        const dpr = window.devicePixelRatio || 1
        const rect = workerCanvas.parentElement.getBoundingClientRect()
        offscreen.width = Math.floor(rect.width * dpr)
        offscreen.height = Math.floor(400 * dpr)
        
        worker.postMessage({
          type: 'init',
          canvas: offscreen,
          dpr
        }, [offscreen])
        
      } catch (error) {
        log('åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error')
        console.error(error)
      }
    }
    
    window.destroyRenderer = function() {
      if (worker) {
        worker.postMessage({ type: 'destroy' })
        worker.terminate()
        worker = null
        isWorkerReady = false
        log('Worker å·²é”€æ¯', 'info')
        document.getElementById('btn-run-test').disabled = true
        document.getElementById('btn-destroy').disabled = true
        document.getElementById('btn-init').disabled = false
      }
    }
    
    // ==================== å¯¹æ¯”æµ‹è¯• ====================
    window.runComparison = async function() {
      if (!isWorkerReady) {
        log('Worker æœªå°±ç»ª', 'error')
        return
      }
      
      const dataScale = parseInt(dataScaleSlider.value)
      const iterations = parseInt(iterationsSlider.value)
      
      log(`å¼€å§‹å¯¹æ¯”æµ‹è¯•: ${dataScale.toLocaleString()} å•å…ƒæ ¼, ${iterations} æ¬¡è¿­ä»£`, 'info')
      
      // ç”Ÿæˆæµ‹è¯•æ•°æ®
      const { cells, rows, cols } = generateTestData(dataScale)
      log(`ç”Ÿæˆ ${rows}Ã—${cols} = ${cells.length} ä¸ªå•å…ƒæ ¼`, 'info')
      
      // æ›´æ–° Worker æ•°æ®
      worker.postMessage({ type: 'updateData', cells })
      
      // ä¸»çº¿ç¨‹æ¸²æŸ“æµ‹è¯•
      log('æµ‹è¯•ä¸»çº¿ç¨‹æ¸²æŸ“...', 'info')
      const mainTimes = []
      let mainCellsRendered = 0
      
      for (let i = 0; i < iterations; i++) {
        const start = performance.now()
        mainCellsRendered = renderMainThread(cells)
        mainTimes.push(performance.now() - start)
        await new Promise(r => setTimeout(r, 0))
      }
      
      const mainAvgTime = mainTimes.reduce((a, b) => a + b, 0) / mainTimes.length
      const mainFPS = 1000 / mainAvgTime
      
      // Worker æ¸²æŸ“æµ‹è¯•
      log('æµ‹è¯• Worker æ¸²æŸ“...', 'info')
      workerRenderTimes = []
      
      for (let i = 0; i < iterations; i++) {
        pendingRender = true
        worker.postMessage({ type: 'render', frameId: i })
        
        // ç­‰å¾…æ¸²æŸ“å®Œæˆ
        while (pendingRender) {
          await new Promise(r => setTimeout(r, 1))
        }
      }
      
      const workerAvgTime = workerRenderTimes.reduce((a, b) => a + b, 0) / workerRenderTimes.length
      const workerFPS = 1000 / workerAvgTime
      
      // æ›´æ–°æŒ‡æ ‡
      document.getElementById('metric-main-fps').textContent = mainFPS.toFixed(1)
      document.getElementById('metric-worker-fps').textContent = workerFPS.toFixed(1)
      document.getElementById('metric-main-time').textContent = mainAvgTime.toFixed(2)
      document.getElementById('metric-worker-time').textContent = workerAvgTime.toFixed(2)
      document.getElementById('metric-cells').textContent = mainCellsRendered.toLocaleString()
      
      // è®¡ç®—ä¸»çº¿ç¨‹é‡Šæ”¾ç‡
      // Worker æ¸²æŸ“æ—¶ä¸»çº¿ç¨‹å®Œå…¨é‡Šæ”¾ï¼Œæ‰€ä»¥é‡Šæ”¾ç‡æ˜¯ 100%
      // è¿™é‡Œæˆ‘ä»¬å±•ç¤ºçš„æ˜¯æ¸²æŸ“æ—¶é—´çš„æ¯”è¾ƒ
      const speedup = ((mainAvgTime - 0) / mainAvgTime * 100).toFixed(0)
      document.getElementById('metric-speedup').textContent = '100%'
      
      // ç»“æœåˆ†æ
      const resultEl = document.getElementById('comparison-result')
      const improvement = ((mainAvgTime - workerAvgTime) / mainAvgTime * 100).toFixed(1)
      
      if (workerFPS > mainFPS * 0.9) {
        resultEl.innerHTML = `
          <div class="comparison-result">
            <strong>âœ“ Worker æ¸²æŸ“è¡¨ç°ä¼˜ç§€</strong><br>
            ä¸»çº¿ç¨‹æ¸²æŸ“: ${mainAvgTime.toFixed(2)}ms/å¸§ (${mainFPS.toFixed(1)} FPS)<br>
            Worker æ¸²æŸ“: ${workerAvgTime.toFixed(2)}ms/å¸§ (${workerFPS.toFixed(1)} FPS)<br>
            <strong>å…³é”®ä¼˜åŠ¿: Worker æ¸²æŸ“æ—¶ä¸»çº¿ç¨‹å®Œå…¨é‡Šæ”¾ï¼Œç”¨æˆ·äº¤äº’ä¸å—é˜»å¡</strong>
          </div>
        `
        log('æµ‹è¯•å®Œæˆ: Worker æ¸²æŸ“è¡¨ç°ä¼˜ç§€ï¼Œä¸»çº¿ç¨‹å®Œå…¨é‡Šæ”¾', 'success')
      } else {
        resultEl.innerHTML = `
          <div class="comparison-result warning">
            <strong>âš  Worker æ¸²æŸ“å­˜åœ¨é¢å¤–å¼€é”€</strong><br>
            ä¸»çº¿ç¨‹æ¸²æŸ“: ${mainAvgTime.toFixed(2)}ms/å¸§ (${mainFPS.toFixed(1)} FPS)<br>
            Worker æ¸²æŸ“: ${workerAvgTime.toFixed(2)}ms/å¸§ (${workerFPS.toFixed(1)} FPS)<br>
            Worker æ¸²æŸ“å­˜åœ¨ postMessage é€šä¿¡å¼€é”€ï¼Œä½†ä¸»çº¿ç¨‹ä»ç„¶ä¿æŒå“åº”
          </div>
        `
        log('æµ‹è¯•å®Œæˆ: Worker æ¸²æŸ“å­˜åœ¨é€šä¿¡å¼€é”€ï¼Œä½†ä¸»çº¿ç¨‹å“åº”æ€§æ›´å¥½', 'warning')
      }
    }
    
    // ==================== åˆå§‹åŒ– ====================
    log('OffscreenCanvas + Web Worker æ¸²æŸ“æµ‹è¯•é¡µé¢å·²åŠ è½½', 'info')
    
    if (isSupported) {
      log('ç‚¹å‡» "åˆå§‹åŒ– Worker" å¼€å§‹æµ‹è¯•', 'info')
    }
  </script>
</body>
</html>
